<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Continuity Orchestrator ‚Äî Admin</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-card: #141414;
            --bg-hover: #1f1f1f;
            --bg-input: #1a1a1a;
            --border: #2a2a2a;
            --border-focus: #4ade80;
            --text: #e8e8e8;
            --text-dim: #777;
            --accent: #4ade80;
            --accent-dim: rgba(74, 222, 128, 0.15);
            --accent-glow: rgba(74, 222, 128, 0.15);
            --warning: #facc15;
            --danger: #ef4444;
            --info: #3b82f6;
            --gradient-1: linear-gradient(135deg, #1a1a2e 0%, #0a0a0a 100%);
            --gradient-accent: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color-scheme: dark;
        }

        [data-theme="light"] {
            --bg: #f5f5f5;
            --bg-card: #ffffff;
            --bg-hover: #eaeaea;
            --bg-input: #f0f0f0;
            --border: #d4d4d4;
            --border-focus: #16a34a;
            --text: #1a1a1a;
            --text-dim: #666;
            --accent: #16a34a;
            --accent-dim: rgba(22, 163, 74, 0.12);
            --accent-glow: rgba(22, 163, 74, 0.1);
            --warning: #ca8a04;
            --danger: #dc2626;
            --info: #2563eb;
            --gradient-1: linear-gradient(135deg, #e8f5e9 0%, #f5f5f5 100%);
            --gradient-accent: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color-scheme: light;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            background-image:
                radial-gradient(at 50% 0%, rgba(74, 222, 128, 0.08) 0%, transparent 50%),
                radial-gradient(at 100% 0%, rgba(59, 130, 246, 0.05) 0%, transparent 30%);
            color: var(--text);
            min-height: 100vh;
        }

        /* Smooth fade-in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4);
            }

            50% {
                box-shadow: 0 0 20px 5px rgba(74, 222, 128, 0.2);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        /* Tabs */
        .tabs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border-bottom: none;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* Refresh progress bar */
        .refresh-bar {
            position: sticky;
            top: 50px;
            /* height of .tabs */
            z-index: 99;
            height: 2px;
            background: var(--border);
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .refresh-bar.active {
            opacity: 1;
        }

        .refresh-bar .refresh-bar-inner {
            height: 100%;
            width: 40%;
            background: linear-gradient(90deg, transparent, var(--accent), var(--info), var(--accent), transparent);
            border-radius: 2px;
            animation: refresh-sweep 1.2s ease-in-out infinite;
        }

        @keyframes refresh-sweep {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(350%);
            }
        }

        .tabs-group {
            display: flex;
            gap: 0.5rem;
            flex: 1;
            justify-content: center;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        /* Theme toggle */
        .theme-toggle {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-dim);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        /* GitHub shortcut menu */
        .gh-menu {
            position: relative;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 0.3rem 0.65rem;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-dim);
            transition: all 0.2s;
            display: none;
            align-items: center;
            gap: 0.3rem;
            user-select: none;
        }

        .gh-menu.visible {
            display: flex;
        }

        .gh-menu:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .gh-menu .gh-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            padding-top: 6px;
        }

        .gh-menu .gh-dropdown>div {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.35rem;
            min-width: 180px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .gh-menu:hover .gh-dropdown {
            display: block;
        }

        .gh-dropdown a {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.65rem;
            border-radius: 7px;
            font-size: 0.82rem;
            color: var(--text-dim);
            text-decoration: none;
            transition: all 0.15s;
        }

        .gh-dropdown a:hover {
            background: var(--bg-input);
            color: var(--text);
        }

        /* Google Translate widget styling */
        /* ‚îÄ‚îÄ Hide ALL Google Translate UI ‚îÄ‚îÄ */
        #google_translate_element,
        .goog-te-banner-frame,
        .skiptranslate,
        .goog-te-gadget-icon {
            display: none !important;
        }

        body {
            top: 0 !important;
            position: static !important;
        }

        /* ‚îÄ‚îÄ Custom language selector ‚îÄ‚îÄ */
        .lang-btn {
            position: relative;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 0.3rem 0.65rem;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-dim);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            user-select: none;
        }

        .lang-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .lang-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.35rem;
            min-width: 160px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 200;
            max-height: 320px;
            overflow-y: auto;
        }

        .lang-dropdown.open {
            display: block;
        }

        .lang-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.65rem;
            border-radius: 7px;
            cursor: pointer;
            font-size: 0.82rem;
            color: var(--text-dim);
            transition: all 0.15s;
        }

        .lang-option:hover {
            background: var(--bg-hover);
            color: var(--text);
        }

        .lang-option.active {
            background: var(--accent-dim, rgba(74, 222, 128, 0.12));
            color: var(--accent);
            font-weight: 600;
        }

        .tab {
            padding: 0.6rem 1.25rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover {
            background: var(--bg-hover);
            color: var(--text);
        }

        .tab.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        .tab-content {
            display: none;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #fff 0%, #4ade80 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            color: var(--text-dim);
            font-size: 0.95rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            animation: fadeIn 0.4s ease-out;
            transition: all 0.25s ease;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
            border-color: rgba(74, 222, 128, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        .card h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card h2 .icon {
            font-size: 1.25rem;
        }

        /* Status indicators */
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .status-row:last-child {
            border-bottom: none;
        }

        .status-label {
            color: var(--text-dim);
        }

        .status-value {
            font-weight: 500;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge.ok {
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent);
        }

        .badge.warning {
            background: rgba(250, 204, 21, 0.2);
            color: var(--warning);
        }

        .badge.critical {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .badge.unknown {
            background: rgba(136, 136, 136, 0.2);
            color: var(--text-dim);
        }

        /* Lists */
        .adapter-item,
        .tool-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--border);
        }

        .adapter-item:last-child,
        .tool-item:last-child {
            border-bottom: none;
        }

        .adapter-name,
        .tool-name {
            flex: 1;
        }

        .adapter-status {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .adapter-status.ready {
            color: var(--accent);
        }

        .adapter-status.missing {
            color: var(--danger);
        }

        .adapter-status.mock {
            color: var(--warning);
        }

        /* Buttons */
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.65rem 1.25rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-card);
            color: var(--text);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.primary {
            background: var(--gradient-accent);
            color: #000;
            border-color: transparent;
            box-shadow: 0 4px 16px rgba(74, 222, 128, 0.25);
        }

        .btn.primary:hover {
            box-shadow: 0 6px 24px rgba(74, 222, 128, 0.35);
            transform: translateY(-2px);
        }

        .btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.25);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .form-input::placeholder {
            color: var(--text-dim);
        }

        .form-hint {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
        }

        .form-hint a {
            color: var(--info);
        }

        /* Secret rows */
        .secret-config-row {
            display: grid;
            grid-template-columns: 200px 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .secret-config-row:last-child {
            border-bottom: none;
        }

        .secret-config-name {
            font-family: monospace;
            font-size: 0.85rem;
        }

        .secret-config-value {
            position: relative;
        }

        .secret-config-value input {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: monospace;
            font-size: 0.85rem;
        }

        .secret-config-value input:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .secret-config-status {
            width: 80px;
            text-align: center;
            font-size: 0.85rem;
        }

        .secret-config-status.set {
            color: var(--accent);
        }

        .secret-config-status.unset {
            color: var(--danger);
        }

        /* Terminal output */
        .terminal {
            background: #000;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: var(--accent);
        }

        .terminal.error {
            color: var(--danger);
        }

        /* Countdown */
        .countdown {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            padding: 1rem;
            font-variant-numeric: tabular-nums;
        }

        .countdown.warning {
            color: var(--warning);
        }

        .countdown.danger {
            color: var(--danger);
        }

        /* Alert box */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .alert.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--info);
        }

        .alert.warning {
            background: rgba(250, 204, 21, 0.1);
            border: 1px solid rgba(250, 204, 21, 0.3);
            color: var(--warning);
        }

        .alert.success {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            color: var(--accent);
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
        }

        .loading::after {
            content: '';
            animation: dots 1s steps(3) infinite;
        }

        @keyframes dots {
            0% {
                content: '.';
            }

            33% {
                content: '..';
            }

            66% {
                content: '...';
            }
        }

        /* Section divider */
        .section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-dim);
            margin: 1.5rem 0 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        /* Wizard styles */
        .wizard-steps {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .wizard-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-hover);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .wizard-step.active {
            background: var(--accent);
            color: #000;
        }

        .wizard-step.completed {
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent);
        }

        .wizard-step.completed:hover {
            background: rgba(74, 222, 128, 0.35);
            transform: translateY(-1px);
        }

        .wizard-step.optional {
            background: rgba(59, 130, 246, 0.15);
            color: var(--info);
            border: 1px dashed rgba(59, 130, 246, 0.4);
        }

        .wizard-step.optional:hover {
            background: rgba(59, 130, 246, 0.25);
            transform: translateY(-1px);
        }

        .wizard-step.skippable {
            background: rgba(74, 222, 128, 0.1);
            color: var(--accent);
            border: 1px dashed rgba(74, 222, 128, 0.4);
        }

        .wizard-step.skippable:hover {
            background: rgba(74, 222, 128, 0.2);
            transform: translateY(-1px);
        }

        .wizard-step-num {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            font-weight: 600;
        }

        .wizard-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .wizard-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-dim);
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <!-- Tab Navigation -->
    <nav class="tabs">
        <div style="width: 120px; flex-shrink: 0;"></div>
        <div class="tabs-group">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('wizard')">üßô Setup</button>
            <button class="tab" onclick="switchTab('secrets')">üîê Secrets</button>
            <button class="tab" onclick="switchTab('commands')">‚ö° Commands</button>
            <button class="tab" onclick="switchTab('integrations')">üîå Integrations</button>
            <button class="tab" onclick="switchTab('debugging')">üêõ Debugging</button>
        </div>
        <div class="nav-controls">
            <div id="google_translate_element"></div>
            <div class="lang-btn" id="lang-btn" onclick="toggleLangDropdown()">
                <span id="lang-flag">üåê</span>
                <span id="lang-label">EN</span>
                <span style="font-size:0.6rem;">‚ñæ</span>
                <div class="lang-dropdown" id="lang-dropdown"></div>
            </div>
            <div class="gh-menu" id="gh-menu">
                <span>üîó</span>
                <span style="font-size:0.6rem;">‚ñæ</span>
                <div class="gh-dropdown">
                    <div>
                        <a id="gh-link-repo" href="#" target="_blank">üì¶ Repository</a>
                        <a id="gh-link-pages" href="#" target="_blank">üåê Pages</a>
                        <a id="gh-link-actions" href="#" target="_blank">‚ö° Actions</a>
                    </div>
                </div>
            </div>
            <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                üåô
            </button>
        </div>
    </nav>
    <div class="refresh-bar" id="refresh-bar">
        <div class="refresh-bar-inner"></div>
    </div>

    <!-- Dashboard Tab -->
    <div id="tab-dashboard" class="tab-content active">
        <header class="header">
            <h1>‚ö° Continuity Orchestrator</h1>
            <p class="subtitle">Local Admin Console</p>
        </header>

        <div class="grid" id="dashboard">
            <div class="loading">Loading status</div>
        </div>
    </div>

    <!-- Secrets Tab -->
    <div id="tab-secrets" class="tab-content">
        <header class="header">
            <h1>üîê Secrets Manager</h1>
            <p class="subtitle">Configure and push secrets to GitHub</p>
        </header>

        <div class="grid">
            <div class="card full-width">
                <div id="gh-status-alert"></div>

                <div id="secrets-form">
                    <div class="loading">Loading secrets</div>
                </div>

                <div id="secrets-output" style="margin-top: 1rem; display: none;">
                    <pre class="terminal" id="secrets-terminal"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Commands Tab -->
    <div id="tab-commands" class="tab-content">
        <header class="header">
            <h1>‚ö° Command Center</h1>
            <p class="subtitle">Run orchestrator commands</p>
        </header>

        <div class="grid">
            <div class="card">
                <h2><span class="icon">‚ñ∂Ô∏è</span> Engine</h2>
                <div class="actions" style="flex-direction: column;">
                    <button class="btn" onclick="runCmd('tick-dry')" style="width: 100%;">
                        üß™ Dry Run (preview only)
                    </button>
                    <button class="btn primary" onclick="runCmdWithSync('tick', 'engine-git-sync')"
                        style="width: 100%;">
                        ‚ñ∂Ô∏è Run Tick
                    </button>
                    <label
                        style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--text-dim); cursor: pointer; margin-top: 0.25rem;">
                        <input type="checkbox" id="engine-git-sync" checked style="accent-color: var(--accent);">
                        üîÑ Git sync after tick
                    </label>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üìä</span> Status</h2>
                <div class="actions" style="flex-direction: column;">
                    <button class="btn" onclick="runCmd('status')" style="width: 100%;">
                        üìä Current Status
                    </button>
                    <button class="btn" onclick="runCmd('health')" style="width: 100%;">
                        üíì Health Check
                    </button>
                    <button class="btn" onclick="runCmd('config-status')" style="width: 100%;">
                        ‚öôÔ∏è Config Status
                    </button>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üîÆ</span> Preview</h2>
                <div class="actions" style="flex-direction: column;">
                    <button class="btn" onclick="runCmd('explain')" style="width: 100%;">
                        üìñ Explain Stages
                    </button>
                    <button class="btn" onclick="runCmd('simulate')" style="width: 100%;">
                        üîÆ Simulate Timeline
                    </button>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üèóÔ∏è</span> Build</h2>
                <div class="actions" style="flex-direction: column;">
                    <button class="btn" onclick="runCmd('check-config')" style="width: 100%;">
                        üîç Check Adapters Config
                    </button>
                    <button class="btn" onclick="runCmdWithSync('build-site', 'build-git-sync')" style="width: 100%;">
                        üèóÔ∏è Build Static Site
                    </button>
                    <label
                        style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--text-dim); cursor: pointer; margin-top: 0.25rem;">
                        <input type="checkbox" id="build-git-sync" checked style="accent-color: var(--accent);">
                        üîÑ Git sync after build
                    </label>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üß™</span> Test</h2>
                <div class="actions" style="flex-direction: column;">
                    <button class="btn" onclick="runCmd('test email')" style="width: 100%;">
                        üìß Test Email
                    </button>
                    <button class="btn" onclick="runCmd('test sms')" style="width: 100%;">
                        üì± Test SMS
                    </button>
                    <button class="btn" onclick="runCmd('test-all')" style="width: 100%;">
                        üß™ Test All Adapters
                    </button>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üîÑ</span> Recovery</h2>
                <div class="actions" style="flex-direction: column;">
                    <button class="btn" onclick="runCmd('retry-queue')" style="width: 100%;">
                        üìã View Retry Queue
                    </button>
                    <button class="btn" onclick="runCmd('circuit-breakers')" style="width: 100%;">
                        ‚ö° Circuit Breakers
                    </button>
                    <button class="btn" onclick="runCmd('circuit-breakers --reset')" style="width: 100%;">
                        üîÑ Reset All Breakers
                    </button>
                </div>
            </div>

            <div class="card full-width">
                <h2><span class="icon">üìü</span> Terminal Output</h2>
                <pre class="terminal" id="cmd-terminal">Ready. Click a command above to run.</pre>
            </div>
        </div>
    </div>

    <!-- Debugging Tab -->
    <div id="tab-debugging" class="tab-content">
        <header class="header">
            <h1>üêõ Debugging</h1>
            <p class="subtitle">Deadline overrides, archival tools, and testing utilities
            </p>
        </header>

        <div class="grid">
            <div class="card">
                <h2><span class="icon">‚è∞</span> Deadline Management</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <label class="form-label" style="margin-bottom: 0.5rem; display: block;">Renew Deadline</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <button class="btn" onclick="renewDeadline(24)">+24h</button>
                            <button class="btn primary" onclick="renewDeadline(48)">+48h</button>
                            <button class="btn" onclick="renewDeadline(72)">+72h</button>
                            <span style="color: var(--text-dim); margin: 0 0.25rem;">or</span>
                            <input type="number" id="renew-custom-hours" placeholder="hours" min="1" max="720"
                                style="width: 80px; padding: 0.4rem 0.6rem; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; color: var(--text);" />
                            <button class="btn"
                                onclick="renewDeadline(document.getElementById('renew-custom-hours').value)">Renew</button>
                        </div>
                    </div>
                    <div class="divider" style="border-top: 1px solid var(--border);"></div>
                    <div>
                        <label class="form-label" style="margin-bottom: 0.5rem; display: block;">Set Manual Deadline
                            <span style="color: var(--text-dim); font-size: 0.8rem;">(testing)</span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <input type="datetime-local" id="manual-deadline"
                                style="padding: 0.4rem 0.6rem; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; color: var(--text); color-scheme: dark;" />
                            <button class="btn" onclick="setManualDeadline()">Set Deadline</button>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                            <button class="btn" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;"
                                onclick="setTestDeadline(3)">‚ö° 3 min</button>
                            <button class="btn" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;"
                                onclick="setTestDeadline(10)">‚ö° 10 min</button>
                            <button class="btn" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;"
                                onclick="setTestDeadline(30)">‚ö° 30 min</button>
                            <button class="btn" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;"
                                onclick="setTestDeadline(60)">‚ö° 1 hour</button>
                        </div>
                    </div>
                    <div id="deadline-status" style="font-size: 0.85rem;"></div>
                    <div class="divider" style="border-top: 1px solid var(--border);"></div>
                    <label
                        style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--text-dim); cursor: pointer;">
                        <input type="checkbox" id="deadline-git-sync" checked style="accent-color: var(--accent);">
                        üîÑ Git sync after deadline change
                    </label>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üì¶</span> Archive</h2>
                <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.75rem;">
                    Save a permanent snapshot to <a href="https://archive.org" target="_blank"
                        style="color: var(--info);">archive.org</a>
                </p>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <input type="text" class="form-input" id="archive-url"
                        placeholder="Custom URL (or leave empty for GitHub Pages)">
                </div>
                <div class="actions" style="flex-direction: column;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn primary" onclick="archiveNow(true)" style="flex: 1;"
                            title="Archives all pages ‚Äî may take several minutes">
                            üì¶ Archive All Pages
                        </button>
                        <button class="btn" onclick="archiveNow(false)" style="flex-shrink: 0;"
                            title="Archive only the index page">
                            üìÑ Index Only
                        </button>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="checkArchive(true)" style="flex: 1;"
                            title="Check all pages on archive.org">
                            üîç Check All Pages
                        </button>
                        <button class="btn" onclick="checkArchive(false)" style="flex-shrink: 0;"
                            title="Check index only">
                            üîç Index
                        </button>
                    </div>
                </div>
                <div id="archive-status" style="margin-top: 0.75rem; font-size: 0.85rem;"></div>
            </div>

            <div class="card">
                <h2><span class="icon">üîß</span> State Controls</h2>
                <div class="actions" style="flex-direction: column;">
                    <button class="btn" onclick="resetState()" style="width: 100%;">
                        üîÑ Reset Timer (keep secrets, reset to OK + 48h)
                    </button>
                    <button class="btn danger" onclick="factoryReset()" style="width: 100%;">
                        üóëÔ∏è Factory Reset (fresh state + clear audit)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Integrations Tab -->
    <div id="tab-integrations" class="tab-content">
        <header class="header">
            <h1>üîå Integrations</h1>
            <p class="subtitle">Test and manage your configured adapters</p>
        </header>

        <div class="grid">
            <div class="card">
                <h2><span class="icon">üìß</span> Email (Resend)</h2>
                <div id="integration-email" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div class="loading">Checking...</div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üì±</span> SMS (Twilio)</h2>
                <div id="integration-sms" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div class="loading">Checking...</div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üê¶</span> X / Twitter</h2>
                <div id="integration-x" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div class="loading">Checking...</div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">ü§ñ</span> Reddit</h2>
                <div id="integration-reddit" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div class="loading">Checking...</div>
                </div>
            </div>

            <div class="card full-width">
                <h2><span class="icon">üìü</span> Test Output</h2>
                <pre class="terminal" id="integration-terminal">Select an integration to test.</pre>
            </div>
        </div>
    </div>

    <!-- Setup Wizard Tab -->
    <div id="tab-wizard" class="tab-content">
        <header class="header">
            <h1>üßô Setup Wizard</h1>
            <p class="subtitle">Step-by-step configuration guide</p>
        </header>

        <div class="wizard-steps" id="wizard-steps"></div>

        <div class="wizard-content">
            <div class="card">
                <div id="wizard-body"></div>
                <div class="wizard-nav">
                    <button class="btn" id="wizard-prev" onclick="wizardPrev()">‚Üê Back</button>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" id="wizard-finish" onclick="wizardFinish()" style="display: none;">‚úÖ
                            Finish</button>
                        <button class="btn primary" id="wizard-next" onclick="wizardNext()">Next ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>üîí Local server only ‚Äî never expose to internet</p>
    </footer>

    <script>
        // Global state
        let appData = null;
        let envData = {};  // Values from .env file
        let ghAuthenticated = false;
        // ========================================
        // THEME TOGGLE
        // ========================================
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = !html.hasAttribute('data-theme') || html.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            if (newTheme === 'dark') {
                html.removeAttribute('data-theme');
            } else {
                html.setAttribute('data-theme', newTheme);
            }
            localStorage.setItem('co-theme', newTheme);
            document.getElementById('theme-toggle').textContent = newTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
        }

        // ========================================
        // GITHUB SHORTCUT MENU
        // ========================================
        function updateGhMenu() {
            const repo = envData.GITHUB_REPOSITORY;
            const menu = document.getElementById('gh-menu');
            if (!repo || !menu) return;

            const [owner, name] = repo.split('/');
            if (!owner || !name) return;

            document.getElementById('gh-link-repo').href = `https://github.com/${repo}`;
            document.getElementById('gh-link-pages').href = `https://${owner}.github.io/${name}/`;
            document.getElementById('gh-link-actions').href = `https://github.com/${repo}/actions`;
            menu.classList.add('visible');
        }
        // Restore theme on load
        (function initTheme() {
            const saved = localStorage.getItem('co-theme');
            if (saved === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                const btn = document.getElementById('theme-toggle');
                if (btn) btn.textContent = '‚òÄÔ∏è';
            }
        })();

        // ========================================
        // LANGUAGE SELECTOR (drives Google Translate)
        // ========================================
        const LANGUAGES = [
            { code: '', flag: 'üá¨üáß', label: 'English' },
            { code: 'fr', flag: 'üá´üá∑', label: 'Fran√ßais' },
            { code: 'es', flag: 'üá™üá∏', label: 'Espa√±ol' },
            { code: 'de', flag: 'üá©üá™', label: 'Deutsch' },
            { code: 'pt', flag: 'üáßüá∑', label: 'Portugu√™s' },
            { code: 'it', flag: 'üáÆüáπ', label: 'Italiano' },
            { code: 'ru', flag: 'üá∑üá∫', label: '–†—É—Å—Å–∫–∏–π' },
            { code: 'ja', flag: 'üáØüáµ', label: 'Êó•Êú¨Ë™û' },
            { code: 'ko', flag: 'üá∞üá∑', label: 'ÌïúÍµ≠Ïñ¥' },
            { code: 'zh-CN', flag: 'üá®üá≥', label: '‰∏≠Êñá' },
            { code: 'ar', flag: 'üá∏üá¶', label: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' },
            { code: 'hi', flag: 'üáÆüá≥', label: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä' },
        ];

        // Build dropdown
        (function initLangDropdown() {
            const dd = document.getElementById('lang-dropdown');
            if (!dd) return;
            dd.innerHTML = LANGUAGES.map(l =>
                `<div class="lang-option${l.code === '' ? ' active' : ''}" data-lang="${l.code}" onclick="selectLang('${l.code}', '${l.flag}', '${l.label}')">
                    <span>${l.flag}</span> ${l.label}
                </div>`
            ).join('');
        })();

        function toggleLangDropdown() {
            document.getElementById('lang-dropdown').classList.toggle('open');
        }

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            const btn = document.getElementById('lang-btn');
            if (btn && !btn.contains(e.target)) {
                document.getElementById('lang-dropdown').classList.remove('open');
            }
        });

        function selectLang(code, flag, label) {
            // Update UI
            document.getElementById('lang-flag').textContent = flag;
            document.getElementById('lang-label').textContent = label.split(' ')[0].slice(0, 3).toUpperCase() || 'EN';
            document.querySelectorAll('.lang-option').forEach(el => el.classList.remove('active'));
            document.querySelector(`.lang-option[data-lang="${code}"]`)?.classList.add('active');
            document.getElementById('lang-dropdown').classList.remove('open');

            // Drive Google Translate
            triggerGoogleTranslate(code);
        }

        function triggerGoogleTranslate(langCode) {
            // Find Google Translate's hidden <select> and change it
            const gtSelect = document.querySelector('.goog-te-combo');
            if (gtSelect) {
                gtSelect.value = langCode;
                gtSelect.dispatchEvent(new Event('change'));
                return;
            }
            // Fallback: set cookie and reload
            if (langCode === '') {
                // Reset to English
                document.cookie = 'googtrans=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC';
                document.cookie = 'googtrans=; path=/; domain=' + window.location.hostname + '; expires=Thu, 01 Jan 1970 00:00:00 UTC';
            } else {
                document.cookie = `googtrans=/en/${langCode}; path=/`;
            }
            window.location.reload();
        }

        // Google Translate init (hidden widget, we just need its engine)
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'fr,es,de,pt,zh-CN,ja,ko,ar,hi,ru,it',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false,
            }, 'google_translate_element');
        }

        // Tab switching
        function switchTab(tabId, subStep) {
            // Parse compound tab IDs like 'wizard/email'
            if (tabId.includes('/')) {
                const parts = tabId.split('/');
                tabId = parts[0];
                subStep = parts[1];
            }

            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            const tabBtn = document.querySelector(`[onclick="switchTab('${tabId}')"]`);
            if (tabBtn) tabBtn.classList.add('active');
            const tabEl = document.getElementById(`tab-${tabId}`);
            if (tabEl) tabEl.classList.add('active');

            // Update URL hash
            const hash = subStep ? `${tabId}/${subStep}` : tabId;
            history.replaceState(null, '', `#${hash}`);

            // Load data for the tab
            if (tabId === 'secrets') {
                if (!secretsLoaded) loadSecretsForm();
            } else if (tabId === 'wizard') {
                // Navigate to specific wizard step if provided
                if (subStep) {
                    const stepIdx = wizardSteps.findIndex(s => s.id === subStep);
                    if (stepIdx !== -1) currentWizardStep = stepIdx;
                }
                renderWizard();
            } else if (tabId === 'integrations') {
                loadIntegrations();
            } else if (tabId === 'dashboard') {
                loadStatus();
            }
        }

        // Track which tab is active so we can warn about wizard
        let activeTab = 'dashboard';

        // Wrap switchTab to warn when leaving wizard with unsaved data
        const _origSwitchTab = switchTab;
        switchTab = function (tabId, subStep) {
            const targetTab = tabId.includes('/') ? tabId.split('/')[0] : tabId;
            if (activeTab === 'wizard' && targetTab !== 'wizard' && wizardDirty) {
                if (!confirm('You have unsaved wizard progress. Leave anyway?')) return;
                wizardDirty = false;  // user confirmed ‚Äî reset
            }
            if (activeTab === 'secrets' && targetTab !== 'secrets' && secretsDirty) {
                if (!confirm('You have unsaved secret changes. Leave anyway?')) return;
                // Immediately restore fields to their saved values (no reload needed)
                document.querySelectorAll('#secrets-form [data-secret-name]').forEach(el => {
                    el.value = secretsInitialValues[el.dataset.secretName] ?? '';
                });
                secretsDirty = false;
            }
            activeTab = targetTab;
            _origSwitchTab(tabId, subStep);
        };

        // Warn before page unload if wizard has unsaved data
        window.addEventListener('beforeunload', (e) => {
            if (wizardDirty || secretsDirty) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        function goToWizardStep(stepId) {
            switchTab('wizard', stepId);
        }

        // Load status
        async function loadStatus() {
            const bar = document.getElementById('refresh-bar');
            bar?.classList.add('active');
            try {
                // Load both status and env values
                const [statusRes, envRes] = await Promise.all([
                    fetch('/api/status'),
                    fetch('/api/env/read'),
                ]);
                appData = await statusRes.json();
                const envResult = await envRes.json();
                envData = envResult.values || {};
                updateGhMenu();
                renderDashboard(appData);
            } catch (error) {
                document.getElementById('dashboard').innerHTML = `
                    <div class="card">
                        <p class="terminal error">Error loading status: ${error.message}</p>
                    </div>
                `;
            } finally {
                // Brief delay so the bar is visible even on fast responses
                setTimeout(() => bar?.classList.remove('active'), 300);
            }
        }

        function renderDashboard(data) {
            const dashboard = document.getElementById('dashboard');

            const stageClass = {
                'OK': 'ok', 'WARNING': 'warning', 'CRITICAL': 'critical', 'FINAL': 'critical'
            }[data.state.stage] || 'unknown';

            // Format deadline info
            let countdownHtml = '';
            let deadlineInfoHtml = '';
            if (data.state.time_to_deadline_minutes !== null) {
                const ttd = data.state.time_to_deadline_minutes;
                if (ttd > 0) {
                    const hours = Math.floor(ttd / 60);
                    const mins = ttd % 60;
                    const countdownClass = ttd < 60 ? 'danger' : ttd < 360 ? 'warning' : '';
                    countdownHtml = `<div class="countdown ${countdownClass}">${hours}h ${mins}m</div>`;
                } else {
                    countdownHtml = `<div class="countdown danger">‚ö†Ô∏è PASSED</div>`;
                }
            } else if (data.state.stage === 'UNKNOWN') {
                countdownHtml = `<div class="alert info" style="margin-bottom: 1rem;">
                    üí° <strong>Not initialized</strong> ‚Äî Run a tick or renew to start the deadline.
                </div>`;
            }
            if (data.state.deadline) {
                const dl = new Date(data.state.deadline);
                deadlineInfoHtml = `
                    <div class="status-row">
                        <span class="status-label">Deadline</span>
                        <span class="status-value" style="font-size: 0.85rem;">
                            ${dl.toLocaleDateString()} ${dl.toLocaleTimeString()}
                        </span>
                    </div>`;
            }

            const ghTool = data.tools.find(t => t.name === 'gh');
            ghAuthenticated = ghTool?.installed && ghTool?.authenticated;

            // Build tools HTML with install button for gh
            const toolsHtml = data.tools.map(t => {
                let actionHtml = '';
                if (t.name === 'gh' && !t.installed) {
                    actionHtml = `<button class="btn" onclick="installGh()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Install</button>`;
                } else if (t.name === 'gh' && t.installed && !t.authenticated) {
                    actionHtml = `<span style="color: var(--warning);">run: gh auth login</span>`;
                }
                return `
                    <div class="tool-item">
                        <span>${t.installed ? '‚úÖ' : '‚ùå'}</span>
                        <span class="tool-name">${t.name}</span>
                        <span style="color: var(--text-dim);">
                            ${t.installed ? (t.authenticated !== null ? (t.authenticated ? 'auth ‚úì' : actionHtml) : 'ok') : actionHtml || '‚Äî'}
                        </span>
                    </div>
                `;
            }).join('');

            dashboard.innerHTML = `
                <div class="card">
                    <h2><span class="icon">üìä</span> System State</h2>
                    ${countdownHtml}
                    <div class="status-row">
                        <span class="status-label">Stage</span>
                        <span class="badge ${stageClass}">${data.state.stage}</span>
                    </div>
                    ${data.state.release_triggered ? `
                    <div style="background: rgba(245, 158, 11, 0.15); border: 1px solid var(--warning); border-radius: 8px; padding: 0.6rem 0.8rem; margin: 0.5rem 0;">
                        <div style="font-weight: 700; color: var(--warning); font-size: 0.85rem;">üëª SHADOW MODE ‚Äî DELAYED</div>
                        <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.25rem;">
                            Delay: ${data.state.release_delay_minutes}m
                            ${data.state.release_execute_after ? ` ‚Ä¢ Executes: ${new Date(data.state.release_execute_after).toLocaleString()}` : ''}
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-dim); margin-top: 0.25rem;">Cancel by renewing before the execute time.</div>
                    </div>
                    ` : ''}
                    <div class="status-row">
                        <span class="status-label">Project</span>
                        <span class="status-value">${data.config.project_name || '‚Äî'}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Mode</span>
                        <span class="status-value">${data.config.mock_mode ? 'üß™ Mock' : 'üî¥ Live'}</span>
                    </div>
                    ${deadlineInfoHtml}
                    <div class="status-row">
                        <span class="status-label">Renewals</span>
                        <span class="status-value">${data.state.renewal_count}</span>
                    </div>
                    
                    ${data.state.stage === 'UNKNOWN' ? `
                        <div class="actions">
                            <button class="btn" onclick="loadStatus()">üîÑ Refresh</button>
                            <button class="btn primary" onclick="switchTab('wizard')">üßô Start Setup ‚Üí</button>
                        </div>
                    ` : data.state.release_triggered || data.state.stage === 'FULL' || data.state.stage === 'PARTIAL' || data.state.stage === 'PRE_RELEASE' ? `
                        <div style="border-top: 1px solid var(--border); margin-top: 1rem; padding-top: 1rem;">
                            <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 0.5rem; color: var(--danger);">
                                ${data.state.release_triggered
                        ? 'üëª Shadow mode is active ‚Äî disclosure is pending'
                        : `‚ö†Ô∏è Disclosure is <strong>${data.state.stage}</strong> ‚Äî system is active`}
                            </div>
                            <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.75rem;">
                                ${data.state.release_triggered
                        ? 'Cancel shadow mode by returning to OK. This clears the pending release and restores the countdown.'
                        : 'Returning to OK will reset escalation, cancel any pending release, and restore the countdown.'}
                            </p>
                            <div class="actions" style="gap: 0.5rem;">
                                <button class="btn primary" onclick="returnToOK()" style="flex: 1;">
                                    üîô Return to OK
                                </button>
                                <button class="btn" onclick="loadStatus()" style="padding: 0 0.6rem;" title="Refresh status">üîÑ</button>
                            </div>
                        </div>
                    ` : data.state.stage === 'OK' || data.state.stage === 'WARNING' || data.state.stage === 'REMIND_1' || data.state.stage === 'REMIND_2' ? `
                        <div style="padding-top: 1rem;">
                            <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 0.75rem; color: var(--text-dim);">‚ö° Manual Trigger</div>
                            <div class="actions" style="flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem; align-items: stretch;">
                                    <button class="btn danger" onclick="triggerRelease()" style="flex: 1;"
                                        title="Immediately sets state to FULL and executes all disclosure actions on the next tick. This is irreversible without a manual Return to OK.">
                                        üíÄ Trigger FULL Disclosure
                                    </button>
                                    <button class="btn" onclick="loadStatus()" style="padding: 0 0.6rem;" title="Refresh status">üîÑ</button>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: stretch;">
                                    <button class="btn" onclick="triggerShadow()" style="flex: 1; border-color: var(--warning); color: var(--warning);"
                                        title="Stealth trigger with delay ‚Äî same as entering RELEASE_SECRET on the public site. Cancelable by renewal during the delay window.">
                                        üëª Shadow Mode
                                    </button>
                                    <select id="shadow-delay" style="background: var(--surface); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 0 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                        <option value="0">No delay</option>
                                        <option value="30">30 min delay</option>
                                        <option value="60" selected>1 hour delay</option>
                                        <option value="120">2 hour delay</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="actions" style="margin-top: 0.75rem;">
                            <button class="btn" onclick="loadStatus()">üîÑ Refresh</button>
                        </div>
                    `}
                    <div id="trigger-status" style="margin-top: 0.75rem; font-size: 0.85rem;"></div>
                </div>
                
                <div class="card">
                    <h2><span class="icon">üîå</span> Adapters</h2>
                    ${data.adapters.map(a => `
                        <div class="adapter-item">
                            <span>${a.configured ? '‚úÖ' : '‚ùå'}</span>
                            <span class="adapter-name">${a.name}</span>
                            <span class="adapter-status ${a.configured ? (a.mode === 'real' ? 'ready' : 'mock') : 'missing'}">
                                ${a.configured ? a.mode : a.missing.slice(0, 2).join(', ')}
                            </span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="card">
                    <h2><span class="icon">üõ†Ô∏è</span> Tools</h2>
                    ${toolsHtml}
                    <div style="padding-top: 0.75rem;">
                        <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 0.5rem;">üì¶ Git</div>
                        <div id="git-status-content" style="color: var(--text-dim); font-size: 0.85rem;">Loading...</div>
                    </div>
                </div>
                
                <div class="card">
                    <h2><span class="icon">üîê</span> Secrets</h2>
                    <div class="status-row">
                        <span class="status-label">Set</span>
                        <span class="status-value">${data.secrets.filter(s => s.set).length} / ${data.secrets.length}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Required Missing</span>
                        <span class="status-value" style="color: var(--danger);">
                            ${data.secrets.filter(s => s.required_for.length > 0 && !s.set).length}
                        </span>
                    </div>
                    <div class="actions">
                        <button class="btn" onclick="switchTab('secrets')">Configure Secrets ‚Üí</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2><span class="icon">üíö</span> Health</h2>
                    <div class="status-row">
                        <span class="status-label">State file</span>
                        <span>${data.health.state_file_exists ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Policy</span>
                        <span>${data.health.policy_valid ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Updated</span>
                        <span style="color: var(--text-dim); font-size: 0.85rem;">
                            ${new Date(data.timestamp).toLocaleTimeString()}
                        </span>
                    </div>
                </div>
                

                <div class="card">
                    <h2><span class="icon">‚ö°</span> Quick Actions</h2>
                    <div class="actions" style="flex-direction: column; gap: 1rem;">
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button class="btn primary" onclick="switchTab('commands')">Open Command Center ‚Üí</button>
                            <button class="btn primary" onclick="runCommand('tick-dry')">üß™ Dry Run</button>
                        </div>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button class="btn" onclick="switchTab('debugging')">üêõ Debugging & Deadline ‚Üí</button>
                        </div>
                    </div>
                </div>
            `;

            // Load git status into the Tools card
            loadGitStatus();
        }
        // Secrets form
        let ghSecrets = [];  // List of secrets set in GitHub
        let ghVariables = [];  // List of variables set in GitHub
        let currentTarget = 'both';  // Current save target

        function selectTarget(target) {
            currentTarget = target;
            // Update button states
            document.querySelectorAll('.target-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.target === target);
            });
            // Update save button label
            const btn = document.getElementById('save-secrets-btn');
            if (btn) {
                const labels = { both: 'üíæ Save & Push', local: 'üìÅ Save', github: '‚òÅÔ∏è Push' };
                btn.textContent = labels[target];
            }
        }

        // Three-tier classification of .env values based on actual GitHub workflow usage
        // Tier 1: Actual GitHub secrets (consumed via secrets.* in workflows, or via CONTINUITY_CONFIG)
        const GITHUB_SECRETS = [
            'CONTINUITY_CONFIG',  // Master JSON ‚Äî overrides individual secrets
            'RESEND_API_KEY', 'RESEND_FROM_EMAIL',
            'TWILIO_ACCOUNT_SID', 'TWILIO_AUTH_TOKEN', 'TWILIO_FROM_NUMBER',
            'X_API_KEY', 'X_API_SECRET', 'X_ACCESS_TOKEN', 'X_ACCESS_SECRET',
            'REDDIT_CLIENT_ID', 'REDDIT_CLIENT_SECRET', 'REDDIT_USERNAME', 'REDDIT_PASSWORD',
            'PERSISTENCE_API_URL', 'PERSISTENCE_API_KEY',
            'RENEWAL_SECRET', 'RELEASE_SECRET', 'RENEWAL_TRIGGER_TOKEN',
            'OPERATOR_EMAIL', 'OPERATOR_SMS', 'PROJECT_NAME',
        ];
        // Tier 2: GitHub repository variables (consumed via vars.* in workflows ‚Äî NOT secrets)
        const GITHUB_VARS = ['ADAPTER_MOCK_MODE', 'ARCHIVE_ENABLED', 'ARCHIVE_URL'];
        // Tier 3: Local-only config (.env only, never referenced in workflows)
        const LOCAL_ONLY = ['DEPLOY_MODE', 'WEBHOOK_TIMEOUT'];
        // Auto-provided by GitHub Actions runtime ‚Äî can't be set/deleted via API
        const AUTO_PROVIDED = ['GITHUB_TOKEN', 'GITHUB_REPOSITORY'];
        // Combined known secrets (for sync/clear operations)
        const KNOWN_SECRETS = [...GITHUB_SECRETS, ...GITHUB_VARS, ...LOCAL_ONLY, ...AUTO_PROVIDED];
        // Env var names that feed the master config JSON (mirrors buildMasterConfigJson)
        const MASTER_CONFIG_ENVVARS = [
            'PROJECT_NAME', 'OPERATOR_EMAIL', 'OPERATOR_SMS',
            'RESEND_API_KEY', 'RESEND_FROM_EMAIL',
            'TWILIO_ACCOUNT_SID', 'TWILIO_AUTH_TOKEN', 'TWILIO_FROM_NUMBER',
            'X_API_KEY', 'X_API_SECRET', 'X_ACCESS_TOKEN', 'X_ACCESS_SECRET',
            'REDDIT_CLIENT_ID', 'REDDIT_CLIENT_SECRET', 'REDDIT_USERNAME', 'REDDIT_PASSWORD',
            // NOT GITHUB_TOKEN/GITHUB_REPOSITORY ‚Äî auto-provided by GitHub Actions at runtime
            'PERSISTENCE_API_URL', 'PERSISTENCE_API_KEY',
            'RENEWAL_SECRET', 'RELEASE_SECRET', 'RENEWAL_TRIGGER_TOKEN',
        ];

        function getSecretTier(name) {
            if (AUTO_PROVIDED.includes(name)) return 'auto';
            if (GITHUB_SECRETS.includes(name)) return 'secret';
            if (GITHUB_VARS.includes(name)) return 'var';
            return 'local';
        }

        async function loadSecretsForm() {
            if (!appData) {
                const response = await fetch('/api/status');
                appData = await response.json();
            }

            // Re-fetch env data so we always have the latest .env values
            const envRes = await fetch('/api/env/read');
            const envResult = await envRes.json();
            envData = envResult.values || {};

            // Fetch GitHub secrets + variables list
            const ghSecretsRes = await fetch('/api/gh/secrets');
            const ghSecretsData = await ghSecretsRes.json();
            ghSecrets = ghSecretsData.secrets || [];
            ghVariables = ghSecretsData.variables || [];

            const ghTool = appData.tools.find(t => t.name === 'gh');
            const gitTool = appData.tools.find(t => t.name === 'git');
            const ghAlert = document.getElementById('gh-status-alert');

            if (!ghTool?.installed) {
                ghAlert.innerHTML = `
                    <div class="alert warning" style="display: flex; align-items: center; justify-content: space-between;">
                        <span>‚ö†Ô∏è <strong>gh CLI not installed</strong></span>
                        <span style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="installGh()" style="padding: 0.25rem 0.75rem;">Install gh CLI</button>
                            <button class="btn" onclick="refreshSecrets()" style="padding: 0.25rem 0.5rem;" title="Refresh">üîÑ</button>
                        </span>
                    </div>
                `;
            } else if (!ghTool?.authenticated) {
                ghAlert.innerHTML = `
                    <div class="alert warning" style="display: flex; align-items: center; justify-content: space-between;">
                        <span>‚ö†Ô∏è <strong>gh CLI not authenticated</strong> ‚Äî Run <code>gh auth login</code> in terminal.</span>
                        <button class="btn" onclick="refreshSecrets()" style="padding: 0.25rem 0.5rem;" title="Refresh">üîÑ</button>
                    </div>
                `;
            } else {
                ghAlert.innerHTML = `
                    <div class="alert success" style="display: flex; align-items: center; justify-content: space-between;">
                        <span>‚úÖ <strong>gh CLI ready</strong> ‚Äî ${ghSecrets.length} secrets in repo.</span>
                        <button class="btn" onclick="refreshSecrets()" style="padding: 0.25rem 0.5rem;" title="Refresh">üîÑ</button>
                    </div>
                `;
            }

            // Group secrets by category
            const categories = {
                'Project': ['PROJECT_NAME', 'OPERATOR_EMAIL', 'OPERATOR_SMS'],
                'Security': ['RENEWAL_SECRET', 'RELEASE_SECRET', 'RENEWAL_TRIGGER_TOKEN'],
                'Email (Resend)': ['RESEND_API_KEY', 'RESEND_FROM_EMAIL'],
                'SMS (Twilio)': ['TWILIO_ACCOUNT_SID', 'TWILIO_AUTH_TOKEN', 'TWILIO_FROM_NUMBER'],
                'GitHub': ['GITHUB_TOKEN', 'GITHUB_REPOSITORY'],
                'X (Twitter)': ['X_API_KEY', 'X_API_SECRET', 'X_ACCESS_TOKEN', 'X_ACCESS_SECRET'],
                'Reddit': ['REDDIT_CLIENT_ID', 'REDDIT_CLIENT_SECRET', 'REDDIT_USERNAME', 'REDDIT_PASSWORD'],
                'Operational': ['ADAPTER_MOCK_MODE', 'ARCHIVE_ENABLED', 'ARCHIVE_URL'],
            };

            let html = '';

            // Map categories to wizard steps for shortcut links
            const categoryWizardMap = {
                'Email (Resend)': 'email',
                'SMS (Twilio)': 'sms',
                'X (Twitter)': 'twitter',
                'Reddit': 'reddit',
                'Security': 'security',
            };

            for (const [category, names] of Object.entries(categories)) {
                const secrets = names.map(name => appData.secrets.find(s => s.name === name)).filter(Boolean);
                if (secrets.length === 0) continue;

                const wizLink = categoryWizardMap[category]
                    ? ` <a href="#wizard/${categoryWizardMap[category]}" onclick="goToWizardStep('${categoryWizardMap[category]}'); return false;" style="font-size: 0.75rem; color: var(--info); font-weight: normal; margin-left: 0.5rem;" title="Open guided setup in Wizard">üßô Wizard ‚Üí</a>`
                    : '';
                html += `<div class="section-title">${category}${wizLink}</div>`;
                for (const secret of secrets) {
                    const isRequired = secret.required_for.length > 0;
                    const localSet = envData[secret.name] && envData[secret.name].length > 0;
                    const ghSet = ghSecrets.includes(secret.name);
                    const currentValue = envData[secret.name] || '';

                    // Boolean secrets use select dropdown
                    const booleanSecrets = ['ADAPTER_MOCK_MODE', 'ARCHIVE_ENABLED'];

                    // Non-sensitive secrets can show as plain text
                    const nonSensitive = ['GITHUB_REPOSITORY', 'OPERATOR_EMAIL', 'RESEND_FROM_EMAIL',
                        'TWILIO_FROM_NUMBER', 'OPERATOR_SMS', 'PROJECT_NAME',
                        'REDDIT_USERNAME', 'TWILIO_ACCOUNT_SID', 'REDDIT_CLIENT_ID',
                        'ARCHIVE_URL', 'WEBHOOK_TIMEOUT', 'DEPLOY_MODE',
                        'PERSISTENCE_API_URL'];

                    // Add action buttons for certain secrets
                    let actionBtn = '';
                    if (secret.name === 'GITHUB_TOKEN' || secret.name === 'GITHUB_REPOSITORY') {
                        actionBtn = `<button type="button" class="btn" onclick="fillSecretFromGh('${secret.name}')" style="padding:0.25rem 0.5rem;font-size:0.75rem;" title="Get from gh CLI">üîç</button>`;
                    }

                    // Determine input type
                    let inputHtml = '';
                    if (booleanSecrets.includes(secret.name)) {
                        const isTrue = currentValue === 'true' || currentValue === '1' || (!localSet);
                        inputHtml = `
                            <select id="secret-${secret.name}" data-secret-name="${secret.name}" class="form-input" style="padding: 0.5rem;">
                                <option value="true" ${isTrue ? 'selected' : ''}>‚úÖ On (safe testing)</option>
                                <option value="false" ${!isTrue ? 'selected' : ''}>‚ö†Ô∏è Off (live operations)</option>
                            </select>`;
                    } else {
                        const inputType = nonSensitive.includes(secret.name) ? 'text' : 'password';
                        const existingValue = nonSensitive.includes(secret.name) && localSet ? currentValue : '';
                        inputHtml = `
                            <input type="${inputType}" 
                                   id="secret-${secret.name}" 
                                   placeholder="${localSet && inputType === 'password' ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'Enter value...'}"
                                   value="${existingValue}"
                                   data-secret-name="${secret.name}">`;
                    }

                    const tier = getSecretTier(secret.name);
                    // Delete from GitHub ‚Äî for secrets or variables that are set
                    const canDeleteSecret = tier === 'secret' && ghSet;
                    const canDeleteVar = tier === 'var' && ghVariables.includes(secret.name);
                    const canDeleteGh = canDeleteSecret || canDeleteVar;
                    const deleteKind = tier === 'var' ? 'variable' : 'secret';

                    // Tier-based GitHub column
                    let ghColumn;
                    switch (tier) {
                        case 'auto':
                            ghColumn = `<div title="Automatically provided by GitHub Actions at runtime" style="color: var(--text-dim);">üîÑ Auto</div>`;
                            break;
                        case 'secret':
                            ghColumn = `<div title="GitHub Secret (used by Actions)">${ghSet ? '‚úÖ' : '‚ùå'} GitHub</div>`;
                            break;
                        case 'var':
                            const varSet = ghVariables.includes(secret.name);
                            ghColumn = `<div title="GitHub repo variable (vars.*). Pushed via gh variable set.">${varSet ? '‚úÖ' : '‚ùå'} Var</div>`;
                            break;
                        default:
                            ghColumn = `<div title="Local only ‚Äî not used in GitHub workflows" style="color: var(--text-dim);">üìÅ Local only</div>`;
                    }

                    html += `
                        <div class="secret-config-row" style="display: grid; grid-template-columns: 1fr 1.5fr auto 110px 110px; gap: 0.5rem; align-items: center;">
                            <div class="secret-config-name">
                                ${secret.name}
                                ${isRequired ? '<span style="color: var(--danger);">*</span>' : ''}
                            </div>
                            <div class="secret-config-value">
                                ${inputHtml}
                            </div>
                            <div>${actionBtn}</div>
                            <div class="secret-config-status" style="text-align: center; font-size: 0.8rem; display: flex; align-items: center; gap: 0.25rem; justify-content: center;">
                                <div title="Local (.env)">${localSet ? '‚úÖ' : '‚ùå'} Local</div>
                                ${localSet ? `<button class="btn" onclick="markForDeletion('${secret.name}')" style="padding:0.15rem 0.35rem;font-size:0.7rem;" title="Mark ${secret.name} for deletion from local .env (applied on Save)">üóëÔ∏è</button>` : ''}
                            </div>
                            <div class="secret-config-status" style="text-align: center; font-size: 0.8rem; display: flex; align-items: center; gap: 0.25rem; justify-content: center;">
                                ${ghColumn}
                                ${canDeleteGh ? `<button class="btn" onclick="removeSecret('${secret.name}','github','${deleteKind}')" style="padding:0.15rem 0.35rem;font-size:0.7rem;" title="Remove ${secret.name} from GitHub">üóëÔ∏è</button>` : ''}
                            </div>
                        </div>
                    `;
                }
            }

            // CONTINUITY_CONFIG master secret panel ‚Äî always shown
            const ghMasterSet = ghSecrets.includes('CONTINUITY_CONFIG');

            // Compute pending sync counts for Save & Push badge
            let pendingSecrets = 0;
            let pendingVars = 0;
            for (const name of GITHUB_SECRETS) {
                if (AUTO_PROVIDED.includes(name) || name === 'CONTINUITY_CONFIG') continue;
                const localVal = envData[name];
                if (localVal && !ghSecrets.includes(name)) pendingSecrets++;
            }
            for (const name of GITHUB_VARS) {
                const localVal = envData[name];
                if (localVal && !ghVariables.includes(name)) pendingVars++;
            }
            const totalPending = pendingSecrets + pendingVars;

            // Master config: count how many adapter credentials have values
            const masterConfig = buildMasterConfigJson();
            const masterKeyCount = Object.keys(masterConfig).length;

            html += `
                <div id="master-secret-panel" style="margin-top: 1.5rem; padding: 1rem; border: 2px solid ${ghMasterSet ? 'var(--warning)' : 'var(--border)'}; border-radius: 8px; background: ${ghMasterSet ? 'rgba(255,193,7,0.08)' : 'transparent'};">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                        <strong style="font-size: 1rem;">üîë Master Secret: <code>CONTINUITY_CONFIG</code></strong>
                        <span style="font-size: 0.75rem; padding: 0.1rem 0.5rem; border-radius: 4px; background: ${ghMasterSet ? 'var(--warning)' : 'var(--bg-input)'}; color: ${ghMasterSet ? '#000' : 'var(--text-dim)'};">
                            ${ghMasterSet ? '‚úÖ SET ON GITHUB' : 'NOT SET'}
                        </span>
                        <span id="master-status-badge" style="font-size: 0.75rem; padding: 0.1rem 0.5rem; border-radius: 4px; display: none; background: var(--danger); color: #fff;"></span>
                        ${!ghMasterSet ? '<span style="font-size: 0.75rem; color: var(--text-dim); font-style: italic;">(optional ‚Äî individual secrets work fine without it)</span>' : ''}
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.75rem;">
                        ${ghMasterSet
                    ? `<strong style="color: var(--warning);">‚ö†Ô∏è Active ‚Äî complete override, not a merge.</strong>
                               Only secrets present in your local <code>.env</code> are included.
                               If a secret is missing locally, it will be <strong>absent from CI</strong> ‚Äî even if it was pushed individually before.<br>
                               Does not include GitHub Variables (${GITHUB_VARS.join(', ')}).<br>
                               <em>After modifying secrets above, re-generate and push to keep the master in sync.</em>`
                    : `Bundles your local <code>.env</code> secrets into a single GitHub secret.<br>
                               <strong>‚ö†Ô∏è Complete override</strong> ‚Äî only secrets present locally are included. Missing secrets = absent from CI.<br>
                               <strong>Not required</strong> ‚Äî you can push secrets individually instead.
                               <em>Useful if you prefer one secret over many.</em>`
                }
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center; font-size: 0.85rem; flex-wrap: wrap;">
                        <button class="btn" id="master-preview-btn" onclick="generateMasterSecret()" style="padding:0.3rem 0.75rem;font-size:0.8rem;" ${masterKeyCount === 0 ? 'disabled title="No credentials configured yet"' : `title="Preview the ${masterKeyCount} credentials that would be bundled into CONTINUITY_CONFIG"`}>üìã Preview JSON (<span id="master-key-count">${masterKeyCount} keys</span>)</button>
                        <button class="btn primary" id="master-push-btn" onclick="pushMasterSecret()" style="padding:0.3rem 0.75rem;font-size:0.8rem;" ${masterKeyCount === 0 ? 'disabled title="No credentials to push"' : `title="Push ${masterKeyCount} credentials as CONTINUITY_CONFIG to GitHub (does not save to local .env)"`}>‚òÅÔ∏è Push to GitHub</button>
                        ${ghMasterSet ? `<button class="btn" id="master-remove-btn" onclick="removeSecret('CONTINUITY_CONFIG','github')" style="padding:0.3rem 0.75rem;font-size:0.8rem;" title="Remove CONTINUITY_CONFIG from GitHub">üóëÔ∏è Remove from GitHub</button>` : ''}
                    </div>
                </div>
            `;

            html += `
                <!-- Save Section -->
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <label style="color: var(--text-dim);">Save to:</label>
                        <div style="display: flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                            <button type="button" class="target-btn active" data-target="both" onclick="selectTarget('both')">Both</button>
                            <button type="button" class="target-btn" data-target="local" onclick="selectTarget('local')">Local Only</button>
                            <button type="button" class="target-btn" data-target="github" onclick="selectTarget('github')">GitHub Only</button>
                        </div>
                        <button class="btn primary" id="save-secrets-btn" onclick="pushSecrets(currentTarget)" disabled>üíæ Save & Push</button>
                        <span id="sync-pending-badge" style="font-size: 0.8rem; color: var(--warning); ${totalPending > 0 ? '' : 'display:none;'}"></span>
                    </div>
                    <div style="margin-top: 0.75rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.85rem;">
                            <input type="checkbox" id="secrets-git-sync" ${gitTool?.installed ? 'checked' : 'disabled'}>
                            <span style="color: var(--text-dim);">üîÑ Git sync after save (commit & push all changes)</span>
                            ${!gitTool?.installed ? '<span style="color: var(--warning); font-size: 0.8rem;">‚ö†Ô∏è git not found</span>' : ''}
                        </label>
                    </div>
                </div>

                <!-- Manage Section -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-dim); margin-bottom: 0.75rem;">üõ†Ô∏è Manage</div>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <button class="btn" onclick="syncEnvToGithub()" title="Force re-push all .env values to GitHub (secrets + variables)">‚òÅÔ∏è Sync .env ‚Üí GitHub</button>
                        <button class="btn" onclick="clearSecretsPrompt('local')" title="Clear all local .env secret values" style="color: var(--warning);">üóëÔ∏è Clear Local Secrets</button>
                        <button class="btn" onclick="clearSecretsPrompt('github')" title="Remove all GitHub secrets" style="color: var(--danger);">üóëÔ∏è Clear GitHub Secrets</button>
                    </div>
                </div>
                <style>
                    .target-btn { padding: 0.5rem 1rem; border: none; background: var(--bg-input); color: var(--text-dim); cursor: pointer; transition: all 0.2s; }
                    .target-btn:hover { background: var(--bg-card); }
                    .target-btn.active { background: var(--accent); color: white; }
                </style>
            `;

            document.getElementById('secrets-form').innerHTML = html;

            // Snapshot initial values for dirty tracking
            secretsInitialValues = {};
            document.querySelectorAll('#secrets-form [data-secret-name]').forEach(el => {
                secretsInitialValues[el.dataset.secretName] = el.value;
            });
            secretsDirty = false;
            secretsLoaded = true;

            // Listen for changes ‚Äî also un-marks deletion when user types
            document.getElementById('secrets-form').addEventListener('input', (e) => {
                if (e.target.dataset && e.target.dataset.secretName && e.target.dataset.markedDelete) {
                    // User started typing in a field marked for deletion ‚Üí un-mark it
                    unmarkDeletion(e.target.dataset.secretName);
                }
                checkSecretsDirty();
            });
            document.getElementById('secrets-form').addEventListener('change', (e) => {
                if (e.target.dataset && e.target.dataset.secretName && e.target.dataset.markedDelete) {
                    unmarkDeletion(e.target.dataset.secretName);
                }
                checkSecretsDirty();
            });

            // Run initial state evaluation (enable/disable Save button, set badges)
            checkSecretsDirty();
        }

        let secretsInitialValues = {};
        let secretsDirty = false;
        let secretsLoaded = false;

        function checkSecretsDirty() {
            const fields = document.querySelectorAll('#secrets-form [data-secret-name]');
            let changed = 0;
            let changedNames = [];
            let masterChanged = 0;
            let deletionCount = 0;
            fields.forEach(el => {
                const name = el.dataset.secretName;
                const isMarkedDelete = el.dataset.markedDelete === 'true';
                if (isMarkedDelete) {
                    changed++;
                    deletionCount++;
                    changedNames.push(name);
                    if (MASTER_CONFIG_ENVVARS.includes(name)) masterChanged++;
                } else if (el.value !== (secretsInitialValues[name] ?? '')) {
                    changed++;
                    changedNames.push(name);
                    if (MASTER_CONFIG_ENVVARS.includes(name)) masterChanged++;
                }
            });
            secretsDirty = changed > 0;

            // --- Save & Push button: enable/disable ---
            const saveBtn = document.getElementById('save-secrets-btn');

            // Count unsynced secrets (local .env ‚Üí GitHub)
            let unsyncedSecrets = 0;
            let unsyncedVars = 0;
            for (const name of GITHUB_SECRETS) {
                if (AUTO_PROVIDED.includes(name) || name === 'CONTINUITY_CONFIG') continue;
                if (envData[name] && !ghSecrets.includes(name)) unsyncedSecrets++;
            }
            for (const name of GITHUB_VARS) {
                if (envData[name] && !ghVariables.includes(name)) unsyncedVars++;
            }
            // Count form changes that are NEW pushable items (not already counted as unsynced)
            let newFormChanges = 0;
            for (const name of changedNames) {
                const tier = getSecretTier(name);
                if (tier === 'auto') continue;
                const alreadyCounted = (tier === 'secret' && !ghSecrets.includes(name) && envData[name])
                    || (tier === 'var' && !ghVariables.includes(name) && envData[name]);
                if (!alreadyCounted) newFormChanges++;
            }

            const totalActionable = unsyncedSecrets + unsyncedVars + newFormChanges;
            const hasAnythingToDo = changed > 0 || totalActionable > 0;

            if (saveBtn) {
                saveBtn.disabled = !hasAnythingToDo;
                if (saveBtn.disabled) {
                    saveBtn.title = 'No changes to save and all values are synced to GitHub';
                } else {
                    saveBtn.title = '';
                }
            }

            // --- Pending badge: precise message ---
            const badge = document.getElementById('sync-pending-badge');
            if (badge) {
                const parts = [];
                if (unsyncedSecrets > 0) parts.push(`${unsyncedSecrets} secret(s) local only ‚Äî not yet on GitHub`);
                if (unsyncedVars > 0) parts.push(`${unsyncedVars} variable(s) local only ‚Äî not yet on GitHub`);
                if (deletionCount > 0) parts.push(`${deletionCount} marked for deletion`);
                if (changed > 0 && deletionCount < changed) {
                    const modified = changed - deletionCount;
                    if (modified > 0) parts.push(`${modified} value(s) modified`);
                }

                if (parts.length > 0) {
                    badge.textContent = '‚ö†Ô∏è ' + parts.join(' ¬∑ ');
                    badge.title = parts.join('\n');
                    badge.style.display = '';
                } else {
                    badge.style.display = 'none';
                }
            }

            // --- Master secret: outdated detection + key count ---
            const masterStatusBadge = document.getElementById('master-status-badge');
            const masterBadge = document.getElementById('master-key-count');
            const ghMasterIsSet = ghSecrets.includes('CONTINUITY_CONFIG');

            if (masterBadge) {
                // Merge live form values on top of envData for key count
                const liveEnv = { ...envData };
                fields.forEach(el => {
                    if (el.value) liveEnv[el.dataset.secretName] = el.value;
                });
                const oldEnvData = envData;
                envData = liveEnv;
                const config = buildMasterConfigJson();
                envData = oldEnvData;
                const count = Object.keys(config).length;
                masterBadge.textContent = `${count} keys`;
            }

            if (masterStatusBadge) {
                if (ghMasterIsSet && masterChanged > 0) {
                    masterStatusBadge.textContent = `‚ö†Ô∏è OUTDATED ‚Äî ${masterChanged} secret(s) changed since last push`;
                    masterStatusBadge.style.display = '';
                } else {
                    masterStatusBadge.style.display = 'none';
                }
            }
        }

        function markForDeletion(name) {
            const input = document.querySelector(`[data-secret-name="${name}"]`);
            if (!input) return;
            input.dataset.markedDelete = 'true';
            input.value = '';
            input.disabled = true;
            input.placeholder = 'üóëÔ∏è Will be deleted on Save';
            input.style.borderColor = 'var(--danger)';
            input.style.opacity = '0.5';

            const row = input.closest('.secret-config-row');
            if (row) {
                // Strikethrough the name
                const nameEl = row.querySelector('.secret-config-name');
                if (nameEl) nameEl.style.textDecoration = 'line-through';
                // Replace the local delete button with an undo button
                const localStatus = row.querySelectorAll('.secret-config-status')[0];
                if (localStatus) {
                    localStatus.innerHTML = `
                        <div title="Marked for deletion" style="color: var(--danger);">üóëÔ∏è Delete</div>
                        <button class="btn" onclick="unmarkDeletion('${name}')" style="padding:0.15rem 0.35rem;font-size:0.7rem;" title="Undo: keep ${name} in local .env">‚Ü©Ô∏è</button>
                    `;
                }
            }
            checkSecretsDirty();
        }

        function unmarkDeletion(name) {
            const input = document.querySelector(`[data-secret-name="${name}"]`);
            if (!input) return;
            delete input.dataset.markedDelete;
            input.disabled = false;
            input.style.borderColor = '';
            input.style.opacity = '';
            // Restore original placeholder and value
            const localSet = envData[name] && envData[name].length > 0;
            const nonSensitive = ['GITHUB_REPOSITORY', 'OPERATOR_EMAIL', 'RESEND_FROM_EMAIL',
                'TWILIO_FROM_NUMBER', 'OPERATOR_SMS', 'PROJECT_NAME',
                'REDDIT_USERNAME', 'TWILIO_ACCOUNT_SID', 'REDDIT_CLIENT_ID',
                'ARCHIVE_URL', 'WEBHOOK_TIMEOUT', 'DEPLOY_MODE',
                'PERSISTENCE_API_URL'];
            const isSensitive = !nonSensitive.includes(name);
            input.placeholder = localSet && isSensitive ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'Enter value...';
            if (!isSensitive && localSet) input.value = envData[name];

            const row = input.closest('.secret-config-row');
            if (row) {
                const nameEl = row.querySelector('.secret-config-name');
                if (nameEl) nameEl.style.textDecoration = '';
                // Restore local status with delete button
                const localStatus = row.querySelectorAll('.secret-config-status')[0];
                if (localStatus) {
                    localStatus.innerHTML = `
                        <div title="Local (.env)">${localSet ? '‚úÖ' : '‚ùå'} Local</div>
                        ${localSet ? `<button class="btn" onclick="markForDeletion('${name}')" style="padding:0.15rem 0.35rem;font-size:0.7rem;" title="Mark ${name} for deletion from local .env (applied on Save)">üóëÔ∏è</button>` : ''}
                    `;
                }
            }
            checkSecretsDirty();
        }

        function refreshSecrets() {
            if (secretsDirty) {
                if (!confirm('You have unsaved secret changes. Refresh anyway?')) return;
            }
            // Show loading state (same as initial page load)
            document.getElementById('secrets-form').innerHTML = '<div class="loading">Loading secrets</div>';
            secretsLoaded = false;
            // Force fresh data fetch
            appData = null;
            loadSecretsForm();
        }

        function buildMasterConfigJson() {
            // Build the master config JSON from current .env values
            // Mirrors the fields in loader.py's _parse_master_config
            const fields = {
                // Project / operator info (needed by tick but not passed individually in workflow)
                project_name: envData['PROJECT_NAME'] || '',
                operator_email: envData['OPERATOR_EMAIL'] || '',
                operator_sms: envData['OPERATOR_SMS'] || '',
                // Email (Resend)
                resend_api_key: envData['RESEND_API_KEY'] || '',
                resend_from_email: envData['RESEND_FROM_EMAIL'] || '',
                // SMS (Twilio)
                twilio_account_sid: envData['TWILIO_ACCOUNT_SID'] || '',
                twilio_auth_token: envData['TWILIO_AUTH_TOKEN'] || '',
                twilio_from_number: envData['TWILIO_FROM_NUMBER'] || '',
                // X (Twitter)
                x_api_key: envData['X_API_KEY'] || '',
                x_api_secret: envData['X_API_SECRET'] || '',
                x_access_token: envData['X_ACCESS_TOKEN'] || '',
                x_access_secret: envData['X_ACCESS_SECRET'] || '',
                // Reddit
                reddit_client_id: envData['REDDIT_CLIENT_ID'] || '',
                reddit_client_secret: envData['REDDIT_CLIENT_SECRET'] || '',
                reddit_username: envData['REDDIT_USERNAME'] || '',
                reddit_password: envData['REDDIT_PASSWORD'] || '',
                // NOT github_token/github_repository ‚Äî auto-provided by GitHub Actions at runtime.
                // Including them would override CI values with your local gh token.
                // Persistence
                persistence_api_url: envData['PERSISTENCE_API_URL'] || '',
                persistence_api_key: envData['PERSISTENCE_API_KEY'] || '',
                // Renewal / Security
                renewal_secret: envData['RENEWAL_SECRET'] || '',
                release_secret: envData['RELEASE_SECRET'] || '',
                renewal_trigger_token: envData['RENEWAL_TRIGGER_TOKEN'] || '',
            };
            // Only include non-empty values
            const clean = {};
            for (const [k, v] of Object.entries(fields)) {
                if (v) clean[k] = v;
            }
            return clean;
        }

        function generateMasterSecret() {
            const config = buildMasterConfigJson();
            const json = JSON.stringify(config, null, 2);
            const count = Object.keys(config).length;

            const output = document.getElementById('secrets-output');
            const terminal = document.getElementById('secrets-terminal');
            output.style.display = 'block';
            terminal.className = 'terminal';
            terminal.textContent = `üìã CONTINUITY_CONFIG (${count} keys):\n\n${json}\n\nCopy this JSON and add it as a single GitHub secret named CONTINUITY_CONFIG.`;
        }

        async function pushMasterSecret() {
            // Merge live form values on top of envData so unsaved inputs are included
            const liveEnv = { ...envData };
            const fields = document.querySelectorAll('#secrets-form [data-secret-name]');
            const unsavedNames = [];
            fields.forEach(el => {
                const name = el.dataset.secretName;
                if (el.value && el.value !== (secretsInitialValues[name] ?? '')) {
                    liveEnv[name] = el.value;
                    unsavedNames.push(name);
                }
            });

            // Build config with live values
            const oldEnvData = envData;
            envData = liveEnv;
            const config = buildMasterConfigJson();
            envData = oldEnvData; // restore
            const count = Object.keys(config).length;

            if (count === 0) {
                alert('No adapter credentials found to bundle.\n\nSet some secrets above first.');
                return;
            }

            const json = JSON.stringify(config);

            // Warn about unsaved form values being included
            let confirmMsg = `Push CONTINUITY_CONFIG to GitHub with ${count} keys?\n`;
            confirmMsg += `\n‚ö†Ô∏è This is a COMPLETE OVERRIDE ‚Äî only secrets present here will exist in CI.`;
            confirmMsg += `\nMissing secrets will be absent, even if pushed individually before.`;
            if (unsavedNames.length > 0) {
                confirmMsg += `\n\nüìù Including ${unsavedNames.length} unsaved form value(s): ${unsavedNames.join(', ')}`;
                confirmMsg += `\n‚ö†Ô∏è These are NOT saved to .env yet ‚Äî click Save & Push after this to persist them locally.`;
            }
            if (!confirm(confirmMsg)) return;

            const output = document.getElementById('secrets-output');
            const terminal = document.getElementById('secrets-terminal');
            output.style.display = 'block';
            terminal.className = 'terminal';
            terminal.textContent = `‚òÅÔ∏è Pushing CONTINUITY_CONFIG (${count} keys) to GitHub...\n`;

            // Put master secret panel in loading state
            const masterBtn = document.getElementById('master-push-btn');
            if (masterBtn) { masterBtn.disabled = true; masterBtn.textContent = '‚è≥ Pushing...'; }

            try {
                const response = await fetch('/api/secrets/push', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        secrets: { CONTINUITY_CONFIG: json },
                        push_to_github: true,
                        save_to_env: false,
                    }),
                });
                const data = await response.json();

                if (data.error) {
                    terminal.className = 'terminal error';
                    terminal.textContent += `‚ùå ${data.error}\n`;
                    // Restore button
                    if (masterBtn) { masterBtn.disabled = false; masterBtn.textContent = '‚òÅÔ∏è Push to GitHub'; }
                    return;
                }

                const r = (data.results || [])[0];
                if (r?.success) {
                    terminal.textContent += `‚úÖ CONTINUITY_CONFIG pushed to GitHub!\n\n${count} adapter credentials bundled into one secret.`;
                    if (unsavedNames.length > 0) {
                        terminal.textContent += `\n\n‚ö†Ô∏è Remember: ${unsavedNames.join(', ')} are in the master but NOT saved to .env yet.`;
                        terminal.textContent += `\nClick Save & Push to persist them locally and push individually.`;
                    }
                } else {
                    terminal.className = 'terminal error';
                    terminal.textContent += `‚ùå Failed: ${r?.error || 'unknown'}\n`;
                }

                // Only refresh the master panel status (not the whole form, to preserve unsaved inputs)
                // Update ghSecrets to include CONTINUITY_CONFIG
                if (r?.success && !ghSecrets.includes('CONTINUITY_CONFIG')) {
                    ghSecrets.push('CONTINUITY_CONFIG');
                }
                // Restore button state
                if (masterBtn) { masterBtn.disabled = false; masterBtn.textContent = '‚òÅÔ∏è Push to GitHub'; }
                // Update the master status badge
                const masterStatusBadge = document.getElementById('master-status-badge');
                if (masterStatusBadge) masterStatusBadge.style.display = 'none';
            } catch (error) {
                terminal.className = 'terminal error';
                terminal.textContent += `‚ùå Error: ${error.message}`;
                if (masterBtn) { masterBtn.disabled = false; masterBtn.textContent = '‚òÅÔ∏è Push to GitHub'; }
            }
        }



        async function syncEnvToGithub() {
            if (!envData || Object.keys(envData).length === 0) {
                alert('No local .env values found.');
                return;
            }

            // Collect tier-1 secrets (excluding CONTINUITY_CONFIG ‚Äî handled separately)
            const secrets = {};
            for (const name of GITHUB_SECRETS) {
                const val = envData[name];
                if (val && name !== 'CONTINUITY_CONFIG') {
                    secrets[name] = val;
                }
            }

            // Collect tier-2 variables
            const variables = {};
            for (const name of GITHUB_VARS) {
                const val = envData[name];
                if (val) {
                    variables[name] = val;
                }
            }

            const secretCount = Object.keys(secrets).length;
            const varCount = Object.keys(variables).length;
            const totalCount = secretCount + varCount;
            if (totalCount === 0) {
                alert('No GitHub secrets or variables with values in .env to sync.');
                return;
            }

            let confirmMsg = `Push ${totalCount} value(s) from .env ‚Üí GitHub?\n\n`;
            if (secretCount) confirmMsg += `Secrets (${secretCount}): ${Object.keys(secrets).join(', ')}\n`;
            if (varCount) confirmMsg += `Variables (${varCount}): ${Object.keys(variables).join(', ')}\n`;
            confirmMsg += `\nThis will overwrite any existing GitHub values.`;

            if (!confirm(confirmMsg)) {
                return;
            }

            const output = document.getElementById('secrets-output');
            const terminal = document.getElementById('secrets-terminal');
            output.style.display = 'block';
            terminal.className = 'terminal';
            terminal.textContent = `‚òÅÔ∏è Syncing ${totalCount} value(s) from .env ‚Üí GitHub...\n`;

            try {
                const response = await fetch('/api/secrets/push', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        secrets,
                        variables,
                        push_to_github: true,
                        save_to_env: false,
                    }),
                });
                const data = await response.json();

                if (data.error) {
                    terminal.className = 'terminal error';
                    terminal.textContent = `Error: ${data.error}\n`;
                    return;
                }

                let text = '';
                let ok = 0, fail = 0;
                for (const r of (data.results || [])) {
                    const icon = r.kind === 'variable' ? 'üìã' : '‚òÅÔ∏è';
                    if (r.success) {
                        text += `${icon} ${r.name}\n`;
                        ok++;
                    } else {
                        text += `‚ùå ${r.name}: ${r.error}\n`;
                        fail++;
                    }
                }

                terminal.textContent = `‚òÅÔ∏è Sync complete: ${ok} pushed${fail ? `, ${fail} failed` : ''}\n\n${text}`;
                terminal.className = fail ? 'terminal error' : 'terminal';

                // Refresh to update GitHub column status
                secretsLoaded = false;
                appData = null;
                await loadSecretsForm();
                selectTarget(currentTarget);
            } catch (error) {
                terminal.className = 'terminal error';
                terminal.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        async function removeSecret(name, target, kind = 'secret') {
            const label = target === 'local' ? 'local .env' : target === 'github' ? 'GitHub' : 'local & GitHub';
            if (!confirm(`Remove ${name} from ${label}?\n\nThis cannot be undone.`)) return;

            // Put affected row or master panel in loading state
            const rowInput = document.querySelector(`[data-secret-name="${name}"]`);
            if (rowInput) {
                const rowEl = rowInput.closest('.secret-config-row');
                if (rowEl) { rowEl.style.opacity = '0.5'; rowEl.style.pointerEvents = 'none'; }
            }
            // Handle master secret panel separately (CONTINUITY_CONFIG has no regular row)
            if (name === 'CONTINUITY_CONFIG') {
                const panel = document.getElementById('master-secret-panel');
                if (panel) { panel.style.opacity = '0.5'; panel.style.pointerEvents = 'none'; }
            }

            const output = document.getElementById('secrets-output');
            const terminal = document.getElementById('secrets-terminal');
            output.style.display = 'block';
            terminal.className = 'terminal';
            terminal.textContent = `üóëÔ∏è Removing ${name} from ${label}...\n`;

            try {
                const response = await fetch('/api/secret/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, target, kind }),
                });
                const data = await response.json();

                let text = `üóëÔ∏è ${name}:\n`;
                if (data.local) text += `  Local: ${data.local.success ? '‚úÖ removed' : '‚ùå ' + data.local.error}\n`;
                if (data.github) text += `  GitHub: ${data.github.success ? '‚úÖ removed' : '‚ùå ' + data.github.error}\n`;
                terminal.textContent = text;

                // Refresh
                secretsLoaded = false;
                appData = null;
                await loadSecretsForm();
                selectTarget(currentTarget);
            } catch (error) {
                terminal.className = 'terminal error';
                terminal.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        async function clearSecretsPrompt(target) {
            const label = target === 'local' ? 'local .env' : 'GitHub';
            const secretsToRemove = target === 'local'
                ? KNOWN_SECRETS.filter(n => envData[n] && !AUTO_PROVIDED.includes(n))
                : ghSecrets.filter(n => GITHUB_SECRETS.includes(n));

            if (secretsToRemove.length === 0) {
                alert(`No secrets to clear from ${label}.`);
                return;
            }

            if (!confirm(`‚ö†Ô∏è DANGER: Remove ${secretsToRemove.length} secrets from ${label}?\n\n${secretsToRemove.join(', ')}\n\nThis cannot be undone!`)) return;
            if (!confirm(`Are you absolutely sure? This will delete all secret values from ${label}.`)) return;

            const output = document.getElementById('secrets-output');
            const terminal = document.getElementById('secrets-terminal');
            output.style.display = 'block';
            terminal.className = 'terminal';
            terminal.textContent = `üóëÔ∏è Clearing ${secretsToRemove.length} secrets from ${label}...\n`;

            let ok = 0, fail = 0;
            for (const name of secretsToRemove) {
                try {
                    const response = await fetch('/api/secret/remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, target }),
                    });
                    const data = await response.json();
                    const result = target === 'local' ? data.local : data.github;
                    if (result?.success) {
                        terminal.textContent += `‚úÖ ${name}\n`;
                        ok++;
                    } else {
                        terminal.textContent += `‚ùå ${name}: ${result?.error || 'unknown'}\n`;
                        fail++;
                    }
                } catch (e) {
                    terminal.textContent += `‚ùå ${name}: ${e.message}\n`;
                    fail++;
                }
            }

            terminal.textContent += `\nüóëÔ∏è Done: ${ok} removed${fail ? `, ${fail} failed` : ''}`;
            terminal.className = fail ? 'terminal error' : 'terminal';

            // Refresh
            secretsLoaded = false;
            appData = null;
            loadSecretsForm();
        }
        async function pushSecrets(target = 'both') {
            const inputs = document.querySelectorAll('[data-secret-name]');
            const gitSyncChecked = document.getElementById('secrets-git-sync')?.checked ?? false;

            // Only collect fields that were actually changed or marked for deletion
            const secrets = {};
            const deletions = [];
            inputs.forEach(input => {
                const name = input.dataset.secretName;
                const initial = secretsInitialValues[name] ?? '';
                if (input.dataset.markedDelete === 'true') {
                    deletions.push(name);
                } else if (input.value && input.value !== initial) {
                    secrets[name] = input.value;
                }
            });

            // When saving to Both: also include secrets/vars that exist locally but are missing from GitHub
            // Skip anything marked for deletion ‚Äî those should NOT be pushed
            if (target === 'both') {
                for (const name of GITHUB_SECRETS) {
                    if (secrets[name]) continue; // already changed
                    if (deletions.includes(name)) continue; // marked for deletion
                    if (AUTO_PROVIDED.includes(name)) continue;
                    const localVal = envData[name];
                    if (localVal && !ghSecrets.includes(name)) {
                        secrets[name] = localVal;
                    }
                }
                for (const name of GITHUB_VARS) {
                    if (secrets[name]) continue;
                    if (deletions.includes(name)) continue; // marked for deletion
                    const localVal = envData[name];
                    if (localVal && !ghVariables.includes(name)) {
                        secrets[name] = localVal;
                    }
                }
            }

            if (Object.keys(secrets).length === 0 && deletions.length === 0) {
                // Should not happen since the button is disabled, but safety check
                return;
            }

            // Split changed values into secrets vs variables for the correct gh command
            const ghPush = target === 'both' || target === 'github';
            const secretsForGh = {};
            const variablesForGh = {};
            if (ghPush) {
                for (const [k, v] of Object.entries(secrets)) {
                    if (AUTO_PROVIDED.includes(k)) continue;
                    if (GITHUB_VARS.includes(k)) {
                        variablesForGh[k] = v;
                    } else if (GITHUB_SECRETS.includes(k)) {
                        secretsForGh[k] = v;
                    }
                    // LOCAL_ONLY values are not pushed to GitHub at all
                }
            }

            const output = document.getElementById('secrets-output');
            const terminal = document.getElementById('secrets-terminal');

            const actionCount = Object.keys(secrets).length + deletions.length;
            const targetLabel = target === 'both' ? 'local & GitHub' : target;
            output.style.display = 'block';
            terminal.className = 'terminal';
            terminal.textContent = `Saving ${actionCount} change(s) to ${targetLabel}...\n`;

            // Put affected rows in loading state
            for (const name of [...Object.keys(secrets), ...deletions]) {
                const row = document.querySelector(`[data-secret-name="${name}"]`);
                if (row) {
                    const rowEl = row.closest('.secret-config-row');
                    if (rowEl) { rowEl.style.opacity = '0.5'; rowEl.style.pointerEvents = 'none'; }
                }
            }

            try {
                const response = await fetch('/api/secrets/push', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        secrets: secretsForGh,
                        variables: variablesForGh,
                        env_values: (target === 'both' || target === 'local') ? secrets : {},
                        deletions: (target === 'both' || target === 'local') ? deletions : [],
                        push_to_github: ghPush,
                        save_to_env: target === 'both' || target === 'local',
                        exclude_from_github: AUTO_PROVIDED,
                    }),
                });
                const data = await response.json();

                if (data.error) {
                    terminal.className = 'terminal error';
                    terminal.textContent = `Error: ${data.error}\n`;
                    if (data.install_hint) {
                        terminal.textContent += `\n${data.install_hint}`;
                    }
                    return;
                }

                let output_text = '';

                // Show env save status
                if (data.env_saved) {
                    const savedKeys = Object.keys(secrets);
                    if (savedKeys.length > 0) output_text += `üìÅ Saved to .env: ${savedKeys.join(', ')}\n`;
                    if (data.deletions_applied && data.deletions_applied.length > 0) {
                        output_text += `üóëÔ∏è Deleted from .env: ${data.deletions_applied.join(', ')}\n`;
                    }
                }

                // Show GitHub push results (secrets + variables)
                for (const result of (data.results || [])) {
                    const icon = result.kind === 'variable' ? 'üìã' : '‚òÅÔ∏è';
                    const label = result.kind === 'variable' ? 'variable' : 'secret';
                    if (result.success) {
                        output_text += `${icon} ${result.name}: pushed as GitHub ${label}\n`;
                    } else {
                        output_text += `‚ùå ${result.name}: ${result.error}\n`;
                    }
                }

                terminal.textContent = output_text || 'Done!';
                terminal.className = data.all_success !== false ? 'terminal' : 'terminal error';

                // Git sync if requested
                if (gitSyncChecked) {
                    terminal.textContent += `\nüîÑ Syncing to Git...\n`;
                    try {
                        const syncResponse = await fetch('/api/git/sync', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: 'chore: secrets update from admin panel' }),
                        });
                        const syncData = await syncResponse.json();
                        if (syncData.success) {
                            terminal.textContent += `üîÑ ${syncData.message}\n`;
                        } else {
                            terminal.textContent += `‚ö†Ô∏è Git sync: ${syncData.error || 'failed'}\n`;
                            if (syncData.hint) terminal.textContent += `   üí° ${syncData.hint}\n`;
                        }
                    } catch (e) {
                        terminal.textContent += `‚ö†Ô∏è Git sync failed: ${e.message}\n`;
                    }
                }

                // Smooth refresh: show loading overlay, then rebuild form with fresh data
                if (data.all_success !== false) {
                    // Show loading overlay on the form (no input clearing = no flash)
                    const formEl = document.getElementById('secrets-form');
                    formEl.style.position = 'relative';
                    const overlay = document.createElement('div');
                    overlay.id = 'secrets-loading-overlay';
                    overlay.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;border-radius:8px;z-index:10;';
                    overlay.innerHTML = '<div style="color:#fff;font-size:1rem;">üîÑ Refreshing‚Ä¶</div>';
                    formEl.appendChild(overlay);

                    // Invalidate data and rebuild immediately
                    secretsLoaded = false;
                    appData = null;
                    await loadSecretsForm();
                    // Re-apply target selection so button state persists
                    selectTarget(currentTarget);
                }
            } catch (error) {
                terminal.className = 'terminal error';
                terminal.textContent = `Error: ${error.message}`;
            }
        }

        // Run command
        async function runCmd(command) {
            const terminal = document.getElementById('cmd-terminal');
            terminal.className = 'terminal';
            terminal.textContent = `Running ${command}...\n`;

            try {
                const response = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command }),
                });
                const data = await response.json();

                if (data.success) {
                    terminal.textContent = data.output || 'Command completed successfully';
                } else {
                    terminal.textContent = data.error || data.output || 'Command failed';
                    terminal.className = 'terminal error';
                }

                // Refresh status
                setTimeout(loadStatus, 1000);
            } catch (error) {
                terminal.className = 'terminal error';
                terminal.textContent = `Error: ${error.message}`;
            }
        }

        // Run a command, then optionally git sync
        async function runCmdWithSync(command, checkboxId) {
            await runCmd(command);
            const cb = document.getElementById(checkboxId);
            if (cb && cb.checked) {
                await doGitSync('cmd-terminal');
            }
        }

        // Shared git sync helper ‚Äî appends result to a terminal element
        async function doGitSync(terminalId) {
            const terminal = document.getElementById(terminalId);
            if (terminal) terminal.textContent += '\n\nüîÑ Syncing to Git...\n';
            try {
                const resp = await fetch('/api/git/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'chore: sync from admin panel' }),
                });
                const data = await resp.json();
                if (terminal) {
                    if (data.success) {
                        terminal.textContent += `‚úÖ ${data.message}\n`;
                    } else {
                        terminal.textContent += `‚ö†Ô∏è Git sync: ${data.error || 'failed'}\n`;
                        if (data.hint) terminal.textContent += `   üí° ${data.hint}\n`;
                    }
                }
            } catch (e) {
                if (terminal) terminal.textContent += `‚ö†Ô∏è Git sync failed: ${e.message}\n`;
            }
        }

        // ========================================
        // GIT STATUS (dashboard card)
        // ========================================
        async function loadGitStatus() {
            const el = document.getElementById('git-status-content');
            if (!el) return;
            try {
                const resp = await fetch('/api/git/status');
                const g = await resp.json();
                if (!g.available) {
                    el.innerHTML = `<span style="color: var(--text-dim);">‚ö†Ô∏è ${g.error || 'Git not available'}</span>`;
                    return;
                }

                const syncIcon = g.clean ? '‚úÖ' : g.total_changes > 0 ? 'üü°' : 'üü¢';
                const abHtml = (g.ahead || g.behind)
                    ? `<span style="color: var(--warning);">${g.ahead ? `‚Üë${g.ahead}` : ''} ${g.behind ? `‚Üì${g.behind}` : ''}</span>`
                    : '<span style="color: var(--accent);">In sync</span>';

                el.innerHTML = `
                    <div class="status-row">
                        <span class="status-label">Branch</span>
                        <span class="status-value" style="font-family: monospace;">${g.branch}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Last commit</span>
                        <span class="status-value" style="font-size: 0.82rem;">${g.last_commit} <span style="color: var(--text-dim);">(${g.last_commit_time})</span></span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Changes</span>
                        <span class="status-value">${syncIcon} ${g.total_changes} pending ${g.staged ? `(${g.staged} staged)` : ''}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Remote</span>
                        <span class="status-value">${abHtml}</span>
                    </div>
                    <div class="actions" style="margin-top: 0.75rem;">
                        <button class="btn" onclick="loadGitStatus()">üîÑ Refresh</button>
                        <button class="btn primary" onclick="dashboardGitSync()" id="dash-sync-btn">üì§ Sync Now</button>
                    </div>
                    <div id="dash-git-status" style="font-size: 0.85rem; margin-top: 0.5rem;"></div>
                `;
            } catch (e) {
                el.innerHTML = `<span style="color: var(--danger);">‚ùå ${e.message}</span>`;
            }
        }

        async function dashboardGitSync() {
            const statusDiv = document.getElementById('dash-git-status');
            const btn = document.getElementById('dash-sync-btn');
            if (btn) btn.disabled = true;
            if (statusDiv) statusDiv.innerHTML = '<span style="color: var(--info);">üîÑ Syncing...</span>';
            try {
                const resp = await fetch('/api/git/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'chore: sync from admin panel' }),
                });
                const data = await resp.json();
                if (data.success) {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--accent);">‚úÖ ${data.message}</span>`;
                } else {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ö†Ô∏è ${data.error || 'Failed'}</span>`;
                }
                // Refresh git status
                setTimeout(loadGitStatus, 1500);
            } catch (e) {
                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå ${e.message}</span>`;
            }
            if (btn) btn.disabled = false;
        }

        // ========================================
        // INTEGRATIONS TAB
        // ========================================
        const INTEGRATIONS = [
            {
                id: 'email', label: 'Email', adapter: 'email',
                secrets: ['RESEND_API_KEY', 'RESEND_FROM_EMAIL', 'OPERATOR_EMAIL'],
                testCmd: 'test email',
                wizardStep: 'email',
            },
            {
                id: 'sms', label: 'SMS', adapter: 'sms',
                secrets: ['TWILIO_ACCOUNT_SID', 'TWILIO_AUTH_TOKEN', 'TWILIO_FROM_NUMBER', 'OPERATOR_SMS'],
                testCmd: 'test sms',
                wizardStep: 'sms',
            },
            {
                id: 'x', label: 'X / Twitter', adapter: 'x_twitter',
                secrets: ['X_API_KEY', 'X_API_SECRET', 'X_ACCESS_TOKEN', 'X_ACCESS_SECRET'],
                testCmd: null,
                wizardStep: 'twitter',
            },
            {
                id: 'reddit', label: 'Reddit', adapter: 'reddit',
                secrets: ['REDDIT_CLIENT_ID', 'REDDIT_CLIENT_SECRET', 'REDDIT_USERNAME', 'REDDIT_PASSWORD'],
                testCmd: null,
                wizardStep: 'reddit',
            },
        ];

        async function loadIntegrations() {
            if (!appData) {
                const resp = await fetch('/api/status');
                appData = await resp.json();
            }
            if (!envData || Object.keys(envData).length === 0) {
                const envResp = await fetch('/api/env/read');
                const envResult = await envResp.json();
                envData = envResult.values || {};
            }

            for (const integ of INTEGRATIONS) {
                const el = document.getElementById(`integration-${integ.id}`);
                if (!el) continue;

                // Check which secrets are set
                const secretStatus = integ.secrets.map(s => ({
                    name: s,
                    set: !!(envData[s] && envData[s].length > 0),
                }));
                const allSet = secretStatus.every(s => s.set);
                const noneSet = secretStatus.every(s => !s.set);

                // Find adapter status
                const adapter = appData.adapters?.find(a => a.name === integ.adapter);
                const mode = adapter?.configured ? adapter.mode : null;

                let html = '';

                // Secret status
                html += `<div style="display: flex; flex-wrap: wrap; gap: 0.35rem;">`;
                for (const s of secretStatus) {
                    html += `<span style="font-size: 0.78rem; padding: 0.15rem 0.45rem; border-radius: 4px;
                        background: ${s.set ? 'rgba(74,222,128,0.1)' : 'rgba(239,68,68,0.1)'};
                        color: ${s.set ? 'var(--accent)' : 'var(--danger)'};">
                        ${s.set ? '‚úì' : '‚úó'} ${s.name.split('_').slice(-1)[0].toLowerCase()}
                    </span>`;
                }
                html += `</div>`;

                // Mode badge
                if (mode) {
                    html += `<div style="font-size: 0.82rem;">
                        Mode: <span class="badge ${mode === 'real' ? 'ok' : 'warning'}">${mode}</span>
                    </div>`;
                }

                // Actions
                if (allSet && integ.testCmd) {
                    const defaultTo = integ.id === 'email'
                        ? (envData['OPERATOR_EMAIL'] || '')
                        : (envData['OPERATOR_SMS'] || '');
                    const placeholder = defaultTo
                        ? `Default: ${defaultTo}`
                        : (integ.id === 'email' ? 'email@example.com' : '+1234567890');
                    html += `
                        <div style="margin-top: 0.4rem;">
                            <label style="font-size: 0.78rem; color: var(--text-dim); margin-bottom: 0.25rem; display: block;">
                                Send to ${integ.id === 'email' ? '(email)' : '(phone)'}:
                            </label>
                            <input type="${integ.id === 'email' ? 'email' : 'tel'}"
                                id="test-to-${integ.id}"
                                placeholder="${placeholder}"
                                style="width: 100%; box-sizing: border-box; padding: 0.45rem 0.7rem; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85rem; margin-bottom: 0.5rem;" />
                            <button class="btn primary" onclick="runIntegrationTest('${integ.id}')" style="width: 100%;">
                                üß™ Send Test ${integ.label}
                            </button>
                        </div>`;
                } else if (allSet && !integ.testCmd) {
                    html += `<div style="color: var(--accent); font-size: 0.85rem;">‚úÖ Configured ‚Äî no test available yet</div>`;
                } else {
                    const missingKeys = secretStatus.filter(s => !s.set).map(s => s.name);
                    html += `
                        <div style="color: var(--warning); font-size: 0.82rem;">
                            Missing: ${missingKeys.join(', ')}
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn primary" onclick="goToWizardStep('${integ.wizardStep}')" style="flex: 1;">
                                üßô Setup in Wizard ‚Üí
                            </button>
                            <button class="btn" onclick="switchTab('secrets')" style="flex: 1;">
                                üîê Secrets ‚Üí
                            </button>
                        </div>`;
                }

                // Last test result (persisted in localStorage)
                html += getLastTestHtml(integ.id);

                el.innerHTML = html;
            }
        }

        async function runIntegrationTest(integId) {
            const terminal = document.getElementById('integration-terminal');
            const toInput = document.getElementById(`test-to-${integId}`);
            const to = toInput?.value?.trim() || '';
            const label = integId === 'email' ? 'Email' : 'SMS';

            terminal.className = 'terminal';
            terminal.textContent = `üß™ Testing ${label}${to ? ` ‚Üí ${to}` : ' (using default)'}...\n`;

            try {
                const body = {};
                if (to) body.to = to;

                const response = await fetch(`/api/test/${integId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await response.json();

                const testResult = {
                    success: !!data.success,
                    message: data.success
                        ? (data.output || 'Completed successfully')
                        : (data.error || data.output || 'Unknown error'),
                    timestamp: Date.now(),
                    to: to || '(default)',
                };
                localStorage.setItem(`test-result-${integId}`, JSON.stringify(testResult));

                if (data.success) {
                    terminal.textContent = `‚úÖ ${label} test result:\n\n${testResult.message}`;
                } else {
                    terminal.textContent = `‚ùå ${label} test failed:\n\n${testResult.message}`;
                    terminal.className = 'terminal error';
                }

                // Refresh card to show new status
                loadIntegrations();
            } catch (error) {
                const testResult = {
                    success: false,
                    message: error.message,
                    timestamp: Date.now(),
                    to: to || '(default)',
                };
                localStorage.setItem(`test-result-${integId}`, JSON.stringify(testResult));

                terminal.className = 'terminal error';
                terminal.textContent = `‚ùå Error: ${error.message}`;
                loadIntegrations();
            }
        }

        function getLastTestHtml(integId) {
            try {
                const raw = localStorage.getItem(`test-result-${integId}`);
                if (!raw) return '';
                const r = JSON.parse(raw);
                const ago = formatTimeAgo(r.timestamp);
                const icon = r.success ? '‚úÖ' : '‚ùå';
                const color = r.success ? 'var(--accent)' : 'var(--danger)';
                const msg = r.message.length > 60 ? r.message.slice(0, 57) + '‚Ä¶' : r.message;
                return `<div style="font-size: 0.78rem; color: ${color}; margin-top: 0.35rem;"
                    title="${r.message.replace(/"/g, '&quot;')}">${icon} Last test ${ago}: ${msg}</div>`;
            } catch { return ''; }
        }

        function formatTimeAgo(ts) {
            const diff = Math.floor((Date.now() - ts) / 1000);
            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        // Archive functions
        async function archiveNow(allPages = false) {
            const statusDiv = document.getElementById('archive-status');
            const urlInput = document.getElementById('archive-url');
            const customUrl = urlInput?.value?.trim();

            const label = allPages ? 'all pages' : 'index';
            statusDiv.innerHTML = `<span style="color: var(--info);">üì¶ Archiving ${label} to archive.org... This may take a few minutes.</span>`;

            try {
                const response = await fetch('/api/archive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: customUrl || undefined,
                        all_pages: allPages,
                    }),
                });
                const data = await response.json();

                if (data.results) {
                    // Multi-page results
                    const rows = data.results.map(r => {
                        const icon = r.success ? '‚úÖ' : '‚ùå';
                        const link = r.archive_url
                            ? `<a href="${r.archive_url}" target="_blank" style="color: var(--info);">${r.page}</a>`
                            : `<span>${r.page}</span>`;
                        const err = r.error ? ` ‚Äî <span style="color: var(--danger); font-size: 0.8rem;">${r.error}</span>` : '';
                        return `<div>${icon} ${link}${err}</div>`;
                    }).join('');
                    statusDiv.innerHTML = `
                        <div style="color: var(--accent); margin-bottom: 0.5rem;">
                            üì¶ Archived ${data.archived}/${data.total} pages
                        </div>
                        <div style="line-height: 1.8;">${rows}</div>
                    `;
                } else if (data.success) {
                    statusDiv.innerHTML = `
                        <div style="color: var(--accent);">‚úÖ Archived successfully!</div>
                        <div style="margin-top: 0.5rem;">
                            <a href="${data.archive_url}" target="_blank" style="color: var(--info); word-break: break-all;">
                                ${data.archive_url}
                            </a>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.error}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Error: ${error.message}</span>`;
            }
        }

        async function checkArchive(allPages = false) {
            const statusDiv = document.getElementById('archive-status');
            const urlInput = document.getElementById('archive-url');
            let url = urlInput?.value?.trim();

            // If no custom URL, try to build GitHub Pages URL
            if (!url && !allPages) {
                const repo = envData.GITHUB_REPOSITORY;
                if (repo) {
                    const parts = repo.split('/');
                    url = `https://${parts[0]}.github.io/${parts[1]}/`;
                } else {
                    statusDiv.innerHTML = '<span style="color: var(--warning);">‚ö†Ô∏è Enter a URL to check</span>';
                    return;
                }
            }

            const label = allPages ? 'all pages' : 'index';
            statusDiv.innerHTML = `<span style="color: var(--info);">üîç Checking ${label} on archive.org...</span>`;

            try {
                const response = await fetch('/api/archive/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url || undefined,
                        all_pages: allPages,
                    }),
                });
                const data = await response.json();

                if (data.results) {
                    // Multi-page results
                    const rows = data.results.map(r => {
                        const icon = r.archived ? '‚úÖ' : '‚ùå';
                        const info = r.archived && r.snapshot
                            ? `<a href="${r.snapshot.url}" target="_blank" style="color: var(--info);">${r.page}</a> <span style="color: var(--text-dim); font-size: 0.8rem;">(${r.snapshot.timestamp || ''})</span>`
                            : `<span style="color: var(--text-dim);">${r.page}</span> ‚Äî not archived`;
                        return `<div>${icon} ${info}</div>`;
                    }).join('');
                    statusDiv.innerHTML = `
                        <div style="color: var(--accent); margin-bottom: 0.5rem;">
                            üîç ${data.archived_count}/${data.total} pages archived
                        </div>
                        <div style="line-height: 1.8;">${rows}</div>
                    `;
                } else if (data.archived && data.snapshot) {
                    statusDiv.innerHTML = `
                        <div style="color: var(--accent);">‚úÖ Found in archive!</div>
                        <div style="margin-top: 0.5rem;">
                            <a href="${data.snapshot.url}" target="_blank" style="color: var(--info); word-break: break-all;">
                                Last snapshot: ${data.snapshot.timestamp}
                            </a>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = '<span style="color: var(--warning);">‚ö†Ô∏è Not yet archived. Click "Archive All Pages" to create snapshots.</span>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Error: ${error.message}</span>`;
            }
        }

        // ========================================
        // SETUP WIZARD
        // ========================================

        const wizardSteps = [
            {
                id: 'welcome',
                title: 'Welcome',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üëã Welcome to the Setup Wizard</h2>
                    <p style="color: var(--text-dim); line-height: 1.6; margin-bottom: 1rem;">
                        This wizard will guide you through configuring the Continuity Orchestrator step-by-step.
                    </p>
                    <p style="color: var(--text-dim); line-height: 1.6; margin-bottom: 1rem;">
                        You'll configure:
                    </p>
                    <ul style="color: var(--text-dim); line-height: 1.8; margin-left: 1.5rem;">
                        <li>üöÄ <strong>Deployment mode</strong> (GitHub Pages, Docker, etc.)</li>
                        <li>üìã Basic project settings & <strong>operating mode</strong></li>
                        <li>‚è∞ Countdown deadline <em style="opacity:0.6;"> ‚Äî if countdown mode</em></li>
                        <li>üìß Email notifications (Resend)</li>
                        <li>üì± SMS notifications (Twilio) <em style="opacity:0.6;">‚Äî optional</em></li>
                        <li>üê¶ X/Twitter posting <em style="opacity:0.6;">‚Äî optional</em></li>
                        <li>ü§ñ Reddit posting <em style="opacity:0.6;">‚Äî optional</em></li>
                        <li>üîê Security secrets</li>
                        <li>üöÄ Push to GitHub</li>
                    </ul>
                    <p style="color: var(--text-dim); margin-top: 1rem; font-size: 0.9rem;">
                        üí° Skip any optional step by leaving fields blank.
                    </p>
                `,
                validate: () => true
            },
            {
                id: 'deployment',
                title: 'Deploy',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üöÄ Deployment Mode</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                        How do you want to deploy the Continuity Orchestrator?
                    </p>
                    <div class="form-group">
                        <label class="form-label">Select your deployment method:</label>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${wizardData.DEPLOY_MODE === 'github-pages' ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="deploy-mode" value="github-pages" ${wizardData.DEPLOY_MODE !== 'docker' ? 'checked' : ''} onchange="wizardData.DEPLOY_MODE='github-pages'">
                                <div>
                                    <strong>üåê GitHub Pages</strong> <span style="color: var(--accent);">Recommended</span>
                                    <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">
                                        Free hosting via GitHub. Site auto-updates via Actions.<br>
                                        <em>‚ö†Ô∏è Requires GitHub Pro/Team for private repos with public Pages.</em>
                                    </div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${wizardData.DEPLOY_MODE === 'docker' ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="deploy-mode" value="docker" ${wizardData.DEPLOY_MODE === 'docker' ? 'checked' : ''} onchange="wizardData.DEPLOY_MODE='docker'">
                                <div>
                                    <strong>üê≥ Docker (Self-Hosted)</strong>
                                    <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">
                                        Run locally with Docker. No GitHub Pro needed.<br>
                                        <em>Options: docker-compose, git-sync to public repo, or standalone.</em>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="alert info" style="margin-top: 1rem;">
                        üí° <strong>Not sure?</strong> Start with GitHub Pages ‚Äî you can switch to Docker later.
                    </div>
                `,
                validate: () => true,
                collect: () => ({
                    DEPLOY_MODE: document.querySelector('input[name="deploy-mode"]:checked')?.value || 'github-pages'
                })
            },
            {
                id: 'project',
                title: 'Project',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üìã Project Configuration</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                        Basic settings for your orchestrator instance.
                    </p>
                    <div class="form-group">
                        <label class="form-label">Project Name *</label>
                        <input type="text" class="form-input" id="wiz-project-name" 
                               placeholder="my-deadman" value="${getSecretValue('PROJECT_NAME')}">
                        <div class="form-hint">A unique identifier for your project</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Operator Email *</label>
                        <input type="email" class="form-input" id="wiz-operator-email" 
                               placeholder="your@email.com" value="${getSecretValue('OPERATOR_EMAIL')}">
                        <div class="form-hint">Email for receiving notifications</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mock Mode</label>
                        <select class="form-input" id="wiz-mock-mode">
                            <option value="true" ${getSecretValue('ADAPTER_MOCK_MODE') !== 'false' ? 'selected' : ''}>On (safe testing)</option>
                            <option value="false" ${getSecretValue('ADAPTER_MOCK_MODE') === 'false' ? 'selected' : ''}>Off (live operations)</option>
                        </select>
                        <div class="form-hint">Keep ON for testing, turn OFF for production</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Operating Mode</label>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.MODE || 'renewable_countdown') === 'renewable_countdown' ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="wiz-mode" value="renewable_countdown" ${(wizardData.MODE || 'renewable_countdown') === 'renewable_countdown' ? 'checked' : ''} onchange="wizardData.MODE='renewable_countdown'">
                                <div>
                                    <strong>‚è∞ Renewable Countdown</strong> <span style="color: var(--accent);">Default</span>
                                    <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">Dead man's switch. Renew before the deadline or escalation begins.</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.MODE || 'renewable_countdown') === 'one_way_fuse' ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="wiz-mode" value="one_way_fuse" ${(wizardData.MODE || 'renewable_countdown') === 'one_way_fuse' ? 'checked' : ''} onchange="wizardData.MODE='one_way_fuse'">
                                <div>
                                    <strong>üí£ One-Way Fuse</strong>
                                    <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">Once armed, the deadline cannot be renewed. Escalation is irreversible.</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.MODE || 'renewable_countdown') === 'manual_arm' ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="wiz-mode" value="manual_arm" ${(wizardData.MODE || 'renewable_countdown') === 'manual_arm' ? 'checked' : ''} onchange="wizardData.MODE='manual_arm'">
                                <div>
                                    <strong>üîí Manual Arm</strong>
                                    <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">System stays disarmed until explicitly activated. No countdown until you arm it.</div>
                                </div>
                            </label>
                        </div>
                    </div>
                `,
                validate: () => {
                    const name = document.getElementById('wiz-project-name')?.value;
                    const email = document.getElementById('wiz-operator-email')?.value;
                    if (!name) { alert('Project name is required'); return false; }
                    if (!email) { alert('Operator email is required'); return false; }
                    return true;
                },
                collect: () => {
                    const mode = document.querySelector('input[name="wiz-mode"]:checked')?.value || 'renewable_countdown';
                    wizardData.MODE = mode;
                    return {
                        PROJECT_NAME: document.getElementById('wiz-project-name').value,
                        OPERATOR_EMAIL: document.getElementById('wiz-operator-email').value,
                        ADAPTER_MOCK_MODE: document.getElementById('wiz-mock-mode').value,
                    };
                }
            },
            {
                id: 'deadline',
                title: 'Timer',
                // Only show this step in renewable_countdown mode
                skip: () => (wizardData.MODE || 'renewable_countdown') !== 'renewable_countdown',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">‚è∞ Countdown Deadline</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                        How long before the system activates? This is the dead man's switch timer.
                        If you don't renew before the deadline, escalation begins.
                    </p>
                    <div class="form-group">
                        <label class="form-label">Initial Deadline (hours from now)</label>
                        <div style="display: flex; gap: 0.75rem; margin-top: 0.5rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.DEADLINE_HOURS || 48) == 24 ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="deadline-hours" value="24" ${(wizardData.DEADLINE_HOURS || 48) == 24 ? 'checked' : ''} onchange="wizardData.DEADLINE_HOURS=24">
                                <div><strong>24h</strong><div style="color: var(--text-dim); font-size: 0.8rem;">1 day</div></div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.DEADLINE_HOURS || 48) == 48 ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="deadline-hours" value="48" ${(wizardData.DEADLINE_HOURS || 48) == 48 ? 'checked' : ''} onchange="wizardData.DEADLINE_HOURS=48">
                                <div><strong>48h</strong> <span style="color: var(--accent);">Default</span><div style="color: var(--text-dim); font-size: 0.8rem;">2 days</div></div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.DEADLINE_HOURS || 48) == 72 ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="deadline-hours" value="72" ${(wizardData.DEADLINE_HOURS || 48) == 72 ? 'checked' : ''} onchange="wizardData.DEADLINE_HOURS=72">
                                <div><strong>72h</strong><div style="color: var(--text-dim); font-size: 0.8rem;">3 days</div></div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.DEADLINE_HOURS || 48) == 168 ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="deadline-hours" value="168" ${(wizardData.DEADLINE_HOURS || 48) == 168 ? 'checked' : ''} onchange="wizardData.DEADLINE_HOURS=168">
                                <div><strong>168h</strong><div style="color: var(--text-dim); font-size: 0.8rem;">1 week</div></div>
                            </label>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">Or set a custom value:</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="number" class="form-input" id="wiz-custom-deadline" 
                                   placeholder="hours" min="1" max="8760"
                                   style="width: 120px;"
                                   value="${wizardData.DEADLINE_HOURS && ![24, 48, 72, 168].includes(wizardData.DEADLINE_HOURS) ? wizardData.DEADLINE_HOURS : ''}"
                                   oninput="wizardData.DEADLINE_HOURS=parseInt(this.value)">
                            <span style="color: var(--text-dim);">hours</span>
                        </div>
                    </div>
                    <div class="alert info" style="margin-top: 1rem;">
                        ‚è±Ô∏è <strong>How it works:</strong> You must renew before the deadline expires.
                        The system checks every 30 minutes. As the deadline approaches, escalation
                        stages trigger (reminders ‚Üí warnings ‚Üí disclosure).
                        You can always change this later from the Dashboard.
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    const radio = document.querySelector('input[name="deadline-hours"]:checked');
                    const custom = document.getElementById('wiz-custom-deadline')?.value;
                    return {
                        DEADLINE_HOURS: custom ? parseInt(custom) : (radio ? parseInt(radio.value) : 48)
                    };
                }
            },
            {
                id: 'email',
                title: 'Email',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üìß Email Configuration</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1rem;">
                        Configure email notifications using <a href="https://resend.com" target="_blank" style="color: var(--info);">Resend</a>.
                        Free tier supports 100 emails/day.
                    </p>
                    <details style="margin-bottom: 1.25rem;">
                        <summary style="cursor: pointer; color: var(--info); font-weight: 600;">üìñ Setup Guide (3 steps)</summary>
                        <ol style="color: var(--text-dim); line-height: 2; margin: 0.75rem 0 0 1.5rem; font-size: 0.9rem;">
                            <li>Create a free account at <a href="https://resend.com/signup" target="_blank" style="color: var(--info);">resend.com/signup</a></li>
                            <li>Go to <a href="https://resend.com/api-keys" target="_blank" style="color: var(--info);">API Keys</a> ‚Üí click <strong>"Create API Key"</strong> ‚Üí give it a name ‚Üí copy the key (starts with <code>re_</code>)</li>
                            <li>If you own a domain, <a href="https://resend.com/domains" target="_blank" style="color: var(--info);">verify it</a> to send from your own address. Otherwise the default <code>onboarding@resend.dev</code> works for testing.</li>
                        </ol>
                    </details>
                    <div class="form-group">
                        <label class="form-label">Resend API Key *</label>
                        <input type="password" class="form-input" id="wiz-resend-key"
                               placeholder="re_xxxxxxxxxx"
                               title="Your Resend API key. Find it at resend.com ‚Üí API Keys. Starts with re_">
                        <div class="form-hint">
                            Paste from <a href="https://resend.com/api-keys" target="_blank" style="color: var(--info);">resend.com/api-keys</a>
                            ${appData?.secrets?.find(s => s.name === 'RESEND_API_KEY')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">From Email</label>
                        <input type="email" class="form-input" id="wiz-resend-from"
                               placeholder="noreply@yourdomain.com" value="${getSecretValue('RESEND_FROM_EMAIL')}"
                               title="Sender address shown in the From field. Must be a verified domain in Resend, or use the default onboarding@resend.dev for testing.">
                        <div class="form-hint">Leave blank to use the default <code>onboarding@resend.dev</code> (works for testing)</div>
                    </div>
                    <div style="margin-top: 1rem; padding: 0.5rem 0.75rem; border-radius: 6px; background: rgba(99,102,241,0.08); font-size: 0.82rem; color: var(--text-dim);">
                        üí° After setup, test this from the <a href="#integrations" onclick="switchTab('integrations'); return false;" style="color: var(--info); font-weight: 600;">Integrations</a> tab.
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    const result = {};
                    const key = document.getElementById('wiz-resend-key').value;
                    if (key) result.RESEND_API_KEY = key;
                    const from = document.getElementById('wiz-resend-from').value;
                    if (from) result.RESEND_FROM_EMAIL = from;
                    return result;
                }
            },
            {
                id: 'sms',
                title: 'SMS',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üì± SMS Notifications (Twilio)</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1rem;">
                        <em>Optional</em> ‚Äî Send SMS alerts using <a href="https://www.twilio.com/try-twilio" target="_blank" style="color: var(--info);">Twilio</a>.
                    </p>
                    <details style="margin-bottom: 1.25rem;">
                        <summary style="cursor: pointer; color: var(--info); font-weight: 600;">üìñ Setup Guide (4 steps)</summary>
                        <ol style="color: var(--text-dim); line-height: 2; margin: 0.75rem 0 0 1.5rem; font-size: 0.9rem;">
                            <li>Sign up for a free trial at <a href="https://www.twilio.com/try-twilio" target="_blank" style="color: var(--info);">twilio.com/try-twilio</a> (includes free credits)</li>
                            <li>Once logged in, your <strong>Account SID</strong> and <strong>Auth Token</strong> are shown right on the <a href="https://console.twilio.com/" target="_blank" style="color: var(--info);">Console dashboard</a></li>
                            <li>Get a free phone number: <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/incoming" target="_blank" style="color: var(--info);">Phone Numbers ‚Üí Manage ‚Üí Buy a Number</a> (trial gives you one for free)</li>
                            <li>On trial accounts, you must <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/verified" target="_blank" style="color: var(--info);">verify your personal number</a> as a Verified Caller ID before sending</li>
                        </ol>
                    </details>
                    <div class="form-group">
                        <label class="form-label">Account SID</label>
                        <input type="text" class="form-input" id="wiz-twilio-sid"
                               placeholder="ACxxxxxxxxxx" value="${getSecretValue('TWILIO_ACCOUNT_SID')}"
                               title="Your Account SID. Found at the top of console.twilio.com. Starts with AC.">
                        <div class="form-hint">Starts with <code>AC</code> ‚Äî visible on your <a href="https://console.twilio.com/" target="_blank" style="color: var(--info);">Console dashboard</a></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Auth Token</label>
                        <input type="password" class="form-input" id="wiz-twilio-token"
                               placeholder="xxxxxxxxxx"
                               title="Your Auth Token. Found on console.twilio.com next to your Account SID. Click 'Show' to reveal it.">
                        <div class="form-hint">
                            Click "Show" next to Auth Token on console.twilio.com
                            ${appData?.secrets?.find(s => s.name === 'TWILIO_AUTH_TOKEN')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Twilio Phone Number</label>
                        <input type="text" class="form-input" id="wiz-twilio-from"
                               placeholder="+1234567890" value="${getSecretValue('TWILIO_FROM_NUMBER')}"
                               title="The Twilio number that sends SMS. Format: +1XXXXXXXXXX. Get one free with trial at Phone Numbers ‚Üí Buy a Number.">
                        <div class="form-hint">Format: <code>+1XXXXXXXXXX</code> ‚Äî your Twilio-assigned number</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Your Phone Number</label>
                        <input type="text" class="form-input" id="wiz-operator-sms"
                               placeholder="+1234567890" value="${getSecretValue('OPERATOR_SMS')}"
                               title="Your personal phone number where you want to receive alerts. Must be verified as a Caller ID during Twilio trial.">
                        <div class="form-hint">Where to send SMS alerts (must be <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/verified" target="_blank" style="color: var(--info);">verified</a> on trial accounts)</div>
                    </div>
                    <div style="margin-top: 1rem; padding: 0.5rem 0.75rem; border-radius: 6px; background: rgba(99,102,241,0.08); font-size: 0.82rem; color: var(--text-dim);">
                        üí° After setup, test this from the <a href="#integrations" onclick="switchTab('integrations'); return false;" style="color: var(--info); font-weight: 600;">Integrations</a> tab.
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    const result = {};
                    const sid = document.getElementById('wiz-twilio-sid').value;
                    if (sid) result.TWILIO_ACCOUNT_SID = sid;
                    const token = document.getElementById('wiz-twilio-token').value;
                    if (token) result.TWILIO_AUTH_TOKEN = token;
                    const from = document.getElementById('wiz-twilio-from').value;
                    if (from) result.TWILIO_FROM_NUMBER = from;
                    const sms = document.getElementById('wiz-operator-sms').value;
                    if (sms) result.OPERATOR_SMS = sms;
                    return result;
                }
            },
            {
                id: 'twitter',
                title: 'X',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üê¶ X/Twitter Integration</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1rem;">
                        <em>Optional</em> ‚Äî Post automated updates to X (Twitter). Free tier: 1,500 posts/month.
                    </p>
                    <details style="margin-bottom: 1.25rem;">
                        <summary style="cursor: pointer; color: var(--info); font-weight: 600;">üìñ Setup Guide (5 steps)</summary>
                        <ol style="color: var(--text-dim); line-height: 2; margin: 0.75rem 0 0 1.5rem; font-size: 0.9rem;">
                            <li>Sign up for a developer account at <a href="https://developer.x.com/en/portal/petition/essential/basic-info" target="_blank" style="color: var(--info);">developer.x.com</a></li>
                            <li>In the <a href="https://developer.x.com/en/portal/dashboard" target="_blank" style="color: var(--info);">Developer Portal</a>, create a <strong>Project</strong>, then create an <strong>App</strong> inside it</li>
                            <li>Go to your App ‚Üí <strong>Settings</strong> ‚Üí <strong>User authentication</strong> ‚Üí set App permissions to <strong>Read and Write</strong></li>
                            <li>Go to <strong>Keys and Tokens</strong> tab ‚Üí under "Consumer Keys" find your <strong>API Key</strong> and <strong>API Secret</strong> (regenerate if needed)</li>
                            <li>On the same page ‚Üí under "Authentication Tokens" ‚Üí click <strong>Generate</strong> for <strong>Access Token</strong> and <strong>Access Token Secret</strong></li>
                        </ol>
                    </details>
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="wiz-x-api-key" placeholder="xxxxxxxxxx"
                               title="Also called 'Consumer Key'. Found in Developer Portal ‚Üí App ‚Üí Keys and Tokens ‚Üí Consumer Keys.">
                        <div class="form-hint">Also called Consumer Key ${appData?.secrets?.find(s => s.name === 'X_API_KEY')?.set ? '<span style="color: var(--accent);">‚úì Already set</span>' : ''}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">API Secret</label>
                        <input type="password" class="form-input" id="wiz-x-api-secret" placeholder="xxxxxxxxxx"
                               title="Also called 'Consumer Secret'. Shown only once when generated ‚Äî save it immediately.">
                        <div class="form-hint">Also called Consumer Secret ‚Äî shown once at generation</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Access Token</label>
                        <input type="password" class="form-input" id="wiz-x-access-token" placeholder="xxxxxxxxxx"
                               title="Your account's access token. Found under 'Authentication Tokens' in the Keys and Tokens tab.">
                        <div class="form-hint">Under "Authentication Tokens" ‚Äî click Generate</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Access Secret</label>
                        <input type="password" class="form-input" id="wiz-x-access-secret" placeholder="xxxxxxxxxx"
                               title="Your account's access token secret. Shown only once when generated ‚Äî save it immediately.">
                        <div class="form-hint">Paired with Access Token ‚Äî shown once at generation</div>
                    </div>
                    <div style="margin-top: 1rem; padding: 0.5rem 0.75rem; border-radius: 6px; background: rgba(99,102,241,0.08); font-size: 0.82rem; color: var(--text-dim);">
                        üí° After setup, check status from the <a href="#integrations" onclick="switchTab('integrations'); return false;" style="color: var(--info); font-weight: 600;">Integrations</a> tab.
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    const result = {};
                    const apiKey = document.getElementById('wiz-x-api-key').value;
                    if (apiKey) result.X_API_KEY = apiKey;
                    const apiSecret = document.getElementById('wiz-x-api-secret').value;
                    if (apiSecret) result.X_API_SECRET = apiSecret;
                    const accessToken = document.getElementById('wiz-x-access-token').value;
                    if (accessToken) result.X_ACCESS_TOKEN = accessToken;
                    const accessSecret = document.getElementById('wiz-x-access-secret').value;
                    if (accessSecret) result.X_ACCESS_SECRET = accessSecret;
                    return result;
                }
            },
            {
                id: 'reddit',
                title: 'Reddit',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">ü§ñ Reddit Integration</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1rem;">
                        <em>Optional</em> ‚Äî Post automated updates to Reddit via a "script" app.
                    </p>
                    <details style="margin-bottom: 1.25rem;">
                        <summary style="cursor: pointer; color: var(--info); font-weight: 600;">üìñ Setup Guide (6 steps)</summary>
                        <ol style="color: var(--text-dim); line-height: 2; margin: 0.75rem 0 0 1.5rem; font-size: 0.9rem;">
                            <li>Go to <a href="https://www.reddit.com/prefs/apps" target="_blank" style="color: var(--info);">reddit.com/prefs/apps</a> (log in with the account that will post)</li>
                            <li>Scroll down and click <strong>"create another app‚Ä¶"</strong></li>
                            <li>Fill in: <strong>name</strong> (anything), select <strong>"script"</strong>, and set <strong>redirect URI</strong> to <code>http://localhost</code></li>
                            <li style="font-size: 0.85rem; color: var(--text-dim);"><em>‚ÑπÔ∏è The redirect URI is required by Reddit but never actually used for script apps ‚Äî any valid URL works</em></li>
                            <li>Click <strong>"create app"</strong> ‚Äî you'll see the <strong>Client ID</strong> (short string under the app name) and <strong>secret</strong> (labeled "secret")</li>
                            <li>Enter your Reddit login credentials below ‚Äî script apps authenticate directly with username/password</li>
                        </ol>
                    </details>
                    <div class="form-group">
                        <label class="form-label">Client ID</label>
                        <input type="text" class="form-input" id="wiz-reddit-client-id"
                               placeholder="xxxxxxxxxx" value="${getSecretValue('REDDIT_CLIENT_ID')}"
                               title="A short string shown directly under your app name on reddit.com/prefs/apps. It's NOT the app name itself.">
                        <div class="form-hint">Short string under your app name (not the app name itself)</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Client Secret</label>
                        <input type="password" class="form-input" id="wiz-reddit-client-secret" placeholder="xxxxxxxxxx"
                               title="Labeled 'secret' on your app page at reddit.com/prefs/apps.">
                        <div class="form-hint">Labeled "secret" on the app page ${appData?.secrets?.find(s => s.name === 'REDDIT_CLIENT_SECRET')?.set ? '<span style="color: var(--accent);">‚úì Already set</span>' : ''}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reddit Username</label>
                        <input type="text" class="form-input" id="wiz-reddit-username"
                               placeholder="your_username" value="${getSecretValue('REDDIT_USERNAME')}"
                               title="The Reddit account username that created the script app. Posts will be made from this account.">
                        <div class="form-hint">The account that will post ‚Äî must match the app owner</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reddit Password</label>
                        <input type="password" class="form-input" id="wiz-reddit-password" placeholder="xxxxxxxxxx"
                               title="The Reddit account password. Required for script app authentication. If you use 2FA, you may need an app-specific password.">
                        <div class="form-hint">If you use 2FA, you'll need an app-specific password ${appData?.secrets?.find(s => s.name === 'REDDIT_PASSWORD')?.set ? '<span style="color: var(--accent);">‚úì Already set</span>' : ''}</div>
                    </div>
                    <div style="margin-top: 1rem; padding: 0.5rem 0.75rem; border-radius: 6px; background: rgba(99,102,241,0.08); font-size: 0.82rem; color: var(--text-dim);">
                        üí° After setup, check status from the <a href="#integrations" onclick="switchTab('integrations'); return false;" style="color: var(--info); font-weight: 600;">Integrations</a> tab.
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    const result = {};
                    const clientId = document.getElementById('wiz-reddit-client-id').value;
                    if (clientId) result.REDDIT_CLIENT_ID = clientId;
                    const clientSecret = document.getElementById('wiz-reddit-client-secret').value;
                    if (clientSecret) result.REDDIT_CLIENT_SECRET = clientSecret;
                    const username = document.getElementById('wiz-reddit-username').value;
                    if (username) result.REDDIT_USERNAME = username;
                    const password = document.getElementById('wiz-reddit-password').value;
                    if (password) result.REDDIT_PASSWORD = password;
                    return result;
                }
            },
            {
                id: 'security',
                title: 'Security',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üîê Security & GitHub</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                        Security secrets and GitHub configuration.
                    </p>
                    
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--text-dim); font-size: 0.9rem;">üîë SECURITY SECRETS</h3>
                    <div class="form-group">
                        <label class="form-label">Renewal Secret *</label>
                        <input type="password" class="form-input" id="wiz-renewal-secret" 
                               placeholder="Enter a secure passphrase">
                        <div class="form-hint">
                            Code to extend the deadline
                            ${appData?.secrets?.find(s => s.name === 'RENEWAL_SECRET')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Release Secret</label>
                        <input type="password" class="form-input" id="wiz-release-secret" 
                               placeholder="Enter a different passphrase">
                        <div class="form-hint">
                            Code to trigger early disclosure (optional)
                            ${appData?.secrets?.find(s => s.name === 'RELEASE_SECRET')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Renewal Trigger Token</label>
                        <input type="password" class="form-input" id="wiz-renewal-trigger-token" 
                               placeholder="github_pat_xxxxxxxxxx">
                        <div class="form-hint">
                            Fine-grained GitHub PAT for one-click renewal from the public site (optional)
                            ${appData?.secrets?.find(s => s.name === 'RENEWAL_TRIGGER_TOKEN')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                        <details style="margin-top: 0.75rem;">
                            <summary style="cursor: pointer; color: var(--info); font-size: 0.85rem;">üìñ How to create a fine-grained PAT</summary>
                            <div style="color: var(--text-dim); line-height: 1.8; margin: 0.75rem 0 0 0; font-size: 0.85rem; padding: 0.75rem; background: var(--bg-input); border-radius: 6px;">
                                <ol style="margin: 0 0 0 1.25rem; padding: 0;">
                                    <li>Go to <a href="https://github.com/settings/tokens?type=beta" target="_blank" style="color: var(--info);">GitHub ‚Üí Settings ‚Üí Fine-grained tokens</a></li>
                                    <li>Click <strong>"Generate new token"</strong></li>
                                    <li>Set <strong>Token name</strong>: <code>continuity-renewal</code></li>
                                    <li>Set <strong>Expiration</strong>: 90 days (or custom)</li>
                                    <li>Under <strong>Repository access</strong>, select <em>"Only select repositories"</em> and pick your continuity repo</li>
                                    <li>Under <strong>Permissions ‚Üí Actions</strong>, set to <strong>Read and write</strong> (needed to trigger workflows)</li>
                                    <li>Click <strong>"Generate token"</strong> and paste the <code>github_pat_...</code> value above</li>
                                </ol>
                                <p style="margin: 0.75rem 0 0 0;">
                                    ‚ö†Ô∏è This token allows triggering the renewal workflow from the public site's "Renew" button.
                                    Only grant the minimum permissions needed.
                                </p>
                            </div>
                        </details>
                    </div>
                    
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--text-dim); font-size: 0.9rem;">üêô GITHUB CONFIGURATION</h3>
                    <div class="form-group">
                        <label class="form-label">GitHub Repository</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="wiz-github-repo" 
                                   placeholder="owner/repo" value="${getSecretValue('GITHUB_REPOSITORY')}" style="flex: 1;">
                            <button type="button" class="btn" onclick="autoDetectGitHub()" title="Detect from git remote">üîç Detect</button>
                        </div>
                        <div class="form-hint">Auto-detected from git remote if available</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">GitHub Token</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="password" class="form-input" id="wiz-github-token" 
                                   placeholder="ghp_xxxxxxxxxx or auto-detect" style="flex: 1;">
                            <button type="button" class="btn" onclick="autoDetectGitHub()" title="Get from gh CLI">üîë Get from gh</button>
                        </div>
                        <div class="form-hint">
                            Auto-detect from <code>gh auth token</code> or <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--info);">generate manually</a>
                            ${appData?.secrets?.find(s => s.name === 'GITHUB_TOKEN')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    const result = {};
                    const renewal = document.getElementById('wiz-renewal-secret').value;
                    if (renewal) result.RENEWAL_SECRET = renewal;
                    const release = document.getElementById('wiz-release-secret').value;
                    if (release) result.RELEASE_SECRET = release;
                    const triggerToken = document.getElementById('wiz-renewal-trigger-token').value;
                    if (triggerToken) result.RENEWAL_TRIGGER_TOKEN = triggerToken;
                    const github = document.getElementById('wiz-github-token').value;
                    if (github) result.GITHUB_TOKEN = github;
                    const repo = document.getElementById('wiz-github-repo').value;
                    if (repo) result.GITHUB_REPOSITORY = repo;
                    return result;
                }
            },
            {
                id: 'archive',
                title: 'Archive',
                content: () => {
                    const archiveEnabled = getSecretValue('ARCHIVE_ENABLED') === 'true';
                    const archiveUrl = getSecretValue('ARCHIVE_URL');

                    return `
                        <h2 style="margin-bottom: 1rem;">üì¶ Internet Archive</h2>
                        <p style="color: var(--text-dim); margin-bottom: 0.5rem;">
                            <em>Optional</em> ‚Äî Automatically save snapshots to <a href="https://archive.org" target="_blank" style="color: var(--info);">archive.org</a>
                        </p>
                        <p style="color: var(--text-dim); margin-bottom: 1.5rem; font-size: 0.9rem;">
                            Creates an immutable, third-party record of your published site, 
                            providing resilience even if GitHub Pages goes down.
                        </p>
                        
                        <div class="form-group">
                            <label class="form-label">Enable Auto-Archive</label>
                            <select class="form-input" id="wiz-archive-enabled" style="width: auto; min-width: 200px;">
                                <option value="false" ${!archiveEnabled ? 'selected' : ''}>‚ùå Disabled</option>
                                <option value="true" ${archiveEnabled ? 'selected' : ''}>‚úÖ Enabled</option>
                            </select>
                            <div class="form-hint">Archive to Wayback Machine after each site publish</div>
                        </div>
                        
                        <div class="form-group" id="archive-url-group" style="${archiveEnabled ? '' : 'opacity: 0.5;'}">
                            <label class="form-label">Custom Archive URL</label>
                            <input type="text" class="form-input" id="wiz-archive-url" 
                                   placeholder="Leave empty for GitHub Pages auto-detect"
                                   value="${archiveUrl || ''}">
                            <div class="form-hint">
                                For Docker + Cloudflare deployments. Leave empty to use GitHub Pages URL.
                            </div>
                        </div>
                        
                        <details style="margin-top: 1.5rem;">
                            <summary style="cursor: pointer; color: var(--info);">‚ÑπÔ∏è Why archive?</summary>
                            <ul style="color: var(--text-dim); line-height: 1.8; margin: 1rem 0 0 1.5rem; font-size: 0.9rem;">
                                <li><strong>Resilience:</strong> Independent backup of your public site</li>
                                <li><strong>Proof:</strong> Timestamped snapshots prove content existed at a point in time</li>
                                <li><strong>Free:</strong> No API key needed (3 archives/minute)</li>
                                <li><strong>Optional:</strong> Can be triggered manually from Command Center</li>
                            </ul>
                        </details>
                    `;
                },
                validate: () => true,
                collect: () => {
                    const result = {};
                    const enabled = document.getElementById('wiz-archive-enabled').value;
                    result.ARCHIVE_ENABLED = enabled;
                    const url = document.getElementById('wiz-archive-url').value;
                    if (url) result.ARCHIVE_URL = url;
                    return result;
                }
            },
            {
                id: 'push',
                title: 'Push',
                content: () => {
                    const ghTool = appData?.tools?.find(t => t.name === 'gh');
                    const gitTool = appData?.tools?.find(t => t.name === 'git');
                    const ghOk = ghTool?.installed && ghTool?.authenticated;
                    const gitOk = gitTool?.installed;

                    return `
                        <h2 style="margin-bottom: 1rem;">üöÄ Push & Sync</h2>
                        <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                            Save configuration, push GitHub secrets, and sync your repo.
                        </p>

                        <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                            <!-- gh CLI status -->
                            ${ghOk ? `
                                <div class="alert success">
                                    ‚úÖ <strong>gh CLI authenticated</strong> ‚Äî Secrets will be pushed to GitHub.
                                </div>
                            ` : `
                                <div class="alert warning">
                                    ‚ö†Ô∏è <strong>gh CLI ${!ghTool?.installed ? 'not installed' : 'not authenticated'}</strong><br>
                                    <span style="font-size: 0.85rem; color: var(--text-dim);">
                                        Secrets will still be saved to <code>.env</code> locally.
                                    </span>
                                    <div style="margin-top: 0.75rem;">
                                        ${!ghTool?.installed
                            ? '<button class="btn" onclick="installGh()" style="margin-right: 0.5rem;">üì¶ Install gh CLI</button>'
                            : '<button class="btn" onclick="alert(\'Run: gh auth login\\n\\nIn your terminal, then refresh this page.\')" style="margin-right: 0.5rem;">üîë How to authenticate</button>'}
                                        <button class="btn" onclick="loadStatus().then(() => renderWizard())">üîÑ Refresh status</button>
                                    </div>
                                </div>
                            `}

                            <!-- Git sync option -->
                            <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-hover);">
                                <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
                                    <input type="checkbox" id="wiz-git-sync" ${gitOk ? 'checked' : 'disabled'}
                                           style="margin-top: 3px;">
                                    <div>
                                        <strong>üîÑ Git sync after push</strong>
                                        <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">
                                            Commit all changes and push to remote ‚Äî keeps your repo up to date
                                            with the latest config, state, and settings.
                                        </div>
                                        ${!gitOk ? '<div style="color: var(--warning); font-size: 0.8rem; margin-top: 0.25rem;">‚ö†Ô∏è git not detected</div>' : ''}
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div id="wizard-push-status"></div>
                    `;
                },
                validate: () => true
            },
            {
                id: 'complete',
                title: 'Done',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üéâ Setup Complete!</h2>
                    <p style="color: var(--text-dim); line-height: 1.6; margin-bottom: 1rem;">
                        Your Continuity Orchestrator is configured. Next steps:
                    </p>
                    <ul style="color: var(--text-dim); line-height: 1.8; margin-left: 1.5rem; margin-bottom: 1.5rem;">
                        <li>üìä Check the <strong>Dashboard</strong> for system status</li>
                        <li>‚ö° Run a <strong>Dry Run</strong> to test the tick cycle</li>
                        <li>üîê Configure additional secrets in the <strong>Secrets</strong> tab</li>
                    </ul>
                    <div class="actions">
                        <button class="btn primary" onclick="switchTab('dashboard')">Go to Dashboard ‚Üí</button>
                    </div>
                `,
                validate: () => true
            }
        ];

        let currentWizardStep = 0;
        let wizardData = {};
        let wizardDirty = false;

        function getSecretValue(name) {
            // First check envData (values from .env file)
            if (envData && envData[name]) {
                return envData[name];
            }
            return '';
        }

        // Auto-detect GitHub token and repo from gh CLI / git remote
        async function autoDetectGitHub() {
            try {
                const response = await fetch('/api/gh/auto');
                const data = await response.json();

                let updated = [];

                if (data.token) {
                    const tokenInput = document.getElementById('wiz-github-token');
                    if (tokenInput && !tokenInput.value) {
                        tokenInput.value = data.token;
                        updated.push('token');
                    }
                }

                if (data.repo) {
                    const repoInput = document.getElementById('wiz-github-repo');
                    if (repoInput && !repoInput.value) {
                        repoInput.value = data.repo;
                        updated.push('repository');
                    }
                }

                if (updated.length > 0) {
                    alert(`‚úÖ Auto-detected: ${updated.join(' and ')}`);
                } else if (!data.token && !data.repo) {
                    alert('‚ö†Ô∏è Could not auto-detect. Make sure gh CLI is authenticated (gh auth login) and you have a git remote set.');
                } else {
                    alert('‚ÑπÔ∏è Fields already filled - no changes made.');
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Fill a specific secret from gh CLI (for Secrets tab)
        async function fillSecretFromGh(secretName) {
            try {
                const response = await fetch('/api/gh/auto');
                const data = await response.json();

                const input = document.getElementById(`secret-${secretName}`);
                if (!input) return;

                if (secretName === 'GITHUB_TOKEN' && data.token) {
                    input.value = data.token;
                    alert('‚úÖ Token retrieved from gh CLI');
                } else if (secretName === 'GITHUB_REPOSITORY' && data.repo) {
                    input.value = data.repo;
                    alert('‚úÖ Repository detected from git remote');
                } else {
                    alert('‚ö†Ô∏è Could not auto-detect. Make sure gh CLI is authenticated (gh auth login) and you have a git remote set.');
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Install gh CLI - opens terminal for user to enter sudo password
        async function installGh() {
            try {
                const response = await fetch('/api/gh/install', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.message}\n\nAfter installation completes, refresh this page.`);
                } else if (data.fallback || data.command) {
                    // Show command in modal for manual copy
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;';
                    modal.innerHTML = `
                        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:2rem;max-width:700px;width:90%;max-height:80vh;overflow:auto;">
                            <h2 style="margin-bottom:1rem;">üì¶ Install GitHub CLI</h2>
                            <p style="color:var(--text-dim);margin-bottom:1rem;">${data.message}</p>
                            <pre style="background:var(--bg-input);padding:1rem;border-radius:8px;overflow-x:auto;font-size:0.8rem;line-height:1.4;white-space:pre-wrap;">${data.command}</pre>
                            <div style="display:flex;gap:1rem;margin-top:1.5rem;">
                                <button class="btn primary" onclick="navigator.clipboard.writeText(this.dataset.cmd);this.textContent='‚úì Copied!'" data-cmd="${data.command.replace(/"/g, '&quot;')}">üìã Copy</button>
                                <button class="btn" onclick="this.closest('div').parentElement.remove()">Close</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
                } else {
                    alert(`‚ùå ${data.message}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // ========================================
        // DEADLINE MANAGEMENT
        // ========================================

        async function renewDeadline(hours) {
            hours = parseInt(hours);
            if (!hours || hours < 1) {
                alert('Please enter a valid number of hours (1+).');
                return;
            }
            const statusDiv = document.getElementById('deadline-status');
            if (statusDiv) statusDiv.innerHTML = '<span style="color: var(--info);">‚è≥ Renewing...</span>';

            try {
                const response = await fetch('/api/renew', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hours }),
                });
                const data = await response.json();
                if (data.success) {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--success);">‚úÖ Renewed for ${hours} hours</span>`;
                    loadStatus();
                    // Git sync if checkbox is checked
                    const syncCb = document.getElementById('deadline-git-sync');
                    if (syncCb && syncCb.checked) {
                        if (statusDiv) statusDiv.innerHTML += '<br><span style="color: var(--info);">üîÑ Syncing to Git...</span>';
                        try {
                            const syncResp = await fetch('/api/git/sync', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ message: `chore: renew deadline +${hours}h` }),
                            });
                            const syncData = await syncResp.json();
                            if (syncData.success) {
                                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ ${syncData.message}</span>`;
                            } else {
                                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--warning);">‚ö†Ô∏è ${syncData.error || 'Git sync failed'}</span>`;
                            }
                        } catch (syncErr) {
                            if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--warning);">‚ö†Ô∏è Git sync: ${syncErr.message}</span>`;
                        }
                    }
                } else {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.error || 'Failed'}</span>`;
                }
            } catch (error) {
                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå ${error.message}</span>`;
            }
        }

        async function setManualDeadline() {
            const input = document.getElementById('manual-deadline');
            if (!input || !input.value) {
                alert('Please select a date and time.');
                return;
            }
            const target = new Date(input.value);
            const now = new Date();
            const hoursFromNow = (target - now) / (1000 * 60 * 60);
            if (hoursFromNow <= 0) {
                alert('Deadline must be in the future.');
                return;
            }
            await setDeadlineHours(hoursFromNow, target.toLocaleString());
        }

        async function setTestDeadline(minutes) {
            const hours = minutes / 60;
            await setDeadlineHours(hours, `${minutes} minutes from now`);
        }

        async function setDeadlineHours(hours, label) {
            const statusDiv = document.getElementById('deadline-status');
            if (statusDiv) statusDiv.innerHTML = '<span style="color: var(--info);">‚è≥ Setting deadline...</span>';

            try {
                const response = await fetch('/api/state/set-deadline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hours }),
                });
                const data = await response.json();
                if (data.success) {
                    const desc = label || `${Math.round(hours * 10) / 10} hours from now`;
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--success);">‚úÖ Deadline set: ${desc}</span>`;
                    loadStatus();
                    // Git sync if checkbox is checked
                    const syncCb = document.getElementById('deadline-git-sync');
                    if (syncCb && syncCb.checked) {
                        if (statusDiv) statusDiv.innerHTML += '<br><span style="color: var(--info);">üîÑ Syncing to Git...</span>';
                        try {
                            const syncResp = await fetch('/api/git/sync', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ message: `chore: set deadline ${desc}` }),
                            });
                            const syncData = await syncResp.json();
                            if (syncData.success) {
                                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ ${syncData.message}</span>`;
                            } else {
                                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--warning);">‚ö†Ô∏è ${syncData.error || 'Git sync failed'}</span>`;
                            }
                        } catch (syncErr) {
                            if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--warning);">‚ö†Ô∏è Git sync: ${syncErr.message}</span>`;
                        }
                    }
                } else {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.error || 'Failed'}</span>`;
                }
            } catch (error) {
                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå ${error.message}</span>`;
            }
        }
        // ========================================
        // TRIGGER / RETURN STATE CONTROLS
        // ========================================

        // Helper: call /api/run with a command name from the allowlist
        async function apiRun(command) {
            const resp = await fetch('/api/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command }),
            });
            return resp.json();
        }

        async function triggerRelease() {
            const typed = prompt(
                'üíÄ TRIGGER FULL DISCLOSURE?\n\n' +
                '‚ö†Ô∏è  THIS IS IRREVERSIBLE IN PRODUCTION.\n\n' +
                'This will:\n' +
                '‚Ä¢ Set escalation state to FULL immediately\n' +
                '‚Ä¢ Set deadline to past (overdue)\n' +
                '‚Ä¢ On next tick: send emails, SMS, tweets, posts\n' +
                '‚Ä¢ On next tick: build & deploy disclosure site\n\n' +
                'Type FULL to proceed:'
            );
            if (typed !== 'FULL') {
                if (typed !== null) alert('‚ùå Cancelled ‚Äî text did not match.');
                return;
            }

            const statusDiv = document.getElementById('trigger-status');
            if (statusDiv) statusDiv.innerHTML = '<span style="color: var(--danger);">üíÄ Triggering FULL disclosure...</span>';

            try {
                const triggerData = await apiRun('trigger-release-full');

                if (!triggerData.success) {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Trigger failed: ${triggerData.error || 'Unknown error'}</span>`;
                    return;
                }

                if (statusDiv) statusDiv.innerHTML = '<span style="color: var(--warning);">‚úÖ State set to FULL</span>';
                await _postTriggerSteps(statusDiv, 'FULL disclosure');
            } catch (error) {
                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Error: ${error.message}</span>`;
            }
        }

        async function triggerShadow() {
            const delay = document.getElementById('shadow-delay')?.value || '60';
            const delayLabel = delay === '0' ? 'no delay (immediate)' : `${delay} minute delay`;

            const confirmation = prompt(
                `üëª ACTIVATE SHADOW MODE?\n\n` +
                `This is the same as entering RELEASE_SECRET on the public site.\n\n` +
                `‚Ä¢ Stealth trigger ‚Äî appears as a normal renewal\n` +
                `‚Ä¢ Delay: ${delayLabel}\n` +
                `‚Ä¢ Site rebuilds showing "DELAYED" status\n` +
                `‚Ä¢ After delay: next tick executes FULL disclosure\n` +
                `‚Ä¢ Cancelable by renewal during the delay window\n\n` +
                `Type SHADOW to confirm:`
            );
            if (confirmation !== 'SHADOW') return;

            const statusDiv = document.getElementById('trigger-status');
            if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--warning);">üëª Activating shadow mode (${delayLabel})...</span>`;

            try {
                const cmdName = `trigger-shadow-${delay}`;
                const triggerData = await apiRun(cmdName);

                if (!triggerData.success) {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Shadow trigger failed: ${triggerData.error || 'Unknown error'}</span>`;
                    return;
                }

                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--warning);">‚úÖ Shadow mode active ‚Äî ${delayLabel}</span>`;
                await _postTriggerSteps(statusDiv, 'shadow mode');
            } catch (error) {
                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Error: ${error.message}</span>`;
            }
        }

        // Shared post-trigger steps: auto-tick + build + git sync + deploy
        async function _postTriggerSteps(statusDiv, label) {
            // Auto-tick
            if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--info);">üîÑ Running tick...</span>`;
            const tickData = await apiRun('tick');
            if (tickData.success) {
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ Tick completed</span>`;
            } else {
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--danger);">‚ö†Ô∏è Tick error: ${tickData.error || 'Unknown'}</span>`;
            }

            // Build site (fire-and-forget)
            apiRun('build-site').catch(() => { });
            if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--text-dim);">üèóÔ∏è Site rebuild kicked off (background)</span>`;

            // Git sync
            if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--info);">üì§ Syncing to git...</span>`;
            const syncResp = await fetch('/api/git/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `trigger: ${label} via admin panel` }),
            });
            const syncData = await syncResp.json();
            if (syncData.success) {
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ Git synced</span>`;
                // Trigger deploy-site workflow (fire-and-forget)
                apiRun('deploy-site').catch(() => { });
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--text-dim);">üöÄ Deploy pipeline triggered (background)</span>`;
            } else {
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--danger);">‚ö†Ô∏è Git sync failed: ${syncData.steps?.find(s => !s.ok)?.output || 'Unknown'}</span>`;
            }

            // Single refresh after short delay
            if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ All steps completed</span>`;
            setTimeout(() => loadStatus(), 3000);
        }

        async function returnToOK() {
            if (!confirm(
                'üîô RETURN TO OK?\n\n' +
                'This will:\n' +
                '‚Ä¢ Reset escalation state to OK\n' +
                '‚Ä¢ Cancel any pending release\n' +
                '‚Ä¢ Create a new 48h deadline\n' +
                '‚Ä¢ Clear executed actions\n\n' +
                'The disclosure site may still be live on GitHub Pages\n' +
                'until the next deploy overwrites it.\n\n' +
                'Continue?'
            )) return;

            const statusDiv = document.getElementById('trigger-status');
            if (statusDiv) statusDiv.innerHTML = '<span style="color: var(--info);">üîô Resetting to OK...</span>';

            try {
                // Reset state via /api/run
                const resetData = await apiRun('reset');

                if (!resetData.success) {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Reset failed: ${resetData.error || 'Unknown'}</span>`;
                    return;
                }

                if (statusDiv) statusDiv.innerHTML = '<span style="color: var(--accent);">‚úÖ State reset to OK</span>';

                // Git sync + build + deploy
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--info);">üì§ Syncing to git...</span>`;
                const syncResp = await fetch('/api/git/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'chore: return to OK via admin panel' }),
                });
                const syncData = await syncResp.json();
                if (syncData.success) {
                    if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ Git synced</span>`;
                    // Rebuild site + trigger deploy (fire-and-forget)
                    apiRun('build-site').catch(() => { });
                    apiRun('deploy-site').catch(() => { });
                    if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--text-dim);">üèóÔ∏è Site rebuild + üöÄ deploy triggered (background)</span>`;
                } else {
                    if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--danger);">‚ö†Ô∏è Git sync failed</span>`;
                }

                // Single refresh after short delay
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ All steps completed</span>`;
                setTimeout(() => loadStatus(), 3000);

            } catch (error) {
                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Error: ${error.message}</span>`;
            }
        }

        // Reset timer (keeps secrets, resets state to OK with new deadline)
        async function resetState() {
            if (!confirm('Reset timer?\n\nThis will:\n‚Ä¢ Set stage back to OK\n‚Ä¢ Create a new 48h deadline\n‚Ä¢ Reset renewal count to 0\n\nYour secrets will NOT be deleted.')) {
                return;
            }

            try {
                const response = await fetch('/api/state/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Timer reset! New 48h deadline active.');
                    loadStatus();
                } else {
                    alert(`‚ùå Reset failed: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Factory reset (calls CLI: reset --full)
        async function factoryReset() {
            if (!confirm('‚ö†Ô∏è Factory Reset?\n\nThis will:\n‚Ä¢ Create fresh state file\n‚Ä¢ Clear audit log\n‚Ä¢ Reset to OK with new 48h deadline\n\nExisting state will be backed up.\n\nAre you sure?')) {
                return;
            }

            try {
                const response = await fetch('/api/state/factory-reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backup: true, hours: 48 }),
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Factory reset complete!\n\n' + (data.output || ''));
                    loadStatus();
                } else {
                    alert(`‚ùå Factory reset failed: ${data.error || data.output}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Required steps that must be completed before optional ones can be accessed
        const REQUIRED_STEP_COUNT = 5; // welcome, deploy, project, deadline (conditional), security

        // Check if required steps have been satisfied (have data)
        function areRequiredStepsSatisfied() {
            // Check for minimum required values from envData (already configured)
            const hasProject = envData.PROJECT_NAME && envData.PROJECT_NAME.length > 0;
            const hasRenewal = envData.RENEWAL_SECRET && envData.RENEWAL_SECRET.length > 0;
            const hasGithub = envData.GITHUB_REPOSITORY && envData.GITHUB_REPOSITORY.length > 0;

            // Also check wizardData (entered this session)
            const wizHasProject = wizardData.PROJECT_NAME && wizardData.PROJECT_NAME.length > 0;
            const wizHasRenewal = wizardData.RENEWAL_SECRET && wizardData.RENEWAL_SECRET.length > 0;

            // If we have project AND some security value, consider it satisfied
            return (hasProject || wizHasProject) && (hasRenewal || wizHasRenewal || hasGithub);
        }

        // Check if a step is optional (can be skipped)
        function isOptionalStep(stepIndex) {
            const step = wizardSteps[stepIndex];
            if (!step) return false;
            // Optional adapter steps
            if (['email', 'sms', 'twitter', 'reddit'].includes(step.id)) return true;
            // Deadline step is optional when not in countdown mode
            if (step.id === 'deadline' && step.skip && step.skip()) return true;
            return false;
        }

        // Get visible wizard steps (skip steps whose skip() returns true)
        function getVisibleSteps() {
            return wizardSteps.filter(s => !s.skip || !s.skip());
        }

        // Check if we can skip ahead (some configuration already exists)
        function canSkipAhead() {
            // If any values exist in envData, allow free navigation
            const hasAnyConfig = Object.keys(envData).some(key =>
                envData[key] && envData[key].length > 0 &&
                !['ADAPTER_MOCK_MODE'].includes(key) // Exclude defaults
            );
            return hasAnyConfig;
        }

        // Navigate to a specific step (if allowed)
        function goToStep(stepIndex) {
            // Collect current step data first
            const currentStep = wizardSteps[currentWizardStep];
            if (currentStep?.collect) {
                Object.assign(wizardData, currentStep.collect());
            }

            // Can always go back
            if (stepIndex < currentWizardStep) {
                currentWizardStep = stepIndex;
                renderWizard();
                return;
            }

            // If user already has config, allow free navigation
            if (canSkipAhead()) {
                currentWizardStep = stepIndex;
                renderWizard();
                return;
            }

            // Otherwise, stricter rules:
            // - Required steps: can only go forward one at a time
            // - Optional steps: can jump if required are satisfied
            if (stepIndex < REQUIRED_STEP_COUNT) {
                if (stepIndex <= currentWizardStep + 1) {
                    currentWizardStep = stepIndex;
                    renderWizard();
                }
            } else if (areRequiredStepsSatisfied()) {
                currentWizardStep = stepIndex;
                renderWizard();
            }
        }

        function renderWizard() {
            const requiredSatisfied = areRequiredStepsSatisfied();
            const skipAllowed = canSkipAhead();
            const visibleSteps = getVisibleSteps();

            // Auto-skip past hidden steps
            while (currentWizardStep < wizardSteps.length &&
                wizardSteps[currentWizardStep].skip &&
                wizardSteps[currentWizardStep].skip()) {
                currentWizardStep++;
            }

            // Render step indicators (visible steps only)
            const stepsHtml = visibleSteps.map((step, vIdx) => {
                const realIdx = wizardSteps.indexOf(step);
                let cls = '';
                let clickable = false;

                if (realIdx < currentWizardStep) {
                    cls = 'completed';
                    clickable = true;
                } else if (realIdx === currentWizardStep) {
                    cls = 'active';
                } else {
                    if (skipAllowed) {
                        clickable = true;
                        cls = isOptionalStep(realIdx) ? 'optional' : 'skippable';
                    } else if (realIdx >= REQUIRED_STEP_COUNT && requiredSatisfied) {
                        clickable = true;
                        cls = 'optional';
                    }
                }

                const optionalBadge = isOptionalStep(realIdx) ? '<small style="opacity: 0.6; font-size: 0.7rem;"> (opt)</small>' : '';
                const cursor = clickable ? 'pointer' : 'default';
                const onclick = clickable ? `onclick="goToStep(${realIdx})"` : '';

                return `
                    <div class="wizard-step ${cls}" style="cursor: ${cursor};" ${onclick}>
                        <span class="wizard-step-num">${realIdx < currentWizardStep ? '‚úì' : vIdx + 1}</span>
                        <span>${step.title}${optionalBadge}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('wizard-steps').innerHTML = stepsHtml;

            // Render current step content
            const step = wizardSteps[currentWizardStep];
            const wizardBody = document.getElementById('wizard-body');
            wizardBody.innerHTML = step.content();

            // Snapshot initial field values so we can detect real changes
            const initialValues = {};
            wizardBody.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.id || el.name) initialValues[el.id || el.name] = el.value;
            });
            wizardBody.addEventListener('input', () => {
                const fields = wizardBody.querySelectorAll('input, textarea, select');
                wizardDirty = Array.from(fields).some(el => {
                    const key = el.id || el.name;
                    return key && el.value !== (initialValues[key] ?? '');
                });
            });
            wizardBody.addEventListener('change', () => {
                const fields = wizardBody.querySelectorAll('input, textarea, select');
                wizardDirty = Array.from(fields).some(el => {
                    const key = el.id || el.name;
                    return key && el.value !== (initialValues[key] ?? '');
                });
            });

            // Update nav buttons
            document.getElementById('wizard-prev').style.visibility = currentWizardStep === 0 ? 'hidden' : 'visible';

            const nextBtn = document.getElementById('wizard-next');
            const finishBtn = document.getElementById('wizard-finish');

            // Show Finish button on optional steps (allows skipping to Push)
            const isOnOptionalStep = isOptionalStep(currentWizardStep);
            finishBtn.style.display = isOnOptionalStep ? '' : 'none';

            if (currentWizardStep === wizardSteps.length - 1) {
                // Complete step
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'none';
            } else if (currentWizardStep === wizardSteps.length - 2) {
                // Push step
                nextBtn.textContent = 'üöÄ Push & Finish';
                finishBtn.style.display = 'none';
            } else {
                nextBtn.style.display = '';
                nextBtn.textContent = 'Next ‚Üí';
            }

            // Update URL hash with current wizard step ID
            history.replaceState(null, '', `#wizard/${step.id}`);
        }

        // Skip to Push step (called from Finish button)
        async function wizardFinish() {
            // Collect current step data first
            const step = wizardSteps[currentWizardStep];
            if (step.collect) {
                Object.assign(wizardData, step.collect());
            }

            // Find the push step index
            const pushIndex = wizardSteps.findIndex(s => s.id === 'push');
            if (pushIndex !== -1) {
                currentWizardStep = pushIndex;
                renderWizard();
            }
        }

        function wizardPrev() {
            if (currentWizardStep > 0) {
                currentWizardStep--;
                renderWizard();
            }
        }

        async function wizardNext() {
            const step = wizardSteps[currentWizardStep];

            // Validate current step
            if (step.validate && !step.validate()) {
                return;
            }

            // Collect data from current step
            if (step.collect) {
                Object.assign(wizardData, step.collect());
            }

            // If this is the push step, actually push
            if (step.id === 'push') {
                await pushWizardSecrets();
            }

            // Move to next visible step
            if (currentWizardStep < wizardSteps.length - 1) {
                currentWizardStep++;
                // Skip hidden steps
                while (currentWizardStep < wizardSteps.length - 1 &&
                    wizardSteps[currentWizardStep].skip &&
                    wizardSteps[currentWizardStep].skip()) {
                    currentWizardStep++;
                }
                renderWizard();
            }
        }

        async function pushWizardSecrets() {
            const statusDiv = document.getElementById('wizard-push-status');
            if (!statusDiv) {
                console.error('wizard-push-status element not found');
                return;
            }

            // Capture options before the DOM gets replaced
            const gitSyncChecked = document.getElementById('wiz-git-sync')?.checked ?? false;

            // Separate non-secret wizard data from actual secrets
            const deadlineHours = wizardData.DEADLINE_HOURS || 48;
            const deployMode = wizardData.DEPLOY_MODE;
            const operatingMode = wizardData.MODE;
            const secrets = { ...wizardData };
            delete secrets.DEADLINE_HOURS;
            delete secrets.DEPLOY_MODE;
            delete secrets.deployMode;
            delete secrets.MODE;
            console.log('Wizard secrets to push:', Object.keys(secrets));

            if (Object.keys(secrets).length === 0) {
                statusDiv.innerHTML = '<div class="alert info">No new secrets to push.</div>';
            } else {
                statusDiv.innerHTML = `<div class="loading">Pushing ${Object.keys(secrets).length} secrets...</div>`;

                try {
                    console.log('Sending secrets to /api/secrets/push...');
                    const response = await fetch('/api/secrets/push', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ secrets, save_to_env: true }),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('Push response:', data);

                    if (data.error) {
                        statusDiv.innerHTML = `<div class="alert error">‚ùå ${data.error}</div>`;
                        console.error('Push error:', data.error);
                        return;
                    }

                    let html = '<h4 style="margin-bottom: 0.5rem;">Results:</h4>';
                    let successCount = 0;
                    let failCount = 0;

                    // Show env save status
                    if (data.env_saved) {
                        html += '<div style="color: var(--accent); margin: 0.25rem 0;">üíæ Saved to .env</div>';
                    }

                    for (const result of (data.results || [])) {
                        if (result.success) {
                            html += `<div style="color: var(--accent); margin: 0.25rem 0;">‚úÖ ${result.name}</div>`;
                            successCount++;
                        } else {
                            html += `<div style="color: var(--danger); margin: 0.25rem 0;">‚ùå ${result.name}: ${result.error}</div>`;
                            failCount++;
                        }
                    }

                    if (failCount === 0) {
                        html = `<div class="alert success">‚úÖ All ${successCount} secrets pushed successfully!</div>` + html;
                    }

                    statusDiv.innerHTML = html;
                    console.log(`Push complete: ${successCount} success, ${failCount} failed`);
                } catch (error) {
                    console.error('Push exception:', error);
                    statusDiv.innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
                }
            }

            // Set deadline if in countdown mode
            if (deadlineHours && (!operatingMode || operatingMode === 'renewable_countdown')) {
                try {
                    const dlResponse = await fetch('/api/state/set-deadline', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hours: deadlineHours }),
                    });
                    const dlData = await dlResponse.json();
                    if (dlData.success) {
                        statusDiv.innerHTML += `<div style="color: var(--accent); margin: 0.25rem 0;">‚è∞ Deadline set to ${deadlineHours}h from now</div>`;
                    } else {
                        statusDiv.innerHTML += `<div style="color: var(--warning); margin: 0.25rem 0;">‚ö†Ô∏è Deadline: ${dlData.error || 'could not set (run a tick first)'}</div>`;
                    }
                } catch (e) {
                    console.warn('Could not set deadline:', e);
                    statusDiv.innerHTML += `<div style="color: var(--warning); margin: 0.25rem 0;">‚ö†Ô∏è Could not set deadline ‚Äî run a tick first</div>`;
                }
            }

            // Git sync if requested
            if (gitSyncChecked) {
                statusDiv.innerHTML += '<div style="color: var(--info); margin: 0.5rem 0;">üîÑ Syncing to Git...</div>';
                try {
                    const syncResponse = await fetch('/api/git/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: 'chore: setup wizard configuration sync' }),
                    });
                    const syncData = await syncResponse.json();
                    if (syncData.success) {
                        statusDiv.innerHTML += `<div style="color: var(--accent); margin: 0.25rem 0;">üîÑ ${syncData.message}</div>`;
                    } else {
                        statusDiv.innerHTML += `<div style="color: var(--warning); margin: 0.25rem 0;">‚ö†Ô∏è Git sync: ${syncData.error || 'failed'}</div>`;
                    }
                } catch (e) {
                    console.warn('Git sync failed:', e);
                    statusDiv.innerHTML += `<div style="color: var(--warning); margin: 0.25rem 0;">‚ö†Ô∏è Git sync failed ‚Äî ${e.message}</div>`;
                }
            }

            // Refresh status
            loadStatus();

            // Wizard data has been saved ‚Äî no longer dirty
            wizardDirty = false;
        }

        // Initial load ‚Äî await so envData is ready before tab switch
        (async () => {
            await loadStatus();

            // Restore tab from URL hash (supports wizard/stepId)
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                const tabId = hash.split('/')[0];
                if (document.getElementById(`tab-${tabId}`)) {
                    switchTab(hash);
                }
            }
        })();

        // Handle back/forward
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                const tabId = hash.split('/')[0];
                if (document.getElementById(`tab-${tabId}`)) {
                    switchTab(hash);
                }
            }
        });

        // Auto-refresh every 30 seconds
        setInterval(loadStatus, 30000);
    </script>

    <!-- Google Translate -->
    <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</body>

</html>