        // Load status
        async function loadStatus() {
            const bar = document.getElementById('refresh-bar');
            bar?.classList.add('active');
            try {
                // Load both status and env values
                const [statusRes, envRes] = await Promise.all([
                    fetch('/api/status'),
                    fetch('/api/env/read'),
                ]);
                appData = await statusRes.json();
                const envResult = await envRes.json();
                envData = envResult.values || {};
                updateGhMenu();
                renderDashboard(appData);
            } catch (error) {
                document.getElementById('dashboard').innerHTML = `
                    <div class="card">
                        <p class="terminal error">Error loading status: ${error.message}</p>
                    </div>
                `;
            } finally {
                // Brief delay so the bar is visible even on fast responses
                setTimeout(() => bar?.classList.remove('active'), 300);
            }
        }

        function renderDashboard(data) {
            const dashboard = document.getElementById('dashboard');

            const stageClass = {
                'OK': 'ok', 'WARNING': 'warning', 'CRITICAL': 'critical', 'FINAL': 'critical'
            }[data.state.stage] || 'unknown';

            // Format deadline info
            let countdownHtml = '';
            let deadlineInfoHtml = '';
            if (data.state.time_to_deadline_minutes !== null) {
                const ttd = data.state.time_to_deadline_minutes;
                if (ttd > 0) {
                    const hours = Math.floor(ttd / 60);
                    const mins = ttd % 60;
                    const countdownClass = ttd < 60 ? 'danger' : ttd < 360 ? 'warning' : '';
                    countdownHtml = `<div class="countdown ${countdownClass}">${hours}h ${mins}m</div>`;
                } else {
                    countdownHtml = `<div class="countdown danger">âš ï¸ PASSED</div>`;
                }
            } else if (data.state.stage === 'UNKNOWN') {
                countdownHtml = `<div class="alert info" style="margin-bottom: 1rem;">
                    ğŸ’¡ <strong>Not initialized</strong> â€” Run a tick or renew to start the deadline.
                </div>`;
            }
            if (data.state.deadline) {
                const dl = new Date(data.state.deadline);
                deadlineInfoHtml = `
                    <div class="status-row">
                        <span class="status-label">Deadline</span>
                        <span class="status-value" style="font-size: 0.85rem;">
                            ${dl.toLocaleDateString()} ${dl.toLocaleTimeString()}
                        </span>
                    </div>`;
            }

            const ghTool = data.tools.find(t => t.name === 'gh');
            ghAuthenticated = ghTool?.installed && ghTool?.authenticated;

            // Build tools HTML with install button for gh
            const toolsHtml = data.tools.map(t => {
                let actionHtml = '';
                if (t.name === 'gh' && !t.installed) {
                    actionHtml = `<button class="btn" onclick="installGh()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Install</button>`;
                } else if (t.name === 'gh' && t.installed && !t.authenticated) {
                    actionHtml = `<span style="color: var(--warning);">run: gh auth login</span>`;
                }
                return `
                    <div class="tool-item">
                        <span>${t.installed ? 'âœ…' : 'âŒ'}</span>
                        <span class="tool-name" translate="no">${t.name}</span>
                        <span style="color: var(--text-dim);">
                            ${t.installed ? (t.authenticated !== null ? (t.authenticated ? 'auth âœ“' : actionHtml) : 'ok') : actionHtml || 'â€”'}
                        </span>
                    </div>
                `;
            }).join('');

            dashboard.innerHTML = `
                <div class="card">
                    <h2 style="display: flex; align-items: center;"><span class="icon">ğŸ“Š</span> System State <button class="btn" onclick="loadStatus()" style="margin-left: auto; padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Refresh status">ğŸ”„</button></h2>
                    ${countdownHtml}
                    <div class="status-row">
                        <span class="status-label">Stage</span>
                        <a href="#" onclick="event.preventDefault(); switchTab('debugging');" style="font-size: 0.75rem; color: var(--accent); text-decoration: none; opacity: 0.8;margin-left:auto;margin-right: 8px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">â± Deadline Mgmt â†’</a>
                        <span class="badge ${stageClass}" translate="no">${data.state.stage}</span>
                    </div>
                    ${data.state.release_triggered ? `
                    <div style="background: rgba(245, 158, 11, 0.15); border: 1px solid var(--warning); border-radius: 8px; padding: 0.6rem 0.8rem; margin: 0.5rem 0;">
                        <div style="font-weight: 700; color: var(--warning); font-size: 0.85rem;">ğŸ‘» SHADOW MODE â€” DELAYED</div>
                        <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.25rem;">
                            Delay: ${data.state.release_delay_minutes}m
                            ${data.state.release_execute_after ? ` â€¢ Executes: ${new Date(data.state.release_execute_after).toLocaleString()}` : ''}
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-dim); margin-top: 0.25rem;">Cancel by renewing before the execute time.</div>
                    </div>
                    ` : ''}
                    <div class="status-row">
                        <span class="status-label">Project</span>
                        <span class="status-value" translate="no">${data.config.project_name || 'â€”'}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Mode</span>
                        <span class="status-value">${data.config.vault_locked
                            ? '<span style="color: var(--text-dim); font-size: 0.8rem;">ğŸ”’ Vault locked</span>'
                            : data.config.mock_mode ? 'ğŸ§ª Mock' : 'ğŸ”´ Live'}
                        </span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Deploy</span>
                        <span class="status-value">${data.config.deploy_mode === 'docker'
                            ? 'ğŸ³ Docker'
                            : 'ğŸŒ GitHub Pages'}
                        </span>
                    </div>
                    ${deadlineInfoHtml}
                    <div class="status-row">
                        <span class="status-label">Renewals</span>
                        <span class="status-value" style="display: flex; align-items: center; gap: 0.75rem;">
                            ${data.state.renewal_count}
                        </span>
                    </div>
                    
                    ${data.state.stage === 'UNKNOWN' ? `
                        <div class="actions">
                            <button class="btn" onclick="loadStatus()">ğŸ”„ Refresh</button>
                            <button class="btn primary" onclick="switchTab('wizard')">ğŸ§™ Start Setup â†’</button>
                        </div>
                    ` : data.state.release_triggered || data.state.stage === 'FULL' || data.state.stage === 'PARTIAL' || data.state.stage === 'PRE_RELEASE' ? `
                        <div style="border-top: 1px solid var(--border); margin-top: 1rem; padding-top: 1rem;">
                            <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 0.5rem; color: var(--danger);">
                                ${data.state.release_triggered
                        ? 'ğŸ‘» Shadow mode is active â€” disclosure is pending'
                        : `âš ï¸ Disclosure is <strong>${data.state.stage}</strong> â€” system is active`}
                            </div>
                            <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.75rem;">
                                ${data.state.release_triggered
                        ? 'Cancel shadow mode by returning to OK. This clears the pending release and restores the countdown.'
                        : 'Returning to OK will reset escalation, cancel any pending release, and restore the countdown.'}
                            </p>
                            <div class="actions" style="gap: 0.5rem;">
                                <button class="btn primary" onclick="returnToOK()" style="flex: 1;">
                                    ğŸ”™ Return to OK
                                </button>
                                <button class="btn" onclick="loadStatus()" style="padding: 0 0.6rem;" title="Refresh status">ğŸ”„</button>
                            </div>
                        </div>
                    ` : data.state.stage === 'OK' || data.state.stage === 'WARNING' || data.state.stage === 'REMIND_1' || data.state.stage === 'REMIND_2' ? `
                        <div style="padding-top: 1rem;">
                            ${data.state.stage === 'REMIND_1' || data.state.stage === 'REMIND_2' ? `
                            <div style="border: 1px solid var(--accent); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; background: rgba(99, 102, 241, 0.08);">
                                <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 0.35rem; color: var(--accent);">
                                    â° Escalation active â€” renew to return to OK
                                </div>
                                <p style="font-size: 0.78rem; color: var(--text-dim); margin: 0 0 0.6rem 0;">
                                    Renewing extends the deadline and resets the stage to OK, cancelling further escalation.
                                </p>
                                <div class="actions" style="gap: 0.5rem;">
                                    <button class="btn" onclick="renewDeadline(24)" style="flex: 1;">+24h</button>
                                    <button class="btn primary" onclick="renewDeadline(48)" style="flex: 1;">+48h</button>
                                    <button class="btn" onclick="renewDeadline(72)" style="flex: 1;">+72h</button>
                                    <button class="btn" onclick="returnToOK()" style="padding: 0 0.6rem;" title="Return to OK without extending deadline">ğŸ”™ OK</button>
                                </div>
                            </div>
                            ` : ''}
                            <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 0.75rem; color: var(--text-dim);">âš¡ Manual Trigger</div>
                            <div class="actions" style="flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: stretch;">
                                    <select id="trigger-stage" translate="no" style="background: var(--surface); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 0 0.5rem; font-size: 0.8rem; cursor: pointer; font-weight: 600;">
                                        <option value="FULL" selected>ğŸ’€ FULL</option>
                                        <option value="PARTIAL">âš ï¸ PARTIAL</option>
                                        <option value="PRE_RELEASE">ğŸ”¶ PRE_RELEASE</option>
                                        <option value="REMIND_2">ğŸ”” REMIND_2</option>
                                        <option value="REMIND_1">ğŸ”” REMIND_1</option>
                                    </select>
                                    <button class="btn danger" onclick="triggerRelease()" style="flex: 1;"
                                        title="Immediately escalates to the selected stage and executes all disclosure actions on the next tick. This is irreversible without a manual Return to OK.">
                                        âš¡ Trigger Disclosure
                                    </button>
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: stretch;">
                                    <button class="btn" onclick="triggerShadow()" style="flex: 1; border-color: var(--warning); color: var(--warning);"
                                        title="Stealth trigger with delay â€” same as entering RELEASE_SECRET on the public site. Uses the selected stage. Cancelable by renewal during the delay window.">
                                        ğŸ‘» Shadow Mode
                                    </button>
                                    <select id="shadow-delay" style="background: var(--surface); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 0 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                        <option value="0">No delay</option>
                                        <option value="30">30 min delay</option>
                                        <option value="60" selected>1 hour delay</option>
                                        <option value="120">2 hour delay</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="actions" style="margin-top: 0.75rem;">
                            <button class="btn" onclick="loadStatus()">ğŸ”„ Refresh</button>
                        </div>
                    `}
                    <div id="trigger-status" style="margin-top: 0.75rem; font-size: 0.85rem;"></div>
                </div>
                
                <div class="card">
                    <h2><span class="icon">ğŸ”Œ</span> Adapters</h2>
                    ${data.adapters.map(a => `
                        <div class="adapter-item">
                            <span>${a.configured ? 'âœ…' : 'âŒ'}</span>
                            <span class="adapter-name">${a.name}</span>
                            <span class="adapter-status ${a.configured ? (a.mode === 'real' ? 'ready' : 'mock') : 'missing'}">
                                ${a.configured ? a.mode : a.missing.slice(0, 2).join(', ')}
                            </span>
                        </div>
                    `).join('')}
                </div>
                
                ${data.actions && data.actions.failed_count > 0 ? `
                <div class="card" style="border: 1px solid var(--danger); background: rgba(239, 68, 68, 0.06);">
                    <h2 style="color: var(--danger);"><span class="icon">âš ï¸</span> Action Failures (${data.actions.failed_count})</h2>
                    <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.75rem;">
                        These actions failed on the last tick. Check adapter configuration and rate limits.
                    </p>
                    ${data.actions.failed.map(a => `
                        <div class="status-row" style="border-left: 3px solid var(--danger); padding-left: 0.5rem; margin-bottom: 0.5rem;">
                            <span class="status-label" style="color: var(--danger);">âŒ ${a.action_id}</span>
                            <span class="status-value" style="font-size: 0.75rem; color: var(--text-dim);">
                                ${a.last_executed_iso ? new Date(a.last_executed_iso).toLocaleString() : 'â€”'}
                            </span>
                        </div>
                    `).join('')}
                    <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.5rem;">
                        Last tick actions: ${data.actions.last_tick.join(', ') || 'none'}
                    </div>
                </div>
                ` : data.actions && data.actions.results && data.actions.results.length > 0 ? `
                <div class="card">
                    <h2><span class="icon">ğŸ“‹</span> Last Actions</h2>
                    ${data.actions.results.map(a => `
                        <div class="status-row">
                            <span class="status-label">${a.status === 'ok' ? 'âœ…' : a.status === 'skipped' ? 'â­ï¸' : 'âŒ'} ${a.action_id}</span>
                            <span class="status-value" style="font-size: 0.75rem; color: var(--text-dim);">
                                ${a.status}${a.last_executed_iso ? ' â€¢ ' + new Date(a.last_executed_iso).toLocaleString() : ''}
                            </span>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                <div class="card">
                    <h2><span class="icon">ğŸ› ï¸</span> Tools</h2>
                    ${toolsHtml}
                    <div style="padding-top: 0.75rem;">
                        <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 0.5rem;">ğŸ“¦ Git</div>
                        <div id="git-status-content" style="color: var(--text-dim); font-size: 0.85rem;">Loading...</div>
                    </div>
                </div>
                
                <div class="card">
                    <h2><span class="icon">ğŸ”</span> Secrets</h2>
                    <div class="status-row">
                        <span class="status-label">Set</span>
                        <span class="status-value">${data.secrets.filter(s => s.set).length} / ${data.secrets.length}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Required Missing</span>
                        <span class="status-value" style="color: var(--danger);">
                            ${data.secrets.filter(s => s.required_for.length > 0 && !s.set).length}
                        </span>
                    </div>
                    <div class="actions">
                        <button class="btn" onclick="switchTab('secrets')">Configure Secrets â†’</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2><span class="icon">ğŸ’š</span> Health</h2>
                    <div class="status-row">
                        <span class="status-label">State file</span>
                        <span>${data.health.state_file_exists ? 'âœ…' : 'âŒ'}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Policy</span>
                        <span>${data.health.policy_valid ? 'âœ…' : 'âŒ'}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Updated</span>
                        <span style="color: var(--text-dim); font-size: 0.85rem;">
                            ${new Date(data.timestamp).toLocaleTimeString()}
                        </span>
                    </div>
                </div>
                
                ${(envData.DEPLOY_MODE || 'github-pages') !== 'docker' ? `
                <div class="card" id="sentinel-card">
                    <h2><span class="icon">ğŸ›°ï¸</span> Sentinel
                        <span id="sentinel-badge" style="font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 4px; margin-left: 0.5rem; background: var(--bg-input); color: var(--text-dim);">loadingâ€¦</span>
                    </h2>
                    <div id="sentinel-body" style="color: var(--text-dim); font-size: 0.85rem;">Loadingâ€¦</div>
                </div>
                ` : ''}

                <div class="card">
                    <h2><span class="icon">âš¡</span> Quick Actions</h2>
                    <div class="actions" style="flex-direction: column; gap: 1rem;">
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button class="btn primary" onclick="switchTab('commands')">Open Command Center â†’</button>
                            <button class="btn primary" onclick="runCommand('tick-dry')">ğŸ§ª Dry Run</button>
                        </div>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button class="btn" onclick="switchTab('debugging')">ğŸ› Debugging & Deadline â†’</button>
                        </div>
                    </div>
                </div>
            `;

            // Load git status into the Tools card
            loadGitStatus();
            // Load sentinel status into the Sentinel card (skip in Docker mode)
            if ((envData.DEPLOY_MODE || 'github-pages') !== 'docker') {
                loadSentinelStatus();
            }
        }

        async function loadSentinelStatus() {
            const badge = document.getElementById('sentinel-badge');
            const body = document.getElementById('sentinel-body');
            if (!badge || !body) return;

            try {
                const resp = await fetch('/api/sentinel/status');
                const data = await resp.json();

                if (!data.configured) {
                    badge.textContent = 'not configured';
                    badge.style.background = 'var(--bg-input)';
                    badge.style.color = 'var(--text-dim)';
                    body.innerHTML = `
                        <p style="margin-bottom: 0.75rem;">The sentinel Worker is not configured. The system uses the GitHub Actions cron schedule (every 30 min).</p>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn primary" onclick="setupSentinel(true)"
                                    style="padding: 0.3rem 0.75rem; font-size: 0.8rem;">â–¶ï¸ Run Setup</button>
                            <button class="btn" onclick="switchTab('wizard'); setTimeout(() => goToWizardStep('sentinel'), 100);"
                                    style="padding: 0.3rem 0.75rem; font-size: 0.8rem;">ğŸ§™ Wizard â†’</button>
                        </div>
                    `;
                    return;
                }

                if (!data.reachable) {
                    badge.textContent = 'unreachable';
                    badge.style.background = 'var(--warning)';
                    badge.style.color = '#000';
                    body.innerHTML = `
                        <p style="color: var(--warning);">Sentinel is configured but the Worker is not reachable.</p>
                        <p style="font-size: 0.8rem; margin-top: 0.25rem;">${data.error || 'Connection failed'}</p>
                    `;
                    return;
                }

                // Sentinel is live â€” map Worker /status response fields
                const lastDecision = data.lastDecision || {};
                const config = data.config || {};
                const failures = data.dispatchFailures || 0;

                // Badge reflects actual health, not just reachability
                if (failures > 0) {
                    badge.textContent = `âš  ${failures} failures`;
                    badge.style.background = 'rgba(239, 68, 68, 0.15)';
                    badge.style.color = 'var(--danger)';
                } else if (lastDecision.dispatch === false) {
                    badge.textContent = 'idle';
                    badge.style.background = 'rgba(251, 191, 36, 0.12)';
                    badge.style.color = 'var(--warning)';
                } else {
                    badge.textContent = 'active';
                    badge.style.background = 'rgba(74, 222, 128, 0.15)';
                    badge.style.color = 'var(--accent)';
                }

                let rows = '';

                // Show failure alert prominently
                if (failures > 0) {
                    rows += `<div class="alert" style="background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 6px; padding: 0.6rem; margin-bottom: 0.75rem; font-size: 0.82rem;">
                        <strong style="color: var(--danger);">ğŸš¨ Dispatch failing</strong><br>
                        <span style="color: var(--text-dim);">${failures} consecutive dispatch failure${failures > 1 ? 's' : ''} â€” GitHub Actions may be disabled or the token may have expired.</span>
                    </div>`;
                }

                if (lastDecision.dispatch !== undefined) {
                    const action = lastDecision.dispatch ? 'ğŸŸ¢ dispatched' : 'â­ï¸ skipped';
                    rows += `<div class="status-row"><span class="status-label">Last Decision</span><span class="status-value">${action}</span></div>`;

                    if (lastDecision.reason) {
                        rows += `<div class="status-row"><span class="status-label">Reason</span><span class="status-value" style="font-size: 0.82rem;">${lastDecision.reason}</span></div>`;
                    }
                }

                if (lastDecision.at) {
                    const ago = _timeAgo(new Date(lastDecision.at));
                    rows += `<div class="status-row"><span class="status-label">Checked</span><span class="status-value" style="font-size: 0.82rem;">${ago}</span></div>`;
                }

                if (data.nextDueAt) {
                    const nextDue = new Date(data.nextDueAt);
                    const now = new Date();
                    const diffMin = Math.round((nextDue - now) / 60000);
                    const when = diffMin > 0 ? `in ${diffMin}m` : 'now';
                    rows += `<div class="status-row"><span class="status-label">Next Due</span><span class="status-value">${when}</span></div>`;
                }

                if (data.stage) {
                    rows += `<div class="status-row"><span class="status-label">Worker Stage</span><span class="status-value">${data.stage}</span></div>`;
                }

                if (data.lastDispatchAt) {
                    const ago = _timeAgo(new Date(data.lastDispatchAt));
                    rows += `<div class="status-row"><span class="status-label">Last Dispatch</span><span class="status-value" style="font-size: 0.82rem;">${ago}</span></div>`;
                }

                if (config.repo) {
                    rows += `<div class="status-row"><span class="status-label">Dispatches to</span><span class="status-value" style="font-size: 0.82rem;" translate="no">${config.repo}</span></div>`;
                }

                body.innerHTML = rows || '<p>Sentinel is active. Waiting for first decisionâ€¦</p>';

            } catch (err) {
                badge.textContent = 'error';
                badge.style.background = 'var(--danger)';
                badge.style.color = '#fff';
                body.innerHTML = `<p style="color: var(--danger);">Failed to load sentinel status: ${err.message}</p>`;
            }
        }

        function _timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return `${Math.floor(hours / 24)}d ago`;
        }
