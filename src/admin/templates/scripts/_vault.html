        // â”€â”€ Vault â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let vaultLocked = false;
        let vaultAutoLockMinutes = 30;
        let vaultHasPassphrase = false;  // Server has passphrase in memory

        // â”€â”€ Cross-tab coordination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // BroadcastChannel lets all same-origin tabs sync vault
        // state instantly â€” no polling delay, no race conditions.
        const _vaultChannel = (typeof BroadcastChannel !== 'undefined')
            ? new BroadcastChannel('vault-state')
            : null;

        function _broadcastVaultState(locked) {
            if (_vaultChannel) {
                _vaultChannel.postMessage({ locked: locked });
            }
        }

        if (_vaultChannel) {
            _vaultChannel.onmessage = function(e) {
                const newLocked = e.data.locked;
                if (newLocked !== vaultLocked) {
                    vaultLocked = newLocked;
                    updateVaultUI({});
                    // If we just got unlocked from another tab, reload data
                    if (!newLocked && typeof loadAll === 'function') {
                        loadAll();
                    }
                }
            };
        }

        // â”€â”€ Core â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function checkVaultStatus() {
            try {
                const resp = await fetch('/api/vault/status');
                const data = await resp.json();
                vaultLocked = data.locked;
                vaultAutoLockMinutes = data.auto_lock_minutes || 30;
                vaultHasPassphrase = !!data.has_passphrase;
                updateVaultUI(data);
            } catch (e) {
                // Vault API not available â€” assume unlocked
                vaultLocked = false;
                updateVaultUI({});
            }
        }

        function updateVaultUI(data) {
            const overlay = document.getElementById('vault-overlay');
            const btn = document.getElementById('vault-toggle');

            if (vaultLocked) {
                overlay.style.display = 'flex';
                if (btn) { btn.textContent = 'ðŸ”’'; btn.title = 'Vault is locked'; }

                // Show rate limit warning if applicable
                const errorEl = document.getElementById('vault-error');
                if (data && data.rate_limited && data.retry_after > 0) {
                    errorEl.textContent = 'Too many failed attempts. Try again in ' + data.retry_after + 's.';
                    errorEl.style.display = 'block';
                }

                // Also dismiss the lock modal if it was open (auto-lock during setup)
                const lockModal = document.getElementById('vault-lock-modal');
                if (lockModal) lockModal.style.display = 'none';

                setTimeout(function() { var el = document.getElementById('vault-passphrase-input'); if (el) el.focus(); }, 100);
            } else {
                overlay.style.display = 'none';
                if (btn) { btn.textContent = 'ðŸ”“'; btn.title = 'Lock vault (' + vaultAutoLockMinutes + 'min auto-lock)'; }
            }
        }

        function vaultToggle() {
            if (vaultLocked) {
                updateVaultUI({});
            } else {
                // Show lock modal â€” pick the right mode
                document.getElementById('vault-lock-modal').style.display = 'flex';

                // Clear errors
                var errQuick = document.getElementById('vault-lock-error-quick');
                var errNew = document.getElementById('vault-lock-error');
                if (errQuick) errQuick.style.display = 'none';
                if (errNew) errNew.style.display = 'none';

                if (vaultHasPassphrase) {
                    // Quick lock mode â€” no passphrase entry needed
                    document.getElementById('vault-lock-quick').style.display = 'block';
                    document.getElementById('vault-lock-new').style.display = 'none';
                    // Set auto-lock dropdown to current value
                    var sel = document.getElementById('vault-autolock-select-quick');
                    if (sel) sel.value = String(vaultAutoLockMinutes);
                } else {
                    // First time â€” must enter passphrase
                    document.getElementById('vault-lock-quick').style.display = 'none';
                    document.getElementById('vault-lock-new').style.display = 'block';
                    document.getElementById('vault-lock-pass1').value = '';
                    document.getElementById('vault-lock-pass2').value = '';
                    var sel = document.getElementById('vault-autolock-select');
                    if (sel) sel.value = String(vaultAutoLockMinutes);
                    setTimeout(function() { var el = document.getElementById('vault-lock-pass1'); if (el) el.focus(); }, 100);
                }
            }
        }

        function vaultShowChangePassphrase() {
            // Switch from quick-lock to new-passphrase mode
            document.getElementById('vault-lock-quick').style.display = 'none';
            document.getElementById('vault-lock-new').style.display = 'block';
            document.getElementById('vault-lock-pass1').value = '';
            document.getElementById('vault-lock-pass2').value = '';
            document.getElementById('vault-lock-error').style.display = 'none';
            var sel = document.getElementById('vault-autolock-select');
            if (sel) sel.value = String(vaultAutoLockMinutes);
            setTimeout(function() { var el = document.getElementById('vault-lock-pass1'); if (el) el.focus(); }, 100);
        }

        async function vaultQuickLock() {
            const errorEl = document.getElementById('vault-lock-error-quick');

            // Save auto-lock config
            var sel = document.getElementById('vault-autolock-select-quick');
            if (sel) {
                var mins = parseInt(sel.value, 10);
                vaultAutoLockMinutes = mins;
                fetch('/api/vault/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ auto_lock_minutes: mins }),
                }).catch(function() {});
            }

            try {
                const resp = await fetch('/api/vault/quick-lock', { method: 'POST' });
                const data = await resp.json();

                if (data.success) {
                    vaultLocked = true;
                    document.getElementById('vault-lock-modal').style.display = 'none';
                    updateVaultUI({});
                    _broadcastVaultState(true);
                } else {
                    // Passphrase gone from memory â€” fallback to full lock
                    if (errorEl) {
                        errorEl.textContent = data.error || 'Quick-lock failed â€” enter a new passphrase';
                        errorEl.style.display = 'block';
                    }
                    vaultHasPassphrase = false;
                    // Switch to new-passphrase mode automatically
                    setTimeout(function() { vaultShowChangePassphrase(); }, 1500);
                }
            } catch (e) {
                if (errorEl) {
                    errorEl.textContent = 'Connection error';
                    errorEl.style.display = 'block';
                }
            }
        }

        async function vaultUnlock() {
            const input = document.getElementById('vault-passphrase-input');
            const errorEl = document.getElementById('vault-error');
            const passphrase = input.value;

            if (!passphrase) {
                errorEl.textContent = 'Enter your passphrase';
                errorEl.style.display = 'block';
                return;
            }

            errorEl.style.display = 'none';

            try {
                const resp = await fetch('/api/vault/unlock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ passphrase: passphrase }),
                });
                const data = await resp.json();

                if (data.success) {
                    vaultLocked = false;
                    vaultHasPassphrase = true;  // Server now has it in memory
                    updateVaultUI({});
                    input.value = '';
                    _broadcastVaultState(false);  // Tell other tabs
                    if (typeof loadAll === 'function') loadAll();
                } else {
                    errorEl.textContent = data.error || 'Unlock failed';
                    errorEl.style.display = 'block';
                    input.value = '';
                    input.focus();
                }
            } catch (e) {
                errorEl.textContent = 'Connection error';
                errorEl.style.display = 'block';
            }
        }

        async function vaultLock() {
            const pass1 = document.getElementById('vault-lock-pass1').value;
            const pass2 = document.getElementById('vault-lock-pass2').value;
            const errorEl = document.getElementById('vault-lock-error');

            if (!pass1) {
                errorEl.textContent = 'Enter a passphrase';
                errorEl.style.display = 'block';
                return;
            }
            if (pass1.length < 4) {
                errorEl.textContent = 'Passphrase must be at least 4 characters';
                errorEl.style.display = 'block';
                return;
            }
            if (pass1 !== pass2) {
                errorEl.textContent = 'Passphrases do not match';
                errorEl.style.display = 'block';
                return;
            }

            errorEl.style.display = 'none';

            // Save auto-lock config first
            var sel = document.getElementById('vault-autolock-select');
            if (sel) {
                var mins = parseInt(sel.value, 10);
                vaultAutoLockMinutes = mins;
                fetch('/api/vault/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ auto_lock_minutes: mins }),
                }).catch(function() {});
            }

            try {
                const resp = await fetch('/api/vault/lock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ passphrase: pass1 }),
                });
                const data = await resp.json();

                if (data.success) {
                    vaultLocked = true;
                    vaultHasPassphrase = true;  // New passphrase is now stored
                    document.getElementById('vault-lock-modal').style.display = 'none';
                    updateVaultUI({});
                    _broadcastVaultState(true);  // Tell other tabs
                } else {
                    errorEl.textContent = data.error || 'Lock failed';
                    errorEl.style.display = 'block';
                }
            } catch (e) {
                errorEl.textContent = 'Connection error';
                errorEl.style.display = 'block';
            }
        }

        function vaultLockCancel() {
            document.getElementById('vault-lock-modal').style.display = 'none';
        }

        // Periodically check vault status (catches auto-lock from server)
        // Polls in BOTH states now â€” the server can lock (auto-lock timer)
        // or unlock (another tab) at any time.
        setInterval(function() {
            fetch('/api/vault/status').then(function(r) { return r.json(); }).then(function(data) {
                // Track passphrase availability
                vaultHasPassphrase = !!data.has_passphrase;

                if (data.locked !== vaultLocked) {
                    vaultLocked = data.locked;
                    updateVaultUI(data);
                    // Broadcast to other tabs so everyone converges fast
                    _broadcastVaultState(data.locked);
                    // If unlocked remotely, reload data
                    if (!data.locked && typeof loadAll === 'function') {
                        loadAll();
                    }
                }
            }).catch(function() {});
        }, 10000);

        // Check vault status on page load
        checkVaultStatus();
