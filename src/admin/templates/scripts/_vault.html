        // â”€â”€ Vault â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let vaultLocked = false;
        let vaultAutoLockMinutes = 30;

        async function checkVaultStatus() {
            try {
                const resp = await fetch('/api/vault/status');
                const data = await resp.json();
                vaultLocked = data.locked;
                vaultAutoLockMinutes = data.auto_lock_minutes || 30;
                updateVaultUI(data);
            } catch (e) {
                // Vault API not available â€” assume unlocked
                vaultLocked = false;
                updateVaultUI({});
            }
        }

        function updateVaultUI(data) {
            const overlay = document.getElementById('vault-overlay');
            const btn = document.getElementById('vault-toggle');

            if (vaultLocked) {
                overlay.style.display = 'flex';
                if (btn) { btn.textContent = 'ðŸ”’'; btn.title = 'Vault is locked'; }

                // Show rate limit warning if applicable
                const errorEl = document.getElementById('vault-error');
                if (data && data.rate_limited && data.retry_after > 0) {
                    errorEl.textContent = 'Too many failed attempts. Try again in ' + data.retry_after + 's.';
                    errorEl.style.display = 'block';
                }

                setTimeout(function() { var el = document.getElementById('vault-passphrase-input'); if (el) el.focus(); }, 100);
            } else {
                overlay.style.display = 'none';
                if (btn) { btn.textContent = 'ðŸ”“'; btn.title = 'Lock vault (' + vaultAutoLockMinutes + 'min auto-lock)'; }
            }
        }

        function vaultToggle() {
            if (vaultLocked) {
                updateVaultUI({});
            } else {
                // Show lock modal
                document.getElementById('vault-lock-modal').style.display = 'flex';
                document.getElementById('vault-lock-pass1').value = '';
                document.getElementById('vault-lock-pass2').value = '';
                document.getElementById('vault-lock-error').style.display = 'none';

                // Set auto-lock dropdown to current value
                var sel = document.getElementById('vault-autolock-select');
                if (sel) sel.value = String(vaultAutoLockMinutes);

                setTimeout(function() { var el = document.getElementById('vault-lock-pass1'); if (el) el.focus(); }, 100);
            }
        }

        async function vaultUnlock() {
            const input = document.getElementById('vault-passphrase-input');
            const errorEl = document.getElementById('vault-error');
            const passphrase = input.value;

            if (!passphrase) {
                errorEl.textContent = 'Enter your passphrase';
                errorEl.style.display = 'block';
                return;
            }

            errorEl.style.display = 'none';

            try {
                const resp = await fetch('/api/vault/unlock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ passphrase: passphrase }),
                });
                const data = await resp.json();

                if (data.success) {
                    vaultLocked = false;
                    updateVaultUI({});
                    input.value = '';
                    if (typeof loadAll === 'function') loadAll();
                } else {
                    errorEl.textContent = data.error || 'Unlock failed';
                    errorEl.style.display = 'block';
                    input.value = '';
                    input.focus();
                }
            } catch (e) {
                errorEl.textContent = 'Connection error';
                errorEl.style.display = 'block';
            }
        }

        async function vaultLock() {
            const pass1 = document.getElementById('vault-lock-pass1').value;
            const pass2 = document.getElementById('vault-lock-pass2').value;
            const errorEl = document.getElementById('vault-lock-error');

            if (!pass1) {
                errorEl.textContent = 'Enter a passphrase';
                errorEl.style.display = 'block';
                return;
            }
            if (pass1.length < 4) {
                errorEl.textContent = 'Passphrase must be at least 4 characters';
                errorEl.style.display = 'block';
                return;
            }
            if (pass1 !== pass2) {
                errorEl.textContent = 'Passphrases do not match';
                errorEl.style.display = 'block';
                return;
            }

            errorEl.style.display = 'none';

            // Save auto-lock config first
            var sel = document.getElementById('vault-autolock-select');
            if (sel) {
                var mins = parseInt(sel.value, 10);
                vaultAutoLockMinutes = mins;
                fetch('/api/vault/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ auto_lock_minutes: mins }),
                }).catch(function() {});
            }

            try {
                const resp = await fetch('/api/vault/lock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ passphrase: pass1 }),
                });
                const data = await resp.json();

                if (data.success) {
                    vaultLocked = true;
                    document.getElementById('vault-lock-modal').style.display = 'none';
                    updateVaultUI({});
                } else {
                    errorEl.textContent = data.error || 'Lock failed';
                    errorEl.style.display = 'block';
                }
            } catch (e) {
                errorEl.textContent = 'Connection error';
                errorEl.style.display = 'block';
            }
        }

        function vaultLockCancel() {
            document.getElementById('vault-lock-modal').style.display = 'none';
        }

        // Periodically check vault status (catches auto-lock)
        setInterval(function() {
            if (!vaultLocked) {
                fetch('/api/vault/status').then(function(r) { return r.json(); }).then(function(data) {
                    if (data.locked && !vaultLocked) {
                        vaultLocked = true;
                        updateVaultUI(data);
                    }
                }).catch(function() {});
            }
        }, 10000);

        // Check vault status on page load
        checkVaultStatus();
