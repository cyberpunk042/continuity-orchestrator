        // ========================================
        // SETUP WIZARD
        // ========================================

        const wizardSteps = [
            {
                id: 'welcome',
                title: 'Welcome',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üëã Welcome to the Setup Wizard</h2>
                    <p style="color: var(--text-dim); line-height: 1.6; margin-bottom: 1rem;">
                        This wizard will guide you through configuring the Continuity Orchestrator step-by-step.
                    </p>
                    <p style="color: var(--text-dim); line-height: 1.6; margin-bottom: 1rem;">
                        You'll configure:
                    </p>
                    <ul style="color: var(--text-dim); line-height: 1.8; margin-left: 1.5rem;">
                        <li>üöÄ <strong>Deployment mode</strong> (GitHub Pages, Docker, etc.)</li>
                        <li>üìã Basic project settings & <strong>operating mode</strong></li>
                        <li>‚è∞ Countdown deadline <em style="opacity:0.6;"> ‚Äî if countdown mode</em></li>
                        <li>üìß Email notifications (Resend)</li>
                        <li>üì± SMS notifications (Twilio) <em style="opacity:0.6;">‚Äî optional</em></li>
                        <li>üê¶ X/Twitter posting <em style="opacity:0.6;">‚Äî optional</em></li>
                        <li>ü§ñ Reddit posting <em style="opacity:0.6;">‚Äî optional</em></li>
                        <li>üîê Security secrets</li>
                        <li>üîÅ Repo Mirror <em style="opacity:0.6;">‚Äî optional</em></li>
                        <li>üõ∞Ô∏è Sentinel Worker <em style="opacity:0.6;">‚Äî optional</em></li>
                        <li>üöÄ Push to GitHub</li>
                    </ul>
                    <p style="color: var(--text-dim); margin-top: 1rem; font-size: 0.9rem;">
                        üí° Skip any optional step by leaving fields blank.
                    </p>
                `,
                validate: () => true
            },
            {
                id: 'deployment',
                title: 'Deploy',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üöÄ Deployment Mode</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                        How do you want to deploy the Continuity Orchestrator?
                    </p>
                    <div class="form-group">
                        <label class="form-label">Select your deployment method:</label>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${wizardData.DEPLOY_MODE === 'github-pages' ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="deploy-mode" value="github-pages" ${wizardData.DEPLOY_MODE !== 'docker' ? 'checked' : ''} onchange="wizardData.DEPLOY_MODE='github-pages'; const ds=document.getElementById('wiz-docker-settings'); if(ds) ds.style.display='none';">
                                <div>
                                    <strong>üåê GitHub Pages</strong> <span style="color: var(--accent);">Recommended</span>
                                    <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">
                                        Free hosting via GitHub. Site auto-updates via Actions.<br>
                                        <em>‚ö†Ô∏è Requires GitHub Pro/Team for private repos with public Pages.</em>
                                    </div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${wizardData.DEPLOY_MODE === 'docker' ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="deploy-mode" value="docker" ${wizardData.DEPLOY_MODE === 'docker' ? 'checked' : ''} onchange="wizardData.DEPLOY_MODE='docker'; const ds=document.getElementById('wiz-docker-settings'); if(ds) ds.style.display='block';">
                                <div>
                                    <strong>üê≥ Docker (Self-Hosted)</strong>
                                    <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">
                                        Run locally with Docker. No GitHub Pro needed.<br>
                                        <em>Options: docker-compose, git-sync to public repo, or standalone.</em>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div id="wiz-docker-settings" style="display: ${wizardData.DEPLOY_MODE === 'docker' ? 'block' : 'none'}; margin-top: 1.25rem; padding: 1.25rem; border: 1px solid var(--border); border-radius: 10px; background: var(--bg-input);">
                        <h3 style="margin: 0 0 0.75rem; font-size: 1rem;">üê≥ Docker Git-Sync Settings</h3>

                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
                                <input type="checkbox" id="wiz-docker-alpha"
                                    ${wizardData.DOCKER_GIT_SYNC_ALPHA === 'true' ? 'checked' : ''}
                                    onchange="wizardData.DOCKER_GIT_SYNC_ALPHA = this.checked ? 'true' : 'false'"
                                    style="accent-color: var(--accent); margin-top: 0.2rem;">
                                <div>
                                    <strong>Alpha mode</strong>
                                    <span style="color: var(--text-dim); font-size: 0.8rem; margin-left: 0.25rem;">(advanced)</span>
                                    <div style="color: var(--text-dim); font-size: 0.82rem; margin-top: 0.25rem; line-height: 1.5;">
                                        When enabled, this Docker instance is the <strong>authority</strong>. If the remote
                                        repository conflicts (e.g. factory reset from another device), this instance
                                        overrides it with its own state.<br>
                                        When disabled <em>(default)</em>, the remote repository is the authority ‚Äî this
                                        instance follows any remote changes.
                                    </div>
                                </div>
                            </label>
                        </div>

                        <div style="display: flex; gap: 1rem;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label" style="font-size: 0.85rem;">Tick interval (seconds)</label>
                                <input type="number" class="form-input" id="wiz-docker-tick-interval"
                                    value="${wizardData.DOCKER_GIT_SYNC_TICK_INTERVAL || 900}" min="60" step="60"
                                    onchange="wizardData.DOCKER_GIT_SYNC_TICK_INTERVAL = this.value"
                                    style="width: 100%;">
                                <span style="color: var(--text-dim); font-size: 0.75rem;">Default: 900 (15 min)</span>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label" style="font-size: 0.85rem;">Sync check interval (seconds)</label>
                                <input type="number" class="form-input" id="wiz-docker-sync-interval"
                                    value="${wizardData.DOCKER_GIT_SYNC_SYNC_INTERVAL || 30}" min="10" step="10"
                                    onchange="wizardData.DOCKER_GIT_SYNC_SYNC_INTERVAL = this.value"
                                    style="width: 100%;">
                                <span style="color: var(--text-dim); font-size: 0.75rem;">Default: 30</span>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label" style="font-size: 0.85rem;">
                                ‚òÅÔ∏è Cloudflare Tunnel <span style="color: var(--text-dim);">(optional)</span>
                            </label>
                            <p style="color: var(--text-dim); font-size: 0.82rem; line-height: 1.5; margin-bottom: 0.75rem;">
                                Expose your Docker deployment on a public HTTPS URL ‚Äî no port forwarding needed.<br>
                                <strong>Prerequisite:</strong> You need a <a href="https://one.dash.cloudflare.com/" target="_blank" style="color: var(--info);">Cloudflare Tunnel</a> already created in the Zero Trust dashboard.
                            </p>

                            ${wizardData.CLOUDFLARE_TUNNEL_TOKEN ? `<div style="margin-bottom: 0.75rem; padding: 0.6rem 0.75rem; background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.25); border-radius: 6px; font-size: 0.82rem; display: flex; align-items: center; justify-content: space-between;">
                                <div><strong style="color: var(--accent);">‚úÖ Tunnel token configured</strong>
                                    <span style="color: var(--text-dim); margin-left: 0.5rem; font-family: monospace; font-size: 0.78rem;">${wizardData.CLOUDFLARE_TUNNEL_TOKEN.substring(0, 16)}‚Ä¶</span>
                                </div>
                                <span style="color: var(--text-dim); font-size: 0.75rem;">Saved in .env</span>
                            </div>` : `<div style="margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.2); border-radius: 6px; font-size: 0.82rem;">
                                <strong style="color: var(--warning);">‚ö† No tunnel token</strong>
                                <span style="color: var(--text-dim); margin-left: 0.3rem;">‚Äî use Auto-Run or paste it below</span>
                            </div>`}

                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="flex: 1; background: var(--surface); padding: 0.5rem 0.75rem; border-radius: 6px; font-family: monospace; font-size: 0.85rem;">
                                    $ ./manage.sh tunnel
                                </div>
                                <button class="btn" onclick="setupTunnel(false)" style="padding: 0.4rem 1rem; white-space: nowrap;" title="Interactive ‚Äî confirms each step">
                                    ‚ñ∂Ô∏è Run
                                </button>
                                <button class="btn primary" onclick="setupTunnel(true)" style="padding: 0.4rem 1rem; white-space: nowrap;" title="Auto-confirm all steps (-y flag)">
                                    ‚ö° Auto-Run
                                </button>
                            </div>
                            <p style="color: var(--text-dim); font-size: 0.78rem; opacity: 0.7; margin-bottom: 0.5rem;">
                                Requires: <a href="https://dash.cloudflare.com/sign-up" target="_blank" style="color: var(--info);">Cloudflare account</a>
                                with a tunnel already created.
                                The script will open the tunnel dashboard so you can copy the connector token.
                            </p>

                            <details style="margin-top: 0.5rem;" ${wizardData.CLOUDFLARE_TUNNEL_TOKEN ? '' : 'open'}>
                                <summary style="cursor: pointer; color: var(--text-dim); font-size: 0.82rem;">
                                    üîß ${wizardData.CLOUDFLARE_TUNNEL_TOKEN ? 'Change token‚Ä¶' : 'I already have a token‚Ä¶'}
                                </summary>
                                <div style="margin-top: 0.5rem;">
                                    <input type="text" class="form-input" id="wiz-tunnel-token"
                                        value="${wizardData.CLOUDFLARE_TUNNEL_TOKEN || ''}"
                                        placeholder="Paste: cloudflared service install eyJhIjoi‚Ä¶ or just the token"
                                        style="width: 100%; font-family: monospace; font-size: 0.82rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.4rem;">
                                        <button class="btn" id="wiz-tunnel-save-btn" onclick="_saveTunnelTokenFromInput()" style="padding: 0.3rem 0.8rem; font-size: 0.78rem;">
                                            üíæ Save Token
                                        </button>
                                        <span id="wiz-tunnel-save-status" style="font-size: 0.75rem;"></span>
                                    </div>
                                    <span style="display: block; color: var(--text-dim); font-size: 0.75rem; margin-top: 0.3rem;">
                                        Paste the full install command or token from
                                        <a href="https://one.dash.cloudflare.com/" target="_blank" style="color: var(--info);">Cloudflare Zero Trust</a> ‚Üí Networks ‚Üí Tunnels ‚Üí [your tunnel] ‚Üí Install tab.
                                    </span>
                                </div>
                            </details>
                        </div>
                    </div>

                    <div class="alert info" style="margin-top: 1rem;">
                        üí° <strong>Not sure?</strong> Start with GitHub Pages ‚Äî you can switch to Docker later.
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    // Prefer DOM (when this step is visible), fall back to stored value
                    const domMode = document.querySelector('input[name="deploy-mode"]:checked')?.value;
                    const mode = domMode || wizardData.DEPLOY_MODE || envData.DEPLOY_MODE || 'github-pages';
                    const data = { DEPLOY_MODE: mode };
                    if (mode === 'docker') {
                        const alphaEl = document.getElementById('wiz-docker-alpha');
                        const tickEl = document.getElementById('wiz-docker-tick-interval');
                        const syncEl = document.getElementById('wiz-docker-sync-interval');
                        // Only read DOM if elements exist (step is visible), else keep stored
                        data.DOCKER_GIT_SYNC_ALPHA = alphaEl ? (alphaEl.checked ? 'true' : 'false') : (wizardData.DOCKER_GIT_SYNC_ALPHA || 'false');
                        data.DOCKER_GIT_SYNC_TICK_INTERVAL = tickEl?.value || wizardData.DOCKER_GIT_SYNC_TICK_INTERVAL || '900';
                        data.DOCKER_GIT_SYNC_SYNC_INTERVAL = syncEl?.value || wizardData.DOCKER_GIT_SYNC_SYNC_INTERVAL || '30';
                        const tunnelToken = document.getElementById('wiz-tunnel-token')?.value;
                        if (tunnelToken) data.CLOUDFLARE_TUNNEL_TOKEN = tunnelToken;
                    }
                    return data;
                }
            },
            {
                id: 'project',
                title: 'Project',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üìã Project Configuration</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                        Basic settings for your orchestrator instance.
                    </p>
                    <div class="form-group">
                        <label class="form-label">Project Name *</label>
                        <input type="text" class="form-input" id="wiz-project-name" 
                               placeholder="my-deadman" value="${getSecretValue('PROJECT_NAME')}">
                        <div class="form-hint">A unique identifier for your project</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Operator Email *</label>
                        <input type="email" class="form-input" id="wiz-operator-email" 
                               placeholder="your@email.com" value="${getSecretValue('OPERATOR_EMAIL')}">
                        <div class="form-hint">Email for receiving notifications</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mock Mode</label>
                        <select class="form-input" id="wiz-mock-mode">
                            <option value="true" ${getSecretValue('ADAPTER_MOCK_MODE') !== 'false' ? 'selected' : ''}>On (safe testing)</option>
                            <option value="false" ${getSecretValue('ADAPTER_MOCK_MODE') === 'false' ? 'selected' : ''}>Off (live operations)</option>
                        </select>
                        <div class="form-hint">Keep ON for testing, turn OFF for production</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Operating Mode</label>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.MODE || 'renewable_countdown') === 'renewable_countdown' ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="wiz-mode" value="renewable_countdown" ${(wizardData.MODE || 'renewable_countdown') === 'renewable_countdown' ? 'checked' : ''} onchange="wizardData.MODE='renewable_countdown'">
                                <div>
                                    <strong>‚è∞ Renewable Countdown</strong> <span style="color: var(--accent);">Default</span>
                                    <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">Dead man's switch. Renew before the deadline or escalation begins.</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.MODE || 'renewable_countdown') === 'one_way_fuse' ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="wiz-mode" value="one_way_fuse" ${(wizardData.MODE || 'renewable_countdown') === 'one_way_fuse' ? 'checked' : ''} onchange="wizardData.MODE='one_way_fuse'">
                                <div>
                                    <strong>üí£ One-Way Fuse</strong>
                                    <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">Once armed, the deadline cannot be renewed. Escalation is irreversible.</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.MODE || 'renewable_countdown') === 'manual_arm' ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="wiz-mode" value="manual_arm" ${(wizardData.MODE || 'renewable_countdown') === 'manual_arm' ? 'checked' : ''} onchange="wizardData.MODE='manual_arm'">
                                <div>
                                    <strong>üîí Manual Arm</strong>
                                    <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">System stays disarmed until explicitly activated. No countdown until you arm it.</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 1.25rem;">
                        <label class="form-label">Escalation Preset</label>
                        <select class="form-input" id="wiz-policy-preset"
                                onchange="updateWizPolicyHint()">
                            <option value="" ${!wizardData._POLICY_PRESET ? 'selected' : ''}>Keep current</option>
                            <option value="default" ${wizardData._POLICY_PRESET === 'default' ? 'selected' : ''}>Default (standard escalation)</option>
                            <option value="testing" ${wizardData._POLICY_PRESET === 'testing' ? 'selected' : ''}>Testing (fast cycle ‚Äî minutes)</option>
                            <option value="gentle" ${wizardData._POLICY_PRESET === 'gentle' ? 'selected' : ''}>Gentle (slow ramp ‚Äî extended delays)</option>
                            <option value="direct_full" ${wizardData._POLICY_PRESET === 'direct_full' ? 'selected' : ''}>Direct to FULL (skip reminders)</option>
                        </select>
                        <div id="wiz-policy-hint" class="form-hint">
                            Controls timing between escalation stages.
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <a href="#" onclick="event.preventDefault(); openPolicyModal();"
                               style="color: var(--info); font-size: 0.82rem; font-weight: 600;">
                                ‚öôÔ∏è Fine-tune individual rules & timing ‚Üí
                            </a>
                        </div>
                    </div>
                `,
                validate: () => {
                    const name = document.getElementById('wiz-project-name')?.value;
                    const email = document.getElementById('wiz-operator-email')?.value;
                    if (!name) { alert('Project name is required'); return false; }
                    if (!email) { alert('Operator email is required'); return false; }
                    return true;
                },
                collect: () => {
                    const mode = document.querySelector('input[name="wiz-mode"]:checked')?.value || 'renewable_countdown';
                    wizardData.MODE = mode;
                    wizardData._POLICY_PRESET = document.getElementById('wiz-policy-preset')?.value || '';
                    return {
                        PROJECT_NAME: document.getElementById('wiz-project-name').value,
                        OPERATOR_EMAIL: document.getElementById('wiz-operator-email').value,
                        ADAPTER_MOCK_MODE: document.getElementById('wiz-mock-mode').value,
                    };
                }
            },
            {
                id: 'deadline',
                title: 'Timer',
                // Only show this step in renewable_countdown mode
                skip: () => (wizardData.MODE || 'renewable_countdown') !== 'renewable_countdown',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">‚è∞ Countdown Deadline</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                        How long before the system activates? This is the dead man's switch timer.
                        If you don't renew before the deadline, escalation begins.
                    </p>
                    <div class="form-group">
                        <label class="form-label">Initial Deadline (hours from now)</label>
                        <div style="display: flex; gap: 0.75rem; margin-top: 0.5rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.DEADLINE_HOURS || 48) == 24 ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="deadline-hours" value="24" ${(wizardData.DEADLINE_HOURS || 48) == 24 ? 'checked' : ''} onchange="wizardData.DEADLINE_HOURS=24">
                                <div><strong>24h</strong><div style="color: var(--text-dim); font-size: 0.8rem;">1 day</div></div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.DEADLINE_HOURS || 48) == 48 ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="deadline-hours" value="48" ${(wizardData.DEADLINE_HOURS || 48) == 48 ? 'checked' : ''} onchange="wizardData.DEADLINE_HOURS=48">
                                <div><strong>48h</strong> <span style="color: var(--accent);">Default</span><div style="color: var(--text-dim); font-size: 0.8rem;">2 days</div></div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.DEADLINE_HOURS || 48) == 72 ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="deadline-hours" value="72" ${(wizardData.DEADLINE_HOURS || 48) == 72 ? 'checked' : ''} onchange="wizardData.DEADLINE_HOURS=72">
                                <div><strong>72h</strong><div style="color: var(--text-dim); font-size: 0.8rem;">3 days</div></div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: ${(wizardData.DEADLINE_HOURS || 48) == 168 ? 'var(--accent-dim)' : 'transparent'};">
                                <input type="radio" name="deadline-hours" value="168" ${(wizardData.DEADLINE_HOURS || 48) == 168 ? 'checked' : ''} onchange="wizardData.DEADLINE_HOURS=168">
                                <div><strong>168h</strong><div style="color: var(--text-dim); font-size: 0.8rem;">1 week</div></div>
                            </label>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">Or set a custom value:</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="number" class="form-input" id="wiz-custom-deadline" 
                                   placeholder="hours" min="1" max="8760"
                                   style="width: 120px;"
                                   value="${wizardData.DEADLINE_HOURS && ![24, 48, 72, 168].includes(wizardData.DEADLINE_HOURS) ? wizardData.DEADLINE_HOURS : ''}"
                                   oninput="wizardData.DEADLINE_HOURS=parseInt(this.value)">
                            <span style="color: var(--text-dim);">hours</span>
                        </div>
                    </div>
                    <div class="alert info" style="margin-top: 1rem;">
                        ‚è±Ô∏è <strong>How it works:</strong> You must renew before the deadline expires.
                        The system checks every 30 minutes. As the deadline approaches, escalation
                        stages trigger (reminders ‚Üí warnings ‚Üí disclosure).
                        You can always change this later from the Dashboard.
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    const radio = document.querySelector('input[name="deadline-hours"]:checked');
                    const custom = document.getElementById('wiz-custom-deadline')?.value;
                    return {
                        DEADLINE_HOURS: custom ? parseInt(custom) : (radio ? parseInt(radio.value) : 48),
                        _DEADLINE_TOUCHED: true,
                    };
                }
            },
            {
                id: 'email',
                title: 'Email',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üìß Email Configuration</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1rem;">
                        Configure email notifications using <a href="https://resend.com" target="_blank" style="color: var(--info);">Resend</a>.
                        Free tier supports 100 emails/day.
                    </p>
                    <details style="margin-bottom: 1.25rem;">
                        <summary style="cursor: pointer; color: var(--info); font-weight: 600;">üìñ Setup Guide (3 steps)</summary>
                        <ol style="color: var(--text-dim); line-height: 2; margin: 0.75rem 0 0 1.5rem; font-size: 0.9rem;">
                            <li>Create a free account at <a href="https://resend.com/signup" target="_blank" style="color: var(--info);">resend.com/signup</a></li>
                            <li>Go to <a href="https://resend.com/api-keys" target="_blank" style="color: var(--info);">API Keys</a> ‚Üí click <strong>"Create API Key"</strong> ‚Üí give it a name ‚Üí copy the key (starts with <code>re_</code>)</li>
                            <li>If you own a domain, <a href="https://resend.com/domains" target="_blank" style="color: var(--info);">verify it</a> to send from your own address. Otherwise the default <code>onboarding@resend.dev</code> works for testing.</li>
                        </ol>
                    </details>
                    <div class="form-group">
                        <label class="form-label">Resend API Key *</label>
                        <input type="password" class="form-input" id="wiz-resend-key"
                               placeholder="re_xxxxxxxxxx"
                               title="Your Resend API key. Find it at resend.com ‚Üí API Keys. Starts with re_">
                        <div class="form-hint">
                            Paste from <a href="https://resend.com/api-keys" target="_blank" style="color: var(--info);">resend.com/api-keys</a>
                            ${appData?.secrets?.find(s => s.name === 'RESEND_API_KEY')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">From Email</label>
                        <input type="email" class="form-input" id="wiz-resend-from"
                               placeholder="noreply@yourdomain.com" value="${getSecretValue('RESEND_FROM_EMAIL')}"
                               title="Sender address shown in the From field. Must be a verified domain in Resend, or use the default onboarding@resend.dev for testing.">
                        <div class="form-hint">Leave blank to use the default <code>onboarding@resend.dev</code> (works for testing)</div>
                    </div>
                    <div style="margin-top: 1rem; padding: 0.5rem 0.75rem; border-radius: 6px; background: rgba(99,102,241,0.08); font-size: 0.82rem; color: var(--text-dim);">
                        üí° After setup, test this from the <a href="#integrations" onclick="switchTab('integrations'); return false;" style="color: var(--info); font-weight: 600;">Integrations</a> tab.
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    const result = {};
                    const key = document.getElementById('wiz-resend-key').value;
                    if (key) result.RESEND_API_KEY = key;
                    const from = document.getElementById('wiz-resend-from').value;
                    if (from) result.RESEND_FROM_EMAIL = from;
                    return result;
                }
            },
            {
                id: 'sms',
                title: 'SMS',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üì± SMS Notifications (Twilio)</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1rem;">
                        <em>Optional</em> ‚Äî Send SMS alerts using <a href="https://www.twilio.com/try-twilio" target="_blank" style="color: var(--info);">Twilio</a>.
                    </p>
                    <details style="margin-bottom: 1.25rem;">
                        <summary style="cursor: pointer; color: var(--info); font-weight: 600;">üìñ Setup Guide (4 steps)</summary>
                        <ol style="color: var(--text-dim); line-height: 2; margin: 0.75rem 0 0 1.5rem; font-size: 0.9rem;">
                            <li>Sign up for a free trial at <a href="https://www.twilio.com/try-twilio" target="_blank" style="color: var(--info);">twilio.com/try-twilio</a> (includes free credits)</li>
                            <li>Once logged in, your <strong>Account SID</strong> and <strong>Auth Token</strong> are shown right on the <a href="https://console.twilio.com/" target="_blank" style="color: var(--info);">Console dashboard</a></li>
                            <li>Get a free phone number: <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/incoming" target="_blank" style="color: var(--info);">Phone Numbers ‚Üí Manage ‚Üí Buy a Number</a> (trial gives you one for free)</li>
                            <li>On trial accounts, you must <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/verified" target="_blank" style="color: var(--info);">verify your personal number</a> as a Verified Caller ID before sending</li>
                        </ol>
                    </details>
                    <div class="form-group">
                        <label class="form-label">Account SID</label>
                        <input type="text" class="form-input" id="wiz-twilio-sid"
                               placeholder="ACxxxxxxxxxx" value="${getSecretValue('TWILIO_ACCOUNT_SID')}"
                               title="Your Account SID. Found at the top of console.twilio.com. Starts with AC.">
                        <div class="form-hint">Starts with <code>AC</code> ‚Äî visible on your <a href="https://console.twilio.com/" target="_blank" style="color: var(--info);">Console dashboard</a></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Auth Token</label>
                        <input type="password" class="form-input" id="wiz-twilio-token"
                               placeholder="xxxxxxxxxx"
                               title="Your Auth Token. Found on console.twilio.com next to your Account SID. Click 'Show' to reveal it.">
                        <div class="form-hint">
                            Click "Show" next to Auth Token on console.twilio.com
                            ${appData?.secrets?.find(s => s.name === 'TWILIO_AUTH_TOKEN')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Twilio Phone Number</label>
                        <input type="text" class="form-input" id="wiz-twilio-from"
                               placeholder="+1234567890" value="${getSecretValue('TWILIO_FROM_NUMBER')}"
                               title="The Twilio number that sends SMS. Format: +1XXXXXXXXXX. Get one free with trial at Phone Numbers ‚Üí Buy a Number.">
                        <div class="form-hint">Format: <code>+1XXXXXXXXXX</code> ‚Äî your Twilio-assigned number</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Your Phone Number</label>
                        <input type="text" class="form-input" id="wiz-operator-sms"
                               placeholder="+1234567890" value="${getSecretValue('OPERATOR_SMS')}"
                               title="Your personal phone number where you want to receive alerts. Must be verified as a Caller ID during Twilio trial.">
                        <div class="form-hint">Where to send SMS alerts (must be <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/verified" target="_blank" style="color: var(--info);">verified</a> on trial accounts)</div>
                    </div>
                    <div style="margin-top: 1rem; padding: 0.5rem 0.75rem; border-radius: 6px; background: rgba(99,102,241,0.08); font-size: 0.82rem; color: var(--text-dim);">
                        üí° After setup, test this from the <a href="#integrations" onclick="switchTab('integrations'); return false;" style="color: var(--info); font-weight: 600;">Integrations</a> tab.
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    const result = {};
                    const sid = document.getElementById('wiz-twilio-sid').value;
                    if (sid) result.TWILIO_ACCOUNT_SID = sid;
                    const token = document.getElementById('wiz-twilio-token').value;
                    if (token) result.TWILIO_AUTH_TOKEN = token;
                    const from = document.getElementById('wiz-twilio-from').value;
                    if (from) result.TWILIO_FROM_NUMBER = from;
                    const sms = document.getElementById('wiz-operator-sms').value;
                    if (sms) result.OPERATOR_SMS = sms;
                    return result;
                }
            },
            {
                id: 'twitter',
                title: 'X',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üê¶ X/Twitter Integration</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1rem;">
                        <em>Optional</em> ‚Äî Post automated updates to X (Twitter). Free tier: ~500 posts/month.
                    </p>
                    <details style="margin-bottom: 1.25rem;">
                        <summary style="cursor: pointer; color: var(--info); font-weight: 600;">üìñ Setup Guide</summary>
                        <ol style="color: var(--text-dim); line-height: 2; margin: 0.75rem 0 0 1.5rem; font-size: 0.9rem;">
                            <li>Go to <a href="https://developer.x.com/en/portal/dashboard" target="_blank" style="color: var(--info);">developer.x.com/portal/dashboard</a> and sign in (sign up for a developer account if prompted)</li>
                            <li>Create a <strong>Project</strong>, then create an <strong>App</strong> inside it</li>
                            <li>In your App ‚Üí <strong>Settings</strong> ‚Üí <strong>User authentication settings</strong> ‚Üí click <strong>Set up</strong>:
                                <ul style="margin: 0.25rem 0 0.25rem 1rem; line-height: 1.8;">
                                    <li>App permissions: <strong>Read and Write</strong></li>
                                    <li>Type of App: <strong>Web App, Automated App or Bot</strong></li>
                                    <li>Callback URL: <code style="background: var(--bg-input); padding: 0.1rem 0.4rem; border-radius: 3px;">https://example.com/callback</code> (any valid URL ‚Äî not actually used)</li>
                                    <li>Website URL: any valid URL</li>
                                </ul>
                            </li>
                            <li>Go to <strong>Keys and Tokens</strong> tab:
                                <ul style="margin: 0.25rem 0 0.25rem 1rem; line-height: 1.8;">
                                    <li><strong>Consumer Keys</strong> section ‚Üí copy <strong>API Key</strong> and <strong>API Key Secret</strong> (regenerate if needed)</li>
                                    <li><strong>Authentication Tokens</strong> section ‚Üí click <strong>Generate</strong> to get <strong>Access Token</strong> and <strong>Access Token Secret</strong></li>
                                </ul>
                            </li>
                        </ol>
                        <div style="margin-top: 0.75rem; padding: 0.6rem 0.8rem; border-radius: 6px; background: rgba(245,158,11,0.1); font-size: 0.82rem; color: var(--warning);">
                            ‚ö†Ô∏è <strong>Important:</strong> You must set up User Authentication (step 3) with Read+Write <em>before</em> generating tokens. If you already generated tokens, regenerate them after changing permissions.
                        </div>
                    </details>
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="wiz-x-api-key" placeholder="xxxxxxxxxx"
                               title="Also called 'Consumer Key'. Found in Developer Portal ‚Üí App ‚Üí Keys and Tokens ‚Üí Consumer Keys.">
                        <div class="form-hint">Also called Consumer Key ‚Äî under "Consumer Keys" ${appData?.secrets?.find(s => s.name === 'X_API_KEY')?.set ? '<span style="color: var(--accent);">‚úì Already set</span>' : ''}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">API Secret</label>
                        <input type="password" class="form-input" id="wiz-x-api-secret" placeholder="xxxxxxxxxx"
                               title="Also called 'Consumer Secret'. Shown only once when generated ‚Äî save it immediately.">
                        <div class="form-hint">Also called Consumer Secret ‚Äî shown once at generation ${appData?.secrets?.find(s => s.name === 'X_API_SECRET')?.set ? '<span style="color: var(--accent);">‚úì Already set</span>' : ''}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Access Token</label>
                        <input type="password" class="form-input" id="wiz-x-access-token" placeholder="xxxxxxxxxx"
                               title="Your account's access token. Found under 'Authentication Tokens' in the Keys and Tokens tab.">
                        <div class="form-hint">Under "Authentication Tokens" ‚Äî click Generate ${appData?.secrets?.find(s => s.name === 'X_ACCESS_TOKEN')?.set ? '<span style="color: var(--accent);">‚úì Already set</span>' : ''}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Access Token Secret</label>
                        <input type="password" class="form-input" id="wiz-x-access-secret" placeholder="xxxxxxxxxx"
                               title="Your account's access token secret. Shown only once when generated ‚Äî save it immediately.">
                        <div class="form-hint">Paired with Access Token ‚Äî shown once at generation ${appData?.secrets?.find(s => s.name === 'X_ACCESS_SECRET')?.set ? '<span style="color: var(--accent);">‚úì Already set</span>' : ''}</div>
                    </div>
                    <div style="margin-top: 1rem; padding: 0.5rem 0.75rem; border-radius: 6px; background: rgba(99,102,241,0.08); font-size: 0.82rem; color: var(--text-dim);">
                        üí° After setup, check status from the <a href="#integrations" onclick="switchTab('integrations'); return false;" style="color: var(--info); font-weight: 600;">Integrations</a> tab.
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    const result = {};
                    const apiKey = document.getElementById('wiz-x-api-key').value;
                    if (apiKey) result.X_API_KEY = apiKey;
                    const apiSecret = document.getElementById('wiz-x-api-secret').value;
                    if (apiSecret) result.X_API_SECRET = apiSecret;
                    const accessToken = document.getElementById('wiz-x-access-token').value;
                    if (accessToken) result.X_ACCESS_TOKEN = accessToken;
                    const accessSecret = document.getElementById('wiz-x-access-secret').value;
                    if (accessSecret) result.X_ACCESS_SECRET = accessSecret;
                    return result;
                }
            },
            {
                id: 'reddit',
                title: 'Reddit',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">ü§ñ Reddit Integration</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1rem;">
                        <em>Optional</em> ‚Äî Post automated updates to Reddit via a "script" app.
                    </p>
                    <details style="margin-bottom: 1.25rem;">
                        <summary style="cursor: pointer; color: var(--info); font-weight: 600;">üìñ Setup Guide (6 steps)</summary>
                        <ol style="color: var(--text-dim); line-height: 2; margin: 0.75rem 0 0 1.5rem; font-size: 0.9rem;">
                            <li>Go to <a href="https://www.reddit.com/prefs/apps" target="_blank" style="color: var(--info);">reddit.com/prefs/apps</a> (log in with the account that will post)</li>
                            <li>Scroll down and click <strong>"create another app‚Ä¶"</strong></li>
                            <li>Fill in: <strong>name</strong> (anything), select <strong>"script"</strong>, and set <strong>redirect URI</strong> to <code>http://localhost</code></li>
                            <li style="font-size: 0.85rem; color: var(--text-dim);"><em>‚ÑπÔ∏è The redirect URI is required by Reddit but never actually used for script apps ‚Äî any valid URL works</em></li>
                            <li>Click <strong>"create app"</strong> ‚Äî you'll see the <strong>Client ID</strong> (short string under the app name) and <strong>secret</strong> (labeled "secret")</li>
                            <li>Enter your Reddit login credentials below ‚Äî script apps authenticate directly with username/password</li>
                        </ol>
                    </details>
                    <div class="form-group">
                        <label class="form-label">Client ID</label>
                        <input type="text" class="form-input" id="wiz-reddit-client-id"
                               placeholder="xxxxxxxxxx" value="${getSecretValue('REDDIT_CLIENT_ID')}"
                               title="A short string shown directly under your app name on reddit.com/prefs/apps. It's NOT the app name itself.">
                        <div class="form-hint">Short string under your app name (not the app name itself)</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Client Secret</label>
                        <input type="password" class="form-input" id="wiz-reddit-client-secret" placeholder="xxxxxxxxxx"
                               title="Labeled 'secret' on your app page at reddit.com/prefs/apps.">
                        <div class="form-hint">Labeled "secret" on the app page ${appData?.secrets?.find(s => s.name === 'REDDIT_CLIENT_SECRET')?.set ? '<span style="color: var(--accent);">‚úì Already set</span>' : ''}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reddit Username</label>
                        <input type="text" class="form-input" id="wiz-reddit-username"
                               placeholder="your_username" value="${getSecretValue('REDDIT_USERNAME')}"
                               title="The Reddit account username that created the script app. Posts will be made from this account.">
                        <div class="form-hint">The account that will post ‚Äî must match the app owner</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reddit Password</label>
                        <input type="password" class="form-input" id="wiz-reddit-password" placeholder="xxxxxxxxxx"
                               title="The Reddit account password. Required for script app authentication. If you use 2FA, you may need an app-specific password.">
                        <div class="form-hint">If you use 2FA, you'll need an app-specific password ${appData?.secrets?.find(s => s.name === 'REDDIT_PASSWORD')?.set ? '<span style="color: var(--accent);">‚úì Already set</span>' : ''}</div>
                    </div>
                    <div style="margin-top: 1rem; padding: 0.5rem 0.75rem; border-radius: 6px; background: rgba(99,102,241,0.08); font-size: 0.82rem; color: var(--text-dim);">
                        üí° After setup, check status from the <a href="#integrations" onclick="switchTab('integrations'); return false;" style="color: var(--info); font-weight: 600;">Integrations</a> tab.
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    const result = {};
                    const clientId = document.getElementById('wiz-reddit-client-id').value;
                    if (clientId) result.REDDIT_CLIENT_ID = clientId;
                    const clientSecret = document.getElementById('wiz-reddit-client-secret').value;
                    if (clientSecret) result.REDDIT_CLIENT_SECRET = clientSecret;
                    const username = document.getElementById('wiz-reddit-username').value;
                    if (username) result.REDDIT_USERNAME = username;
                    const password = document.getElementById('wiz-reddit-password').value;
                    if (password) result.REDDIT_PASSWORD = password;
                    return result;
                }
            },
            {
                id: 'security',
                title: 'Security',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üîê Security & GitHub</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                        Security secrets and GitHub configuration.
                    </p>
                    
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--text-dim); font-size: 0.9rem;">üîë SECURITY SECRETS</h3>
                    <div class="form-group">
                        <label class="form-label">Renewal Secret *</label>
                        <input type="password" class="form-input" id="wiz-renewal-secret" 
                               placeholder="Enter a secure passphrase">
                        <div class="form-hint">
                            Code to extend the deadline
                            ${appData?.secrets?.find(s => s.name === 'RENEWAL_SECRET')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Release Secret</label>
                        <input type="password" class="form-input" id="wiz-release-secret" 
                               placeholder="Enter a different passphrase">
                        <div class="form-hint">
                            Code to trigger early disclosure (optional)
                            ${appData?.secrets?.find(s => s.name === 'RELEASE_SECRET')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Renewal Trigger Token</label>
                        <input type="password" class="form-input" id="wiz-renewal-trigger-token" 
                               placeholder="github_pat_xxxxxxxxxx">
                        <div class="form-hint">
                            Fine-grained GitHub PAT for one-click renewal from the public site (optional)
                            ${appData?.secrets?.find(s => s.name === 'RENEWAL_TRIGGER_TOKEN')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                        <details style="margin-top: 0.75rem;">
                            <summary style="cursor: pointer; color: var(--info); font-size: 0.85rem;">üìñ How to create a fine-grained PAT</summary>
                            <div style="color: var(--text-dim); line-height: 1.8; margin: 0.75rem 0 0 0; font-size: 0.85rem; padding: 0.75rem; background: var(--bg-input); border-radius: 6px;">
                                <ol style="margin: 0 0 0 1.25rem; padding: 0;">
                                    <li>Go to <a href="https://github.com/settings/tokens?type=beta" target="_blank" style="color: var(--info);">GitHub ‚Üí Settings ‚Üí Fine-grained tokens</a></li>
                                    <li>Click <strong>"Generate new token"</strong></li>
                                    <li>Set <strong>Token name</strong>: <code>continuity-renewal</code></li>
                                    <li>Set <strong>Expiration</strong>: 90 days (or custom)</li>
                                    <li>Under <strong>Repository access</strong>, select <em>"Only select repositories"</em> and pick your continuity repo</li>
                                    <li>Under <strong>Permissions ‚Üí Actions</strong>, set to <strong>Read and write</strong> (needed to trigger workflows)</li>
                                    <li>Click <strong>"Generate token"</strong> and paste the <code>github_pat_...</code> value above</li>
                                </ol>
                                <p style="margin: 0.75rem 0 0 0;">
                                    ‚ö†Ô∏è This token allows triggering the renewal workflow from the public site's "Renew" button.
                                    Only grant the minimum permissions needed.
                                </p>
                            </div>
                        </details>
                    </div>
                    
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--text-dim); font-size: 0.9rem;">üîí CONTENT ENCRYPTION</h3>
                    <div class="form-group">
                        <label class="form-label">Encryption Key</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="password" class="form-input" id="wiz-content-encryption-key" placeholder="Leave blank to skip" style="flex: 1;">
                            <button type="button" class="btn" onclick="wizGenContentKey()" title="Generate a random key">üîë Generate</button>
                        </div>
                        <div class="form-hint">
                            Passphrase for encrypting article content stored in the repo (optional)
                            ${appData?.secrets?.find(s => s.name === 'CONTENT_ENCRYPTION_KEY')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                    </div>
                    
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--text-dim); font-size: 0.9rem;">üêô GITHUB CONFIGURATION</h3>
                    <div class="form-group">
                        <label class="form-label">GitHub Repository</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="wiz-github-repo" 
                                   placeholder="owner/repo" value="${getSecretValue('GITHUB_REPOSITORY')}" style="flex: 1;">
                            <button type="button" class="btn" onclick="autoDetectGitHub()" title="Detect from git remote">üîç Detect</button>
                        </div>
                        <div class="form-hint">Auto-detected from git remote if available</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">GitHub Token</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="password" class="form-input" id="wiz-github-token" 
                                   placeholder="ghp_xxxxxxxxxx or auto-detect" style="flex: 1;">
                            <button type="button" class="btn" onclick="autoDetectGitHub()" title="Get from gh CLI">üîë Get from gh</button>
                        </div>
                        <div class="form-hint">
                            Auto-detect from <code>gh auth token</code> or <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--info);">generate manually</a>
                            ${appData?.secrets?.find(s => s.name === 'GITHUB_TOKEN')?.set ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                        </div>
                    </div>
                `,
                validate: () => true,
                collect: () => {
                    const result = {};
                    const renewal = document.getElementById('wiz-renewal-secret').value;
                    if (renewal) result.RENEWAL_SECRET = renewal;
                    const release = document.getElementById('wiz-release-secret').value;
                    if (release) result.RELEASE_SECRET = release;
                    const triggerToken = document.getElementById('wiz-renewal-trigger-token').value;
                    if (triggerToken) result.RENEWAL_TRIGGER_TOKEN = triggerToken;
                    const encKey = document.getElementById('wiz-content-encryption-key').value;
                    if (encKey) result.CONTENT_ENCRYPTION_KEY = encKey;
                    const github = document.getElementById('wiz-github-token').value;
                    if (github) result.GITHUB_TOKEN = github;
                    const repo = document.getElementById('wiz-github-repo').value;
                    if (repo) result.GITHUB_REPOSITORY = repo;
                    return result;
                }
            },
            {
                id: 'archive',
                title: 'Archive',
                content: () => {
                    const archiveEnabled = getSecretValue('ARCHIVE_ENABLED') === 'true';
                    const archiveUrl = getSecretValue('ARCHIVE_URL');

                    return `
                        <h2 style="margin-bottom: 1rem;">üì¶ Internet Archive</h2>
                        <p style="color: var(--text-dim); margin-bottom: 0.5rem;">
                            <em>Optional</em> ‚Äî Automatically save snapshots to <a href="https://archive.org" target="_blank" style="color: var(--info);">archive.org</a>
                        </p>
                        <p style="color: var(--text-dim); margin-bottom: 1.5rem; font-size: 0.9rem;">
                            Creates an immutable, third-party record of your published site, 
                            providing resilience even if GitHub Pages goes down.
                        </p>
                        
                        <div class="form-group">
                            <label class="form-label">Enable Auto-Archive</label>
                            <select class="form-input" id="wiz-archive-enabled" style="width: auto; min-width: 200px;">
                                <option value="false" ${!archiveEnabled ? 'selected' : ''}>‚ùå Disabled</option>
                                <option value="true" ${archiveEnabled ? 'selected' : ''}>‚úÖ Enabled</option>
                            </select>
                            <div class="form-hint">Archive to Wayback Machine after each site publish</div>
                        </div>
                        
                        <div class="form-group" id="archive-url-group" style="${archiveEnabled ? '' : 'opacity: 0.5;'}">
                            <label class="form-label">Custom Archive URL</label>
                            <input type="text" class="form-input" id="wiz-archive-url" 
                                   placeholder="Leave empty for GitHub Pages auto-detect"
                                   value="${archiveUrl || ''}">
                            <div class="form-hint">
                                For Docker + Cloudflare deployments. Leave empty to use GitHub Pages URL.
                            </div>
                        </div>
                        
                        <details style="margin-top: 1.5rem;">
                            <summary style="cursor: pointer; color: var(--info);">‚ÑπÔ∏è Why archive?</summary>
                            <ul style="color: var(--text-dim); line-height: 1.8; margin: 1rem 0 0 1.5rem; font-size: 0.9rem;">
                                <li><strong>Resilience:</strong> Independent backup of your public site</li>
                                <li><strong>Proof:</strong> Timestamped snapshots prove content existed at a point in time</li>
                                <li><strong>Free:</strong> No API key needed (3 archives/minute)</li>
                                <li><strong>Optional:</strong> Can be triggered manually from Command Center</li>
                            </ul>
                        </details>
                    `;
                },
                validate: () => true,
                collect: () => {
                    const result = {};
                    const enabled = document.getElementById('wiz-archive-enabled').value;
                    result.ARCHIVE_ENABLED = enabled;
                    const url = document.getElementById('wiz-archive-url').value;
                    if (url) result.ARCHIVE_URL = url;
                    return result;
                }
            },
            {
                id: 'mirror',
                title: 'Mirror',
                content: () => {
                    const mirrorEnabled = getSecretValue('MIRROR_ENABLED') === 'true';
                    const mirrorRepo = getSecretValue('MIRROR_1_REPO') || '';
                    const mirrorToken = getSecretValue('MIRROR_1_TOKEN');
                    const renewalToken = getSecretValue('MIRROR_1_RENEWAL_TRIGGER_TOKEN');
                    const resetMode = getSecretValue('MIRROR_RESET_MODE') || 'leader';

                    return `
                        <h2 style="margin-bottom: 1rem;">üîÅ Repo Mirror</h2>
                        <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                            <em>Optional</em> ‚Äî Keep a full copy of this repo on a second GitHub account.
                            If the primary ever goes down, the mirror automatically takes over. When the primary
                            recovers, the mirror stands down and re-syncs.
                        </p>

                        <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; margin-bottom: 1.5rem;">
                            <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 0.9rem;">üìã Setup checklist (do this first):</div>
                            <ol style="color: var(--text-dim); line-height: 2; margin: 0 0 0 1.25rem; font-size: 0.88rem;">
                                <li>Create a <strong>second GitHub account</strong> (or use an existing backup account)</li>
                                <li>On that account, create a <strong>new empty private repository</strong>
                                    <br><span style="font-size: 0.8rem; opacity: 0.7;">‚Üí github.com/new ¬∑ Don't initialize with README</span>
                                </li>
                                <li>On that account, go to <strong>Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Fine-grained tokens</strong>
                                    <br><span style="font-size: 0.8rem; opacity: 0.7;">‚Üí <a href="https://github.com/settings/tokens?type=beta" target="_blank" style="color: var(--info);">github.com/settings/tokens</a></span>
                                </li>
                                <li>Generate a token with <strong>repository access</strong> to the backup repo:
                                    <br><span style="font-size: 0.8rem; opacity: 0.7;">Permissions (all read/write): <code>Contents</code>, <code>Actions</code>, <code>Workflows</code>, <code>Secrets</code>, <code>Variables</code>, <code>Pages</code>, <code>Environments</code>, <code>Deployments</code>, <code>Metadata</code> (read)</span>
                                </li>
                                <li>Paste the repo name and token below ‚Üì</li>
                            </ol>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Enable Mirror</label>
                            <select class="form-input" id="wiz-mirror-enabled" style="width: auto; min-width: 200px;"
                                    onchange="document.getElementById('mirror-config-group').style.opacity = this.value === 'true' ? '1' : '0.5';">
                                <option value="false" ${!mirrorEnabled ? 'selected' : ''}>‚ùå Disabled</option>
                                <option value="true" ${mirrorEnabled ? 'selected' : ''}>‚úÖ Enabled</option>
                            </select>
                        </div>

                        <div id="mirror-config-group" style="${mirrorEnabled ? '' : 'opacity: 0.5;'}">
                            <div class="form-group">
                                <label class="form-label">Backup Repository</label>
                                <input type="text" class="form-input" id="wiz-mirror-repo"
                                       placeholder="backup-user/repo-name or paste full URL"
                                       value="${mirrorRepo}"
                                       onblur="normalizeMirrorRepo(this)">
                                <div class="form-hint">
                                    The empty repo you created on the backup account. Paste a URL or type <code>owner/repo</code>
                                    ${mirrorRepo ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Backup Account Token</label>
                                <input type="password" class="form-input" id="wiz-mirror-token"
                                       placeholder="${mirrorToken ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'github_pat_...'}"
                                       value="">
                                <div class="form-hint">
                                    The personal access token you generated on the backup account.
                                    ${mirrorToken ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                                </div>
                            </div>

                            <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; margin-top: 1.25rem;">
                                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 0.9rem;">üîë Renewal Token for Mirror <span style="font-weight: normal; font-size: 0.8rem; color: var(--text-dim);">(optional)</span></div>
                                <p style="color: var(--text-dim); font-size: 0.85rem; line-height: 1.6; margin-bottom: 0.75rem;">
                                    If you want the mirror to support <strong>one-click renewal</strong> when it takes over,
                                    it needs its own trigger token. This is a <strong>separate PAT</strong> created on
                                    the <strong>backup account</strong>, scoped to the <strong>backup repo</strong>.
                                </p>
                                <ol style="color: var(--text-dim); line-height: 2; margin: 0 0 1rem 1.25rem; font-size: 0.85rem;">
                                    <li>On the <strong>backup account</strong>, go to <a href="https://github.com/settings/tokens?type=beta" target="_blank" style="color: var(--info);">Fine-grained tokens</a></li>
                                    <li>Create a token scoped to the <strong>backup repo only</strong></li>
                                    <li>Permissions: <code>Actions</code> (read/write) ‚Äî that's all it needs</li>
                                    <li>Paste below ‚Üì</li>
                                </ol>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label">Mirror Renewal Trigger Token</label>
                                    <input type="password" class="form-input" id="wiz-mirror-renewal-token"
                                           placeholder="${renewalToken ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'github_pat_...'}"
                                           value="">
                                    <div class="form-hint">
                                        Stored as <code>MIRROR_1_RENEWAL_TRIGGER_TOKEN</code> on master. Synced as <code>RENEWAL_TRIGGER_TOKEN</code> to mirror.
                                        ${renewalToken ? '<span style="color: var(--accent);"> ‚úì Already set</span>' : ''}
                                    </div>
                                </div>
                            </div>

                            <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; margin-top: 1.25rem;">
                                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 0.9rem;">üõ° Reset Protection <span style="font-weight: normal; font-size: 0.8rem; color: var(--text-dim);">(recommended: isolated)</span></div>
                                <p style="color: var(--text-dim); font-size: 0.85rem; line-height: 1.6; margin-bottom: 0.75rem;">
                                    Controls whether a factory reset on the master cascades to the mirror.
                                </p>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label">Reset Mode</label>
                                    <select class="form-input" id="wiz-mirror-reset-mode" style="width: auto; min-width: 250px;">
                                        <option value="isolated" ${resetMode !== 'cascade' ? 'selected' : ''}>üõ° Isolated ‚Äî mirror keeps own state</option>
                                        <option value="cascade" ${resetMode === 'cascade' ? 'selected' : ''}>üîÑ Cascade ‚Äî reset propagates to mirror</option>
                                    </select>
                                    <div class="form-hint">
                                        <strong>Isolated (default):</strong> A factory reset only affects the master. The mirror
                                        keeps its state intact as a safety checkpoint ‚Äî an attacker with admin access
                                        cannot destroy both copies.<br>
                                        <strong>Cascade:</strong> The mirror stays in perfect sync with the master,
                                        including resets. Simpler, but both copies are equally vulnerable.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(74, 222, 128, 0.06); border: 1px solid rgba(74, 222, 128, 0.15); border-radius: 8px; font-size: 0.85rem; color: var(--text-dim); line-height: 1.7;">
                            <strong style="color: var(--accent);">What happens automatically:</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem;">
                                <li>Every git sync also pushes to the backup repo</li>
                                <li>All GitHub secrets and variables are copied to the backup</li>
                                <li>A sentinel workflow checks the primary's health every 30 min</li>
                                <li>If primary is unreachable for ~1.5 hours, the backup activates</li>
                                <li>When primary recovers, the backup stands down and re-syncs</li>
                            </ul>
                        </div>

                        <p style="margin-top: 1rem; font-size: 0.82rem; color: var(--text-dim);">
                            üí° After setup, monitor from the <a href="#integrations" onclick="switchTab('integrations'); return false;" style="color: var(--info); font-weight: 600;">Integrations</a> tab.
                        </p>
                    `;
                },
                validate: () => true,
                collect: () => {
                    const result = {};
                    const enabled = document.getElementById('wiz-mirror-enabled').value;
                    result.MIRROR_ENABLED = enabled;
                    if (enabled === 'true') {
                        const repo = document.getElementById('wiz-mirror-repo').value;
                        if (repo) result.MIRROR_1_REPO = repo;
                        const token = document.getElementById('wiz-mirror-token').value;
                        if (token) result.MIRROR_1_TOKEN = token;
                        const renewToken = document.getElementById('wiz-mirror-renewal-token').value;
                        if (renewToken) result.MIRROR_1_RENEWAL_TRIGGER_TOKEN = renewToken;
                        result.MIRROR_RESET_MODE = document.getElementById('wiz-mirror-reset-mode').value;
                    }
                    return result;
                }
            },
            {
                id: 'sentinel',
                title: 'Sentinel',
                skip: () => (wizardData.DEPLOY_MODE || 'github-pages') === 'docker',
                content: () => {
                    const sentinelUrl = getSecretValue('SENTINEL_URL');
                    const sentinelToken = getSecretValue('SENTINEL_TOKEN');
                    const isConfigured = !!(sentinelUrl && sentinelToken);

                    return `
                        <h2 style="margin-bottom: 1rem;">üõ∞Ô∏è Sentinel Worker</h2>
                        <p style="color: var(--text-dim); margin-bottom: 1.25rem;">
                            <em>Optional</em> ‚Äî Upgrades your tick schedule from "every 30 minutes via GitHub cron"
                            to "every 60 seconds via Cloudflare". Free tier, zero maintenance.
                        </p>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; padding: 1rem;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.85rem; opacity: 0.7;">Without sentinel</div>
                                <ul style="color: var(--text-dim); font-size: 0.82rem; line-height: 1.8; margin: 0 0 0 1rem;">
                                    <li>Cron ticks every <strong>30 minutes</strong></li>
                                    <li>Renewals take up to 30 min to register</li>
                                    <li>No external health monitoring</li>
                                </ul>
                            </div>
                            <div style="background: rgba(74, 222, 128, 0.06); border: 1px solid rgba(74, 222, 128, 0.15); border-radius: 10px; padding: 1rem;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--accent);">With sentinel</div>
                                <ul style="color: var(--text-dim); font-size: 0.82rem; line-height: 1.8; margin: 0 0 0 1rem;">
                                    <li>Checks every <strong>60 seconds</strong></li>
                                    <li>Renewals + releases respond in <strong>~1 min</strong></li>
                                    <li>Dashboard shows live Worker status</li>
                                </ul>
                            </div>
                        </div>

                        ${isConfigured ? '<div style="margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.2); border-radius: 8px;"><strong style="color: var(--accent);">‚úÖ Sentinel is configured</strong> ‚Äî the engine notifies it after every tick and state change.</div>' : ''}

                        <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; margin-bottom: 1.5rem;">
                            <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 0.9rem;">üöÄ Automated setup</div>
                            <p style="color: var(--text-dim); font-size: 0.85rem; line-height: 1.6; margin-bottom: 0.75rem;">
                                The setup script handles everything end-to-end ‚Äî creates the KV namespace, generates tokens,
                                deploys the Worker, and writes the config to <code>.env</code>.
                            </p>
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="flex: 1; background: var(--surface); padding: 0.5rem 0.75rem; border-radius: 6px; font-family: monospace; font-size: 0.85rem;">
                                    $ ./manage.sh sentinel
                                </div>
                                <button class="btn" onclick="setupSentinel(false)" style="padding: 0.4rem 1rem; white-space: nowrap;" title="Interactive ‚Äî confirms each step">
                                    ‚ñ∂Ô∏è Run
                                </button>
                                <button class="btn primary" onclick="setupSentinel(true)" style="padding: 0.4rem 1rem; white-space: nowrap;" title="Auto-confirm all steps (-y flag)">
                                    ‚ö° Auto-Run
                                </button>
                            </div>
                            <p style="color: var(--text-dim); font-size: 0.78rem; opacity: 0.7;">
                                Requires: <a href="https://dash.cloudflare.com/sign-up" target="_blank" style="color: var(--info);">Cloudflare account</a>
                                + <a href="https://nodejs.org" target="_blank" style="color: var(--info);">Node.js</a>
                                + a <a href="https://github.com/settings/tokens?type=beta" target="_blank" style="color: var(--info);">GitHub PAT</a> with Actions (write) scope.
                                The script will prompt for anything missing.
                            </p>
                        </div>

                        <details style="margin-bottom: 1.5rem;">
                            <summary style="cursor: pointer; color: var(--text-dim); font-size: 0.85rem; padding: 0.5rem 0;">
                                üîß I prefer to do it manually‚Ä¶
                            </summary>
                            <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0 0 10px 10px; padding: 1.25rem; margin-top: 0.5rem;">
                                <ol style="color: var(--text-dim); line-height: 2; margin: 0 0 0 1.25rem; font-size: 0.85rem;">
                                    <li>Install Wrangler: <code>npm install -g wrangler</code> then <code>wrangler login</code></li>
                                    <li>Register a workers.dev subdomain (if first Worker):
                                        <br><span style="opacity:0.7;">Go to <a href="https://dash.cloudflare.com/?to=/:account/workers/onboarding" target="_blank" style="color:var(--info);">Cloudflare dashboard ‚Üí Workers</a> and pick a subdomain</span>
                                    </li>
                                    <li><code>cd worker/sentinel && npm install</code></li>
                                    <li>Create KV: <code>npx wrangler kv namespace create SENTINEL_KV</code></li>
                                    <li>Copy the <code>id</code> from the output into <code>worker/sentinel/wrangler.toml</code> under <code>[[kv_namespaces]]</code></li>
                                    <li>Set <code>GITHUB_REPO = "owner/repo"</code> in the <code>[vars]</code> section of <code>wrangler.toml</code></li>
                                    <li>Generate auth token: <code>openssl rand -hex 32</code></li>
                                    <li>Set Worker secrets:
                                        <br><code>npx wrangler secret put SENTINEL_TOKEN</code> <span style="opacity:0.7;">(paste the token from step 7)</span>
                                        <br><code>npx wrangler secret put GITHUB_TOKEN</code> <span style="opacity:0.7;">(a GitHub PAT with <em>Actions: write</em> scope)</span>
                                    </li>
                                    <li>Deploy: <code>npx wrangler deploy</code></li>
                                    <li>Add to your <code>.env</code>:
                                        <br><code>SENTINEL_URL=https://&lt;worker-name&gt;.&lt;subdomain&gt;.workers.dev</code>
                                        <br><code>SENTINEL_TOKEN=&lt;token from step 7&gt;</code>
                                    </li>
                                    <li>Push both secrets to GitHub: <code>./manage.sh secrets</code></li>
                                    <li>Paste the Worker URL and auth token in the fields below</li>
                                </ol>
                            </div>
                        </details>

                        <div style="border-top: 1px solid var(--border); padding-top: 1.25rem;">
                            <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 0.9rem;">Connection details</div>
                            <p style="color: var(--text-dim); font-size: 0.82rem; margin-bottom: 1rem;">
                                ${isConfigured ? 'Already configured ‚Äî update below if needed.' : 'After deploying, paste the Worker URL and auth token here.'}
                            </p>
                            <div class="form-group">
                                <label class="form-label">Sentinel Worker URL</label>
                                <input type="text" class="form-input" id="wiz-sentinel-url"
                                       placeholder="https://continuity-sentinel.you.workers.dev"
                                       value="${sentinelUrl}">
                                <div class="form-hint">
                                    The URL from <code>wrangler deploy</code> output (no trailing slash).
                                    ${sentinelUrl ? '<span style="color: var(--accent);"> ‚úì Set</span>' : ''}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sentinel Auth Token</label>
                                <input type="password" class="form-input" id="wiz-sentinel-token"
                                       placeholder="${sentinelToken ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'The token you set as AUTH_TOKEN on the Worker'}"
                                       value="">
                                <div class="form-hint">
                                    Must match the Worker's <code>AUTH_TOKEN</code> secret.
                                    ${sentinelToken ? '<span style="color: var(--accent);"> ‚úì Set</span>' : ''}
                                </div>
                            </div>
                        </div>

                        <p style="margin-top: 0.75rem; font-size: 0.82rem; color: var(--text-dim);">
                            üí° Leave both fields empty to skip ‚Äî the system uses the GitHub Actions cron as fallback.
                        </p>
                    `;
                },
                validate: () => true,
                collect: () => {
                    const result = {};
                    const url = document.getElementById('wiz-sentinel-url')?.value?.trim()?.replace(/\/+$/, '');
                    const token = document.getElementById('wiz-sentinel-token')?.value?.trim();
                    if (url) result.SENTINEL_URL = url;
                    if (token) result.SENTINEL_TOKEN = token;
                    return result;
                }
            },
            {
                id: 'push',
                title: 'Push',
                content: () => {
                    const ghTool = appData?.tools?.find(t => t.name === 'gh');
                    const gitTool = appData?.tools?.find(t => t.name === 'git');
                    const ghOk = ghTool?.installed && ghTool?.authenticated;
                    const gitOk = gitTool?.installed;

                    return `
                        <h2 style="margin-bottom: 1rem;">üöÄ Push & Sync</h2>
                        <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                            Save configuration, push GitHub secrets, and sync your repo.
                        </p>

                        <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                            <!-- gh CLI status -->
                            ${ghOk ? `
                                <div class="alert success">
                                    ‚úÖ <strong>gh CLI authenticated</strong> ‚Äî Secrets will be pushed to GitHub.
                                </div>
                            ` : `
                                <div class="alert warning">
                                    ‚ö†Ô∏è <strong>gh CLI ${!ghTool?.installed ? 'not installed' : 'not authenticated'}</strong><br>
                                    <span style="font-size: 0.85rem; color: var(--text-dim);">
                                        Secrets will still be saved to <code>.env</code> locally.
                                    </span>
                                    <div style="margin-top: 0.75rem;">
                                        ${!ghTool?.installed
                            ? '<button class="btn" onclick="installGh()" style="margin-right: 0.5rem;">üì¶ Install gh CLI</button>'
                            : '<button class="btn" onclick="alert(\'Run: gh auth login\\n\\nIn your terminal, then refresh this page.\')" style="margin-right: 0.5rem;">üîë How to authenticate</button>'}
                                        <button class="btn" onclick="loadStatus().then(() => renderWizard())">üîÑ Refresh status</button>
                                    </div>
                                </div>
                            `}

                            <!-- Git sync option -->
                            <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-hover);">
                                <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
                                    <input type="checkbox" id="wiz-git-sync" ${gitOk ? 'checked' : 'disabled'}
                                           style="margin-top: 3px;">
                                    <div>
                                        <strong>üîÑ Git sync after push</strong>
                                        <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">
                                            Commit all changes and push to remote ‚Äî keeps your repo up to date
                                            with the latest config, state, and settings.
                                        </div>
                                        ${!gitOk ? '<div style="color: var(--warning); font-size: 0.8rem; margin-top: 0.25rem;">‚ö†Ô∏è git not detected</div>' : ''}
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div id="wizard-push-status"></div>
                    `;
                },
                validate: () => true
            },
            {
                id: 'complete',
                title: 'Done',
                content: () => `
                    <h2 style="margin-bottom: 1rem;">üéâ Setup Complete!</h2>
                    <p style="color: var(--text-dim); line-height: 1.6; margin-bottom: 1rem;">
                        Your Continuity Orchestrator is configured. Next steps:
                    </p>
                    <ul style="color: var(--text-dim); line-height: 1.8; margin-left: 1.5rem; margin-bottom: 1.5rem;">
                        <li>üìä Check the <strong>Dashboard</strong> for system status</li>
                        <li>‚ö° Run a <strong>Dry Run</strong> to test the tick cycle</li>
                        <li>üîê Configure additional secrets in the <strong>Secrets</strong> tab</li>
                    </ul>
                    <div class="actions">
                        <button class="btn primary" onclick="switchTab('dashboard')">Go to Dashboard ‚Üí</button>
                    </div>
                `,
                validate: () => true
            }
        ];

        let currentWizardStep = 0;
        let wizardData = {};
        let wizardDirty = false;

        function getSecretValue(name) {
            // First check envData (values from .env file)
            if (envData && envData[name]) {
                return envData[name];
            }
            return '';
        }

        function updateWizPolicyHint() {
            const sel = document.getElementById('wiz-policy-preset');
            const hint = document.getElementById('wiz-policy-hint');
            if (!sel || !hint) return;
            const descs = {
                '': 'Controls timing between escalation stages.',
                'default': '6h ‚Üí 1h ‚Üí 15min reminders, then immediate partial ‚Üí 2h full.',
                'testing': '90m ‚Üí 60m ‚Üí 30m reminders (aligned to ~30min cron ticks), 30m to full.',
                'gentle': '24h ‚Üí 6h ‚Üí 1h reminders, 1h partial delay ‚Üí 6h to full disclosure.',
                'direct_full': 'Disables all reminders & partial ‚Äî immediate full disclosure on expiry.',
            };
            hint.textContent = descs[sel.value] || descs[''];
        }

        // Auto-detect GitHub token and repo from gh CLI / git remote
        async function wizGenContentKey() {
            try {
                const response = await fetch('/api/content/keygen', { method: 'POST' });
                const data = await response.json();
                if (data.error) { alert('Failed: ' + data.error); return; }
                const input = document.getElementById('wiz-content-encryption-key');
                if (input) { input.type = 'text'; input.value = data.key; }
            } catch (error) { alert('Error: ' + error.message); }
        }

        async function autoDetectGitHub() {
            try {
                const response = await fetch('/api/gh/auto');
                const data = await response.json();

                let updated = [];

                if (data.token) {
                    const tokenInput = document.getElementById('wiz-github-token');
                    if (tokenInput && !tokenInput.value) {
                        tokenInput.value = data.token;
                        updated.push('token');
                    }
                }

                if (data.repo) {
                    const repoInput = document.getElementById('wiz-github-repo');
                    if (repoInput && !repoInput.value) {
                        repoInput.value = data.repo;
                        updated.push('repository');
                    }
                }

                if (updated.length > 0) {
                    alert(`‚úÖ Auto-detected: ${updated.join(' and ')}`);
                } else if (!data.token && !data.repo) {
                    alert('‚ö†Ô∏è Could not auto-detect. Make sure gh CLI is authenticated (gh auth login) and you have a git remote set.');
                } else {
                    alert('‚ÑπÔ∏è Fields already filled - no changes made.');
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Fill a specific secret from gh CLI (for Secrets tab)
        async function fillSecretFromGh(secretName) {
            try {
                const response = await fetch('/api/gh/auto');
                const data = await response.json();

                const input = document.getElementById(`secret-${secretName}`);
                if (!input) return;

                if (secretName === 'GITHUB_TOKEN' && data.token) {
                    input.value = data.token;
                    alert('‚úÖ Token retrieved from gh CLI');
                } else if (secretName === 'GITHUB_REPOSITORY' && data.repo) {
                    input.value = data.repo;
                    alert('‚úÖ Repository detected from git remote');
                } else {
                    alert('‚ö†Ô∏è Could not auto-detect. Make sure gh CLI is authenticated (gh auth login) and you have a git remote set.');
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Install gh CLI - opens terminal for user to enter sudo password
        async function installGh() {
            try {
                const response = await fetch('/api/gh/install', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.message}\n\nAfter installation completes, refresh this page.`);
                } else if (data.fallback || data.command) {
                    // Show command in modal for manual copy
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;';
                    modal.innerHTML = `
                        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:2rem;max-width:700px;width:90%;max-height:80vh;overflow:auto;">
                            <h2 style="margin-bottom:1rem;">üì¶ Install GitHub CLI</h2>
                            <p style="color:var(--text-dim);margin-bottom:1rem;">${data.message}</p>
                            <pre style="background:var(--bg-input);padding:1rem;border-radius:8px;overflow-x:auto;font-size:0.8rem;line-height:1.4;white-space:pre-wrap;">${data.command}</pre>
                            <div style="display:flex;gap:1rem;margin-top:1.5rem;">
                                <button class="btn primary" onclick="navigator.clipboard.writeText(this.dataset.cmd);this.textContent='‚úì Copied!'" data-cmd="${data.command.replace(/"/g, '&quot;')}">üìã Copy</button>
                                <button class="btn" onclick="this.closest('div').parentElement.remove()">Close</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
                } else {
                    alert(`‚ùå ${data.message}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Run Sentinel Worker setup - opens terminal, polls for completion
        async function setupSentinel(autoRun = false) {
            let pollTimer = null;
            let overlay = null;

            function removeOverlay() {
                if (pollTimer) clearInterval(pollTimer);
                if (overlay) overlay.remove();
                pollTimer = null;
                overlay = null;
            }

            try {
                const response = await fetch('/api/sentinel/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ autoRun }),
                });
                const data = await response.json();

                if (data.fallback || data.command) {
                    // No terminal emulator ‚Äî show fallback modal
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;';
                    modal.innerHTML = `
                        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:2rem;max-width:700px;width:90%;max-height:80vh;overflow:auto;">
                            <h2 style="margin-bottom:1rem;">üõ∞Ô∏è Sentinel Setup</h2>
                            <p style="color:var(--text-dim);margin-bottom:1rem;">${data.message}</p>
                            <pre style="background:var(--bg-input);padding:1rem;border-radius:8px;overflow-x:auto;font-size:0.85rem;line-height:1.4;white-space:pre-wrap;">${data.command}</pre>
                            <div style="display:flex;gap:1rem;margin-top:1.5rem;">
                                <button class="btn primary" onclick="navigator.clipboard.writeText(this.dataset.cmd);this.textContent='‚úì Copied!'" data-cmd="${data.command.replace(/"/g, '&quot;')}">üìã Copy</button>
                                <button class="btn" onclick="this.closest('div').parentElement.remove()">Close</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
                    return;
                }

                if (!data.success) {
                    alert(`‚ùå ${data.message}`);
                    return;
                }

                // Terminal spawned ‚Äî show polling overlay
                const startTime = Date.now();
                overlay = document.createElement('div');
                overlay.id = 'sentinel-setup-overlay';
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;';
                overlay.innerHTML = `
                    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:2.5rem;max-width:500px;width:90%;text-align:center;">
                        <div style="font-size:2.5rem;margin-bottom:1rem;" id="sentinel-spinner">üõ∞Ô∏è</div>
                        <h2 style="margin-bottom:0.5rem;">Sentinel Setup Running</h2>
                        <p style="color:var(--text-dim);margin-bottom:1.5rem;font-size:0.85rem;">
                            A terminal window has been opened. Complete the setup there.<br>
                            This will auto-detect when the configuration is ready.
                        </p>
                        <div style="background:var(--bg-input);border-radius:10px;padding:1rem;margin-bottom:1.5rem;">
                            <div style="display:flex;align-items:center;justify-content:center;gap:0.5rem;margin-bottom:0.75rem;">
                                <div class="spinner" style="width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;"></div>
                                <span style="color:var(--text-dim);font-size:0.85rem;" id="sentinel-poll-status">Waiting for setup to complete‚Ä¶</span>
                            </div>
                            <div style="font-family:monospace;font-size:0.8rem;color:var(--text-dim);" id="sentinel-elapsed">0s elapsed</div>
                        </div>
                        <div style="display:flex;gap:0.75rem;justify-content:center;flex-wrap:wrap;">
                            <button class="btn" id="sentinel-cancel-btn" style="padding:0.4rem 1.25rem;">
                                ‚úï Cancel Waiting
                            </button>
                        </div>
                        <p style="color:var(--text-dim);font-size:0.75rem;margin-top:1.25rem;opacity:0.6;">
                            üí° Having trouble? Try running <code style="background:var(--surface);padding:0.15rem 0.4rem;border-radius:4px;">./manage.sh sentinel -y</code> directly in your terminal for better troubleshooting.
                        </p>
                    </div>
                `;
                document.body.appendChild(overlay);

                // Add spin keyframes if not already present
                if (!document.getElementById('sentinel-spin-style')) {
                    const style = document.createElement('style');
                    style.id = 'sentinel-spin-style';
                    style.textContent = '@keyframes spin{to{transform:rotate(360deg)}}';
                    document.head.appendChild(style);
                }

                // Cancel button
                document.getElementById('sentinel-cancel-btn').addEventListener('click', () => {
                    removeOverlay();
                });

                // Poll for completion via signal file + env check
                const emojis = ['üõ∞Ô∏è', 'üì°', '‚ö°', 'üîÑ'];
                let emojiIdx = 0;
                const POLL_TIMEOUT_MS = 5 * 60 * 1000; // 5 minutes

                pollTimer = setInterval(async () => {
                    // Update elapsed time
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    const mins = Math.floor(elapsed / 60);
                    const secs = elapsed % 60;
                    const elapsedEl = document.getElementById('sentinel-elapsed');
                    if (elapsedEl) elapsedEl.textContent = mins > 0 ? `${mins}m ${secs}s elapsed` : `${secs}s elapsed`;

                    // Animate spinner
                    const spinnerEl = document.getElementById('sentinel-spinner');
                    if (spinnerEl) { emojiIdx = (emojiIdx + 1) % emojis.length; spinnerEl.textContent = emojis[emojiIdx]; }

                    // Timeout check
                    if (Date.now() - startTime > POLL_TIMEOUT_MS) {
                        removeOverlay();
                        _showSentinelResult('timeout');
                        return;
                    }

                    try {
                        // Check signal file first (fast, reliable)
                        const statusRes = await fetch('/api/sentinel/setup-status');
                        const statusData = await statusRes.json();

                        if (statusData.status === 'failed') {
                            removeOverlay();
                            _showSentinelResult('failed');
                            return;
                        }

                        if (statusData.status === 'success') {
                            // Signal says success ‚Äî also grab env for details
                            const envRes = await fetch('/api/env/read');
                            const envData = await envRes.json();
                            const url = envData?.env?.SENTINEL_URL || statusData.url || '';
                            const token = envData?.env?.SENTINEL_TOKEN || '';

                            removeOverlay();

                            // Auto-populate wizard fields
                            const urlInput = document.getElementById('wiz-sentinel-url');
                            const tokenInput = document.getElementById('wiz-sentinel-token');
                            if (urlInput) urlInput.value = url;
                            if (tokenInput && token) tokenInput.value = token;

                            _showSentinelResult('success', url, token);
                            return;
                        }

                        // Still running ‚Äî update status text
                        const statusEl = document.getElementById('sentinel-poll-status');
                        if (statusEl) statusEl.textContent = 'Waiting for setup to complete‚Ä¶';

                    } catch (e) {
                        // Ignore poll errors
                    }
                }, 3000);

            } catch (error) {
                removeOverlay();
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Show result overlay for sentinel setup
        function _showSentinelResult(status, url = '', token = '') {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;';

            // Close handler: refresh env data + re-render wizard step
            function dismissAndRefresh() {
                overlay.remove();
                secretsLoaded = false;  // env changed ‚Äî Secrets tab will re-fetch
                loadStatus().then(() => renderWizard());
            }

            let content = '';
            if (status === 'success') {
                content = `
                    <div style="background:var(--bg-card);border:1px solid rgba(74,222,128,0.3);border-radius:16px;padding:2.5rem;max-width:500px;width:90%;text-align:center;">
                        <div style="font-size:3rem;margin-bottom:1rem;">‚úÖ</div>
                        <h2 style="color:var(--accent);margin-bottom:0.5rem;">Sentinel Deployed!</h2>
                        <p style="color:var(--text-dim);margin-bottom:1rem;font-size:0.85rem;">
                            The Worker is live and the configuration has been saved.
                        </p>
                        ${url ? `<div style="background:var(--bg-input);border-radius:8px;padding:0.75rem;margin-bottom:1.5rem;text-align:left;font-size:0.8rem;">
                            <div style="margin-bottom:0.4rem;"><strong>URL:</strong> <code>${url}</code></div>
                            ${token ? `<div><strong>Token:</strong> <code>${token.substring(0, 8)}‚Ä¶</code></div>` : ''}
                        </div>` : ''}
                        <button class="btn primary" id="sentinel-result-close" style="padding:0.5rem 2rem;">
                            Continue ‚Üí
                        </button>
                    </div>`;
            } else if (status === 'failed') {
                content = `
                    <div style="background:var(--bg-card);border:1px solid rgba(239,68,68,0.3);border-radius:16px;padding:2.5rem;max-width:500px;width:90%;text-align:center;">
                        <div style="font-size:3rem;margin-bottom:1rem;">‚ùå</div>
                        <h2 style="color:var(--error);margin-bottom:0.5rem;">Setup Failed</h2>
                        <p style="color:var(--text-dim);margin-bottom:1rem;font-size:0.85rem;">
                            The setup encountered an error. Check the terminal window for details.
                        </p>
                        <div style="background:var(--bg-input);border-radius:8px;padding:0.75rem;margin-bottom:1.5rem;text-align:left;font-size:0.82rem;color:var(--text-dim);">
                            üí° For better troubleshooting, try running directly in your terminal:<br>
                            <code style="background:var(--surface);padding:0.15rem 0.4rem;border-radius:4px;">./manage.sh sentinel -y</code>
                        </div>
                        <button class="btn" id="sentinel-result-close" style="padding:0.5rem 2rem;">
                            Close
                        </button>
                    </div>`;
            } else {
                // timeout
                content = `
                    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:2.5rem;max-width:500px;width:90%;text-align:center;">
                        <div style="font-size:3rem;margin-bottom:1rem;">‚è±Ô∏è</div>
                        <h2 style="color:var(--warning);margin-bottom:0.5rem;">Setup Timed Out</h2>
                        <p style="color:var(--text-dim);margin-bottom:1rem;font-size:0.85rem;">
                            The setup is taking longer than expected. It may still be running in the terminal window.
                        </p>
                        <div style="background:var(--bg-input);border-radius:8px;padding:0.75rem;margin-bottom:1.5rem;text-align:left;font-size:0.82rem;color:var(--text-dim);">
                            üí° For better troubleshooting, try running directly in your terminal:<br>
                            <code style="background:var(--surface);padding:0.15rem 0.4rem;border-radius:4px;">./manage.sh sentinel -y</code>
                        </div>
                        <button class="btn" id="sentinel-result-close" style="padding:0.5rem 2rem;">
                            Close
                        </button>
                    </div>`;
            }

            overlay.innerHTML = content;
            document.body.appendChild(overlay);

            // Wire close button + backdrop click to refresh wizard
            document.getElementById('sentinel-result-close')?.addEventListener('click', dismissAndRefresh);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) dismissAndRefresh(); });
        }

        // Save tunnel token from the manual input field (accepts full install command or raw token)
        async function _saveTunnelTokenFromInput() {
            const input = document.getElementById('wiz-tunnel-token');
            const statusEl = document.getElementById('wiz-tunnel-save-status');
            const btn = document.getElementById('wiz-tunnel-save-btn');
            const rawValue = (input?.value || '').trim();

            if (!rawValue) {
                if (statusEl) {
                    statusEl.textContent = '‚ö† Paste a token or install command first';
                    statusEl.style.color = 'var(--warning)';
                }
                return;
            }

            if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Saving‚Ä¶'; }
            if (statusEl) { statusEl.textContent = ''; statusEl.style.color = ''; }

            try {
                const res = await fetch('/api/tunnel/save-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: rawValue }),
                });
                const data = await res.json();

                if (data.success) {
                    // Refresh env data and re-render wizard
                    const envRes = await fetch('/api/env/read');
                    const freshEnv = await envRes.json();
                    const token = freshEnv?.values?.CLOUDFLARE_TUNNEL_TOKEN || '';
                    wizardData.CLOUDFLARE_TUNNEL_TOKEN = token;

                    if (statusEl) {
                        statusEl.textContent = `‚úÖ Saved (${data.token_length} chars)`;
                        statusEl.style.color = 'var(--accent)';
                    }

                    // Re-render wizard to update the configured banner
                    setTimeout(() => {
                        secretsLoaded = false;
                        loadStatus().then(() => renderWizard());
                    }, 1200);
                } else {
                    if (statusEl) {
                        statusEl.textContent = `‚ùå ${data.error || 'Failed to save'}`;
                        statusEl.style.color = 'var(--error)';
                    }
                }
            } catch (e) {
                if (statusEl) {
                    statusEl.textContent = `‚ùå ${e.message}`;
                    statusEl.style.color = 'var(--error)';
                }
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = 'üíæ Save Token'; }
            }
        }

        // Run Cloudflare Tunnel setup - opens terminal, polls for completion
        async function setupTunnel(autoRun = false) {
            let pollTimer = null;
            let overlay = null;

            function removeOverlay() {
                if (pollTimer) clearInterval(pollTimer);
                if (overlay) overlay.remove();
                pollTimer = null;
                overlay = null;
            }

            try {
                const response = await fetch('/api/tunnel/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ autoRun }),
                });
                const data = await response.json();

                if (data.fallback || data.command) {
                    // No terminal emulator ‚Äî show fallback modal
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;';
                    modal.innerHTML = `
                        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:2rem;max-width:700px;width:90%;max-height:80vh;overflow:auto;">
                            <h2 style="margin-bottom:1rem;">üîí Tunnel Setup</h2>
                            <p style="color:var(--text-dim);margin-bottom:1rem;">${data.message}</p>
                            <pre style="background:var(--bg-input);padding:1rem;border-radius:8px;overflow-x:auto;font-size:0.85rem;line-height:1.4;white-space:pre-wrap;">${data.command}</pre>
                            <div style="display:flex;gap:1rem;margin-top:1.5rem;">
                                <button class="btn primary" onclick="navigator.clipboard.writeText(this.dataset.cmd);this.textContent='‚úì Copied!'" data-cmd="${data.command.replace(/"/g, '&quot;')}">üìã Copy</button>
                                <button class="btn" onclick="this.closest('div').parentElement.remove()">Close</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
                    return;
                }

                if (!data.success) {
                    alert(`‚ùå ${data.message}`);
                    return;
                }

                // Terminal spawned ‚Äî show polling overlay
                const startTime = Date.now();
                overlay = document.createElement('div');
                overlay.id = 'tunnel-setup-overlay';
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;';
                overlay.innerHTML = `
                    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:2.5rem;max-width:500px;width:90%;text-align:center;">
                        <div style="font-size:2.5rem;margin-bottom:1rem;" id="tunnel-spinner">üîí</div>
                        <h2 style="margin-bottom:0.5rem;">Tunnel Setup Running</h2>
                        <p style="color:var(--text-dim);margin-bottom:1.5rem;font-size:0.85rem;">
                            A terminal window has been opened. Complete the setup there.<br>
                            This will auto-detect when the configuration is ready.
                        </p>
                        <div style="background:var(--bg-input);border-radius:10px;padding:1rem;margin-bottom:1.5rem;">
                            <div style="display:flex;align-items:center;justify-content:center;gap:0.5rem;margin-bottom:0.75rem;">
                                <div class="spinner" style="width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;"></div>
                                <span style="color:var(--text-dim);font-size:0.85rem;" id="tunnel-poll-status">Waiting for setup to complete‚Ä¶</span>
                            </div>
                            <div style="font-family:monospace;font-size:0.8rem;color:var(--text-dim);" id="tunnel-elapsed">0s elapsed</div>
                        </div>
                        <div style="display:flex;gap:0.75rem;justify-content:center;flex-wrap:wrap;">
                            <button class="btn" id="tunnel-cancel-btn" style="padding:0.4rem 1.25rem;">
                                ‚úï Cancel Waiting
                            </button>
                        </div>
                        <p style="color:var(--text-dim);font-size:0.75rem;margin-top:1.25rem;opacity:0.6;">
                            üí° Having trouble? Try running <code style="background:var(--surface);padding:0.15rem 0.4rem;border-radius:4px;">./manage.sh tunnel -y</code> directly in your terminal.
                        </p>
                    </div>
                `;
                document.body.appendChild(overlay);

                // Add spin keyframes if not already present
                if (!document.getElementById('sentinel-spin-style')) {
                    const style = document.createElement('style');
                    style.id = 'sentinel-spin-style';
                    style.textContent = '@keyframes spin{to{transform:rotate(360deg)}}';
                    document.head.appendChild(style);
                }

                // Cancel button
                document.getElementById('tunnel-cancel-btn').addEventListener('click', () => {
                    removeOverlay();
                });

                // Poll for completion via signal file
                const emojis = ['üîí', '‚òÅÔ∏è', 'üåê', 'üîÑ'];
                let emojiIdx = 0;
                const POLL_TIMEOUT_MS = 5 * 60 * 1000; // 5 minutes

                pollTimer = setInterval(async () => {
                    // Update elapsed time
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    const mins = Math.floor(elapsed / 60);
                    const secs = elapsed % 60;
                    const elapsedEl = document.getElementById('tunnel-elapsed');
                    if (elapsedEl) elapsedEl.textContent = mins > 0 ? `${mins}m ${secs}s elapsed` : `${secs}s elapsed`;

                    // Animate spinner
                    const spinnerEl = document.getElementById('tunnel-spinner');
                    if (spinnerEl) { emojiIdx = (emojiIdx + 1) % emojis.length; spinnerEl.textContent = emojis[emojiIdx]; }

                    // Timeout check
                    if (Date.now() - startTime > POLL_TIMEOUT_MS) {
                        removeOverlay();
                        _showTunnelResult('timeout');
                        return;
                    }

                    try {
                        const statusRes = await fetch('/api/tunnel/setup-status');
                        const statusData = await statusRes.json();

                        if (statusData.status === 'failed') {
                            removeOverlay();
                            _showTunnelResult('failed');
                            return;
                        }

                        if (statusData.status === 'no_tunnels') {
                            // No tunnels exist ‚Äî show creation link
                            removeOverlay();
                            _showTunnelResult('no_tunnels', '', '', statusData.create_url || '');
                            return;
                        }

                        if (statusData.status === 'needs_token') {
                            // Script is waiting for token ‚Äî show paste input in the overlay
                            const pasteAlready = document.getElementById('tunnel-paste-input');
                            if (!pasteAlready) {
                                const card = overlay.querySelector('div > div');
                                if (card) {
                                    card.innerHTML = `
                                        <div style="font-size:2.5rem;margin-bottom:1rem;">‚òÅÔ∏è</div>
                                        <h2 style="margin-bottom:0.5rem;">Paste Tunnel Token</h2>
                                        <p style="color:var(--text-dim);margin-bottom:0.75rem;font-size:0.85rem;">
                                            The tunnel dashboard has been opened.
                                            Copy the <strong>install command</strong> and paste it below.
                                        </p>
                                        ${statusData.dashboard_url ? `<a href="${statusData.dashboard_url}" target="_blank" style="display:inline-block;margin-bottom:1rem;color:var(--info);font-size:0.82rem;">Open tunnel dashboard ‚Üó</a>` : ''}
                                        <div style="text-align:left;margin-bottom:1rem;">
                                            <label style="display:block;color:var(--text-dim);font-size:0.78rem;margin-bottom:0.4rem;">
                                                Paste the full install command or just the token:
                                            </label>
                                            <textarea id="tunnel-paste-input"
                                                placeholder="cloudflared.exe service install eyJhIjoi..."
                                                style="width:100%;min-height:80px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;padding:0.75rem;font-family:monospace;font-size:0.82rem;color:var(--text);resize:vertical;"
                                            ></textarea>
                                        </div>
                                        <div style="display:flex;gap:0.75rem;justify-content:center;">
                                            <button class="btn primary" id="tunnel-submit-token" style="padding:0.5rem 1.5rem;">
                                                üíæ Save Token
                                            </button>
                                            <button class="btn" id="tunnel-cancel-paste" style="padding:0.5rem 1.25rem;">
                                                ‚úï Cancel
                                            </button>
                                        </div>
                                        <div id="tunnel-paste-error" style="color:var(--error);font-size:0.82rem;margin-top:0.75rem;display:none;"></div>
                                    `;

                                    document.getElementById('tunnel-cancel-paste').addEventListener('click', () => {
                                        removeOverlay();
                                    });

                                    document.getElementById('tunnel-submit-token').addEventListener('click', async () => {
                                        const rawToken = document.getElementById('tunnel-paste-input').value.trim();
                                        if (!rawToken) {
                                            const errEl = document.getElementById('tunnel-paste-error');
                                            errEl.textContent = 'Please paste the install command or token.';
                                            errEl.style.display = 'block';
                                            return;
                                        }

                                        const btn = document.getElementById('tunnel-submit-token');
                                        btn.disabled = true;
                                        btn.textContent = '‚è≥ Saving‚Ä¶';

                                        try {
                                            const saveRes = await fetch('/api/tunnel/save-token', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ token: rawToken }),
                                            });
                                            const saveData = await saveRes.json();

                                            if (saveData.success) {
                                                // Grab updated env
                                                const envRes = await fetch('/api/env/read');
                                                const freshEnv = await envRes.json();
                                                const token = freshEnv?.values?.CLOUDFLARE_TUNNEL_TOKEN || '';

                                                removeOverlay();

                                                const tokenInput = document.getElementById('wiz-tunnel-token');
                                                if (tokenInput && token) tokenInput.value = token;
                                                wizardData.CLOUDFLARE_TUNNEL_TOKEN = token;

                                                _showTunnelResult('success', '', token);
                                            } else {
                                                const errEl = document.getElementById('tunnel-paste-error');
                                                errEl.textContent = saveData.error || 'Failed to save token.';
                                                errEl.style.display = 'block';
                                                btn.disabled = false;
                                                btn.textContent = 'üíæ Save Token';
                                            }
                                        } catch (e) {
                                            const errEl = document.getElementById('tunnel-paste-error');
                                            errEl.textContent = `Error: ${e.message}`;
                                            errEl.style.display = 'block';
                                            btn.disabled = false;
                                            btn.textContent = 'üíæ Save Token';
                                        }
                                    });
                                }
                            }
                            return; // Don't process further while waiting for paste
                        }

                        if (statusData.status === 'success') {
                            // Grab updated env
                            const envRes = await fetch('/api/env/read');
                            const freshEnv = await envRes.json();
                            const token = freshEnv?.values?.CLOUDFLARE_TUNNEL_TOKEN || '';
                            const hostname = statusData.hostname || '';

                            removeOverlay();

                            // Auto-populate wizard field
                            const tokenInput = document.getElementById('wiz-tunnel-token');
                            if (tokenInput && token) tokenInput.value = token;
                            wizardData.CLOUDFLARE_TUNNEL_TOKEN = token;

                            _showTunnelResult('success', hostname, token);
                            return;
                        }

                        // Still running
                        const statusEl = document.getElementById('tunnel-poll-status');
                        if (statusEl) statusEl.textContent = 'Waiting for setup to complete‚Ä¶';

                    } catch (e) {
                        // Ignore poll errors
                    }
                }, 3000);

            } catch (error) {
                removeOverlay();
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Show result overlay for tunnel setup
        function _showTunnelResult(status, hostname = '', token = '', createUrl = '') {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;';

            function dismissAndRefresh() {
                overlay.remove();
                secretsLoaded = false;
                loadStatus().then(() => renderWizard());
            }

            let content = '';
            if (status === 'success') {
                content = `
                    <div style="background:var(--bg-card);border:1px solid rgba(74,222,128,0.3);border-radius:16px;padding:2.5rem;max-width:500px;width:90%;text-align:center;">
                        <div style="font-size:3rem;margin-bottom:1rem;">‚úÖ</div>
                        <h2 style="color:var(--accent);margin-bottom:0.5rem;">Tunnel Ready!</h2>
                        <p style="color:var(--text-dim);margin-bottom:1rem;font-size:0.85rem;">
                            The tunnel token has been saved to <code>.env</code>.<br>
                            The tunnel will start automatically with your Docker deployment.
                        </p>
                        ${hostname ? `<div style="background:var(--bg-input);border-radius:8px;padding:0.75rem;margin-bottom:1.5rem;text-align:left;font-size:0.8rem;">
                            <div style="margin-bottom:0.4rem;"><strong>Hostname:</strong> <code>https://${hostname}</code></div>
                            ${token ? `<div><strong>Token:</strong> <code>${token.substring(0, 12)}‚Ä¶</code></div>` : ''}
                        </div>` : (token ? `<div style="background:var(--bg-input);border-radius:8px;padding:0.75rem;margin-bottom:1.5rem;text-align:left;font-size:0.8rem;">
                            <div><strong>Token:</strong> <code>${token.substring(0, 12)}‚Ä¶</code></div>
                        </div>` : '')}
                        <button class="btn primary" id="tunnel-result-close" style="padding:0.5rem 2rem;">
                            Continue ‚Üí
                        </button>
                    </div>`;
            } else if (status === 'no_tunnels') {
                content = `
                    <div style="background:var(--bg-card);border:1px solid rgba(251,191,36,0.3);border-radius:16px;padding:2.5rem;max-width:500px;width:90%;text-align:center;">
                        <div style="font-size:3rem;margin-bottom:1rem;">‚òÅÔ∏è</div>
                        <h2 style="color:var(--warning);margin-bottom:0.5rem;">No Tunnels Found</h2>
                        <p style="color:var(--text-dim);margin-bottom:1rem;font-size:0.85rem;">
                            You need to create a Cloudflare Tunnel first.
                        </p>
                        <div style="background:var(--bg-input);border-radius:8px;padding:1rem;margin-bottom:1.5rem;text-align:left;font-size:0.82rem;color:var(--text-dim);">
                            <strong>Steps:</strong><br>
                            1. Go to Cloudflare Zero Trust dashboard<br>
                            2. Navigate to <strong>Networks ‚Üí Tunnels</strong><br>
                            3. Click <strong>Create a tunnel</strong><br>
                            4. Name it (e.g. <code>continuity-orchestrator</code>)<br>
                            5. Come back here and click <strong>‚ö° Auto-Run</strong> again
                        </div>
                        ${createUrl ? `<a href="${createUrl}" target="_blank" class="btn primary" style="display:inline-block;padding:0.5rem 1.5rem;margin-bottom:1rem;text-decoration:none;">
                            ‚òÅÔ∏è Create Tunnel ‚Üí
                        </a><br>` : ''}
                        <button class="btn" id="tunnel-result-close" style="padding:0.5rem 2rem;">
                            Close
                        </button>
                    </div>`;
            } else if (status === 'failed') {
                content = `
                    <div style="background:var(--bg-card);border:1px solid rgba(239,68,68,0.3);border-radius:16px;padding:2.5rem;max-width:500px;width:90%;text-align:center;">
                        <div style="font-size:3rem;margin-bottom:1rem;">‚ùå</div>
                        <h2 style="color:var(--error);margin-bottom:0.5rem;">Setup Failed</h2>
                        <p style="color:var(--text-dim);margin-bottom:1rem;font-size:0.85rem;">
                            The setup encountered an error. Check the terminal window for details.
                        </p>
                        <div style="background:var(--bg-input);border-radius:8px;padding:0.75rem;margin-bottom:1.5rem;text-align:left;font-size:0.82rem;color:var(--text-dim);">
                            üí° For better troubleshooting, try running directly in your terminal:<br>
                            <code style="background:var(--surface);padding:0.15rem 0.4rem;border-radius:4px;">./manage.sh tunnel -y</code>
                        </div>
                        <button class="btn" id="tunnel-result-close" style="padding:0.5rem 2rem;">
                            Close
                        </button>
                    </div>`;
            } else {
                // timeout
                content = `
                    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:2.5rem;max-width:500px;width:90%;text-align:center;">
                        <div style="font-size:3rem;margin-bottom:1rem;">‚è±Ô∏è</div>
                        <h2 style="color:var(--warning);margin-bottom:0.5rem;">Setup Timed Out</h2>
                        <p style="color:var(--text-dim);margin-bottom:1rem;font-size:0.85rem;">
                            The setup is taking longer than expected. It may still be running in the terminal window.
                        </p>
                        <div style="background:var(--bg-input);border-radius:8px;padding:0.75rem;margin-bottom:1.5rem;text-align:left;font-size:0.82rem;color:var(--text-dim);">
                            üí° For better troubleshooting, try running directly in your terminal:<br>
                            <code style="background:var(--surface);padding:0.15rem 0.4rem;border-radius:4px;">./manage.sh tunnel -y</code>
                        </div>
                        <button class="btn" id="tunnel-result-close" style="padding:0.5rem 2rem;">
                            Close
                        </button>
                    </div>`;
            }

            overlay.innerHTML = content;
            document.body.appendChild(overlay);

            document.getElementById('tunnel-result-close')?.addEventListener('click', dismissAndRefresh);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) dismissAndRefresh(); });
        }

        // ========================================
        // DEADLINE MANAGEMENT
        // ========================================

        async function renewDeadline(hours) {
            hours = parseInt(hours);
            if (!hours || hours < 1) {
                alert('Please enter a valid number of hours (1+).');
                return;
            }
            const statusDiv = document.getElementById('deadline-status');
            if (statusDiv) statusDiv.innerHTML = '<span style="color: var(--info);">‚è≥ Renewing...</span>';

            try {
                const response = await fetch('/api/renew', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hours }),
                });
                const data = await response.json();
                if (data.success) {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--success);">‚úÖ Renewed for ${hours} hours</span>`;
                    loadStatus();
                    // Git sync if checkbox is checked
                    const syncCb = document.getElementById('deadline-git-sync');
                    if (syncCb && syncCb.checked) {
                        if (statusDiv) statusDiv.innerHTML += '<br><span style="color: var(--info);">üîÑ Syncing to Git...</span>';
                        try {
                            const syncResp = await fetch('/api/git/sync', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ message: `chore: renew deadline +${hours}h` }),
                            });
                            const syncData = await syncResp.json();
                            if (syncData.success) {
                                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ ${syncData.message}</span>`;
                            } else {
                                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--warning);">‚ö†Ô∏è ${syncData.error || 'Git sync failed'}</span>`;
                            }
                        } catch (syncErr) {
                            if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--warning);">‚ö†Ô∏è Git sync: ${syncErr.message}</span>`;
                        }
                    }
                } else {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.error || 'Failed'}</span>`;
                }
            } catch (error) {
                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå ${error.message}</span>`;
            }
        }

        async function setManualDeadline() {
            const input = document.getElementById('manual-deadline');
            if (!input || !input.value) {
                alert('Please select a date and time.');
                return;
            }
            const target = new Date(input.value);
            const now = new Date();
            const hoursFromNow = (target - now) / (1000 * 60 * 60);
            if (hoursFromNow <= 0) {
                alert('Deadline must be in the future.');
                return;
            }
            await setDeadlineHours(hoursFromNow, target.toLocaleString());
        }

        async function setTestDeadline(minutes) {
            const hours = minutes / 60;
            await setDeadlineHours(hours, `${minutes} minutes from now`);
        }

        async function setDeadlineHours(hours, label) {
            const statusDiv = document.getElementById('deadline-status');
            if (statusDiv) statusDiv.innerHTML = '<span style="color: var(--info);">‚è≥ Setting deadline...</span>';

            try {
                const response = await fetch('/api/state/set-deadline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hours }),
                });
                const data = await response.json();
                if (data.success) {
                    const desc = label || `${Math.round(hours * 10) / 10} hours from now`;
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--success);">‚úÖ Deadline set: ${desc}</span>`;
                    loadStatus();
                    // Git sync if checkbox is checked
                    const syncCb = document.getElementById('deadline-git-sync');
                    if (syncCb && syncCb.checked) {
                        if (statusDiv) statusDiv.innerHTML += '<br><span style="color: var(--info);">üîÑ Syncing to Git...</span>';
                        try {
                            const syncResp = await fetch('/api/git/sync', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ message: `chore: set deadline ${desc}` }),
                            });
                            const syncData = await syncResp.json();
                            if (syncData.success) {
                                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ ${syncData.message}</span>`;
                            } else {
                                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--warning);">‚ö†Ô∏è ${syncData.error || 'Git sync failed'}</span>`;
                            }
                        } catch (syncErr) {
                            if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--warning);">‚ö†Ô∏è Git sync: ${syncErr.message}</span>`;
                        }
                    }
                } else {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.error || 'Failed'}</span>`;
                }
            } catch (error) {
                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå ${error.message}</span>`;
            }
        }
        // ========================================
        // TRIGGER / RETURN STATE CONTROLS
        // ========================================

        // Helper: call /api/run with a command name from the allowlist
        async function apiRun(command) {
            const resp = await fetch('/api/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command }),
            });
            return resp.json();
        }

        async function triggerRelease() {
            const stage = document.getElementById('trigger-stage')?.value || 'FULL';
            const typed = prompt(
                `‚ö° TRIGGER ${stage} DISCLOSURE?\n\n` +
                '‚ö†Ô∏è  THIS IS IRREVERSIBLE IN PRODUCTION.\n\n' +
                'This will:\n' +
                `‚Ä¢ Set escalation state to ${stage} immediately\n` +
                '‚Ä¢ Set deadline to past (overdue)\n' +
                '‚Ä¢ On next tick: execute all stage-appropriate actions\n\n' +
                `Type ${stage} to proceed:`
            );
            if (typed !== stage) {
                if (typed !== null) alert('‚ùå Cancelled ‚Äî text did not match.');
                return;
            }

            const statusDiv = document.getElementById('trigger-status');
            if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ö° Triggering ${stage} disclosure...</span>`;

            try {
                const resp = await fetch('/api/state/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stage, delay: 0 }),
                });
                const triggerData = await resp.json();

                if (!triggerData.success) {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Trigger failed: ${triggerData.error || 'Unknown error'}</span>`;
                    return;
                }

                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--warning);">‚úÖ State set to ${stage}</span>`;
                await _postTriggerSteps(statusDiv, `${stage} disclosure`);
            } catch (error) {
                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Error: ${error.message}</span>`;
            }
        }

        async function triggerShadow() {
            const stage = document.getElementById('trigger-stage')?.value || 'FULL';
            const delay = document.getElementById('shadow-delay')?.value || '60';
            const delayLabel = delay === '0' ? 'no delay (immediate)' : `${delay} minute delay`;

            const confirmation = prompt(
                `üëª ACTIVATE SHADOW MODE?\n\n` +
                `This is the same as entering RELEASE_SECRET on the public site.\n\n` +
                `‚Ä¢ Stealth trigger ‚Äî appears as a normal renewal\n` +
                `‚Ä¢ Stage: ${stage}\n` +
                `‚Ä¢ Delay: ${delayLabel}\n` +
                `‚Ä¢ After delay: next tick executes ${stage} disclosure\n` +
                `‚Ä¢ Cancelable by renewal during the delay window\n\n` +
                `Type SHADOW to confirm:`
            );
            if (confirmation !== 'SHADOW') return;

            const statusDiv = document.getElementById('trigger-status');
            if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--warning);">üëª Activating shadow mode (${stage}, ${delayLabel})...</span>`;

            try {
                const resp = await fetch('/api/state/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stage, delay: parseInt(delay), silent: true }),
                });
                const triggerData = await resp.json();

                if (!triggerData.success) {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Shadow trigger failed: ${triggerData.error || 'Unknown error'}</span>`;
                    return;
                }

                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--warning);">‚úÖ Shadow mode active ‚Äî ${stage}, ${delayLabel}</span>`;
                await _postTriggerSteps(statusDiv, 'shadow mode');
            } catch (error) {
                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Error: ${error.message}</span>`;
            }
        }

        // Shared post-trigger steps: auto-tick + build + git sync + deploy
        async function _postTriggerSteps(statusDiv, label) {
            // Auto-tick
            if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--info);">üîÑ Running tick...</span>`;
            const tickData = await apiRun('tick');
            if (tickData.success) {
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ Tick completed</span>`;
            } else {
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--danger);">‚ö†Ô∏è Tick error: ${tickData.error || 'Unknown'}</span>`;
            }

            // Build site (fire-and-forget)
            apiRun('build-site').catch(() => { });
            if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--text-dim);">üèóÔ∏è Site rebuild kicked off (background)</span>`;

            // Git sync
            if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--info);">üì§ Syncing to git...</span>`;
            const syncResp = await fetch('/api/git/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `trigger: ${label} via admin panel` }),
            });
            const syncData = await syncResp.json();
            if (syncData.success) {
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ Git synced</span>`;
                // Trigger deploy-site workflow (fire-and-forget)
                apiRun('deploy-site').catch(() => { });
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--text-dim);">üöÄ Deploy pipeline triggered (background)</span>`;
            } else {
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--danger);">‚ö†Ô∏è Git sync failed: ${syncData.steps?.find(s => !s.ok)?.output || 'Unknown'}</span>`;
            }

            // Single refresh after short delay
            if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ All steps completed</span>`;
            setTimeout(() => loadStatus(), 3000);
        }

        async function returnToOK() {
            if (!confirm(
                'üîô RETURN TO OK?\n\n' +
                'This will:\n' +
                '‚Ä¢ Reset escalation state to OK\n' +
                '‚Ä¢ Cancel any pending release\n' +
                '‚Ä¢ Create a new 48h deadline\n' +
                '‚Ä¢ Clear executed actions\n\n' +
                'The disclosure site may still be live on GitHub Pages\n' +
                'until the next deploy overwrites it.\n\n' +
                'Continue?'
            )) return;

            const statusDiv = document.getElementById('trigger-status');
            if (statusDiv) statusDiv.innerHTML = '<span style="color: var(--info);">üîô Resetting to OK...</span>';

            try {
                // Reset state via /api/run
                const resetData = await apiRun('reset');

                if (!resetData.success) {
                    if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Reset failed: ${resetData.error || 'Unknown'}</span>`;
                    return;
                }

                if (statusDiv) statusDiv.innerHTML = '<span style="color: var(--accent);">‚úÖ State reset to OK</span>';

                // Git sync + build + deploy
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--info);">üì§ Syncing to git...</span>`;
                const syncResp = await fetch('/api/git/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'chore: return to OK via admin panel' }),
                });
                const syncData = await syncResp.json();
                if (syncData.success) {
                    if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ Git synced</span>`;
                    // Rebuild site + trigger deploy (fire-and-forget)
                    apiRun('build-site').catch(() => { });
                    apiRun('deploy-site').catch(() => { });
                    if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--text-dim);">üèóÔ∏è Site rebuild + üöÄ deploy triggered (background)</span>`;
                } else {
                    if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--danger);">‚ö†Ô∏è Git sync failed</span>`;
                }

                // Single refresh after short delay
                if (statusDiv) statusDiv.innerHTML += `<br><span style="color: var(--accent);">‚úÖ All steps completed</span>`;
                setTimeout(() => loadStatus(), 3000);

            } catch (error) {
                if (statusDiv) statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Error: ${error.message}</span>`;
            }
        }

        // Reset timer (keeps secrets, resets state to OK with new deadline)
        async function resetState() {
            if (!confirm('Reset timer?\n\nThis will:\n‚Ä¢ Set stage back to OK\n‚Ä¢ Create a new 48h deadline\n‚Ä¢ Reset renewal count to 0\n\nYour secrets will NOT be deleted.')) {
                return;
            }

            try {
                const response = await fetch('/api/state/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Timer reset! New 48h deadline active.');
                    loadStatus();
                } else {
                    alert(`‚ùå Reset failed: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        {% include "scripts/modals/_factory_reset.js.html" %}

        {% include "scripts/modals/_backup.js.html" %}

        {% include "scripts/modals/_vault.js.html" %}

        // Required steps that must be completed before optional ones can be accessed
        const REQUIRED_STEP_COUNT = 5; // welcome, deploy, project, deadline (conditional), security

        // Check if required steps have been satisfied (have data)
        function areRequiredStepsSatisfied() {
            // Check for minimum required values from envData (already configured)
            const hasProject = envData.PROJECT_NAME && envData.PROJECT_NAME.length > 0;
            const hasRenewal = envData.RENEWAL_SECRET && envData.RENEWAL_SECRET.length > 0;
            const hasGithub = envData.GITHUB_REPOSITORY && envData.GITHUB_REPOSITORY.length > 0;

            // Also check wizardData (entered this session)
            const wizHasProject = wizardData.PROJECT_NAME && wizardData.PROJECT_NAME.length > 0;
            const wizHasRenewal = wizardData.RENEWAL_SECRET && wizardData.RENEWAL_SECRET.length > 0;

            // If we have project AND some security value, consider it satisfied
            return (hasProject || wizHasProject) && (hasRenewal || wizHasRenewal || hasGithub);
        }

        // Check if a step is optional (can be skipped)
        function isOptionalStep(stepIndex) {
            const step = wizardSteps[stepIndex];
            if (!step) return false;
            // Optional adapter steps
            if (['email', 'sms', 'twitter', 'reddit'].includes(step.id)) return true;
            // Deadline step is optional when not in countdown mode
            if (step.id === 'deadline' && step.skip && step.skip()) return true;
            return false;
        }

        // Get visible wizard steps (skip steps whose skip() returns true)
        function getVisibleSteps() {
            return wizardSteps.filter(s => !s.skip || !s.skip());
        }

        // Check if we can skip ahead (some configuration already exists)
        function canSkipAhead() {
            // If any values exist in envData, allow free navigation
            const hasAnyConfig = Object.keys(envData).some(key =>
                envData[key] && envData[key].length > 0 &&
                !['ADAPTER_MOCK_MODE'].includes(key) // Exclude defaults
            );
            return hasAnyConfig;
        }

        // Navigate to a specific step (if allowed)
        function goToStep(stepIndex) {
            // Collect current step data first
            const currentStep = wizardSteps[currentWizardStep];
            if (currentStep?.collect) {
                Object.assign(wizardData, currentStep.collect());
            }

            // Can always go back
            if (stepIndex < currentWizardStep) {
                currentWizardStep = stepIndex;
                renderWizard();
                return;
            }

            // If user already has config, allow free navigation
            if (canSkipAhead()) {
                currentWizardStep = stepIndex;
                renderWizard();
                return;
            }

            // Otherwise, stricter rules:
            // - Required steps: can only go forward one at a time
            // - Optional steps: can jump if required are satisfied
            if (stepIndex < REQUIRED_STEP_COUNT) {
                if (stepIndex <= currentWizardStep + 1) {
                    currentWizardStep = stepIndex;
                    renderWizard();
                }
            } else if (areRequiredStepsSatisfied()) {
                currentWizardStep = stepIndex;
                renderWizard();
            }
        }

        function renderWizard() {
            // Seed wizardData from envData for keys that the wizard templates read.
            // CLOUDFLARE_TUNNEL_TOKEN always syncs from .env (source of truth ‚Äî
            // can be set/deleted by secrets tab or setup script).
            // Other keys: seed once on first render, never overwrite in-session
            // user choices (e.g. switching deploy mode to Docker).
            if (envData.CLOUDFLARE_TUNNEL_TOKEN) {
                wizardData.CLOUDFLARE_TUNNEL_TOKEN = envData.CLOUDFLARE_TUNNEL_TOKEN;
            } else {
                delete wizardData.CLOUDFLARE_TUNNEL_TOKEN;
            }
            const seedOnceKeys = [
                'DEPLOY_MODE', 'PROJECT_NAME',
                'DOCKER_GIT_SYNC_ALPHA', 'DOCKER_GIT_SYNC_TICK_INTERVAL',
                'DOCKER_GIT_SYNC_SYNC_INTERVAL', 'MODE', 'DEADLINE_HOURS',
            ];
            for (const key of seedOnceKeys) {
                if (!wizardData[key] && envData[key]) {
                    wizardData[key] = envData[key];
                }
            }

            const requiredSatisfied = areRequiredStepsSatisfied();
            const skipAllowed = canSkipAhead();
            const visibleSteps = getVisibleSteps();

            // Auto-skip past hidden steps
            while (currentWizardStep < wizardSteps.length &&
                wizardSteps[currentWizardStep].skip &&
                wizardSteps[currentWizardStep].skip()) {
                currentWizardStep++;
            }

            // Render step indicators (visible steps only)
            const stepsHtml = visibleSteps.map((step, vIdx) => {
                const realIdx = wizardSteps.indexOf(step);
                let cls = '';
                let clickable = false;

                if (realIdx < currentWizardStep) {
                    cls = 'completed';
                    clickable = true;
                } else if (realIdx === currentWizardStep) {
                    cls = 'active';
                } else {
                    if (skipAllowed) {
                        clickable = true;
                        cls = isOptionalStep(realIdx) ? 'optional' : 'skippable';
                    } else if (realIdx >= REQUIRED_STEP_COUNT && requiredSatisfied) {
                        clickable = true;
                        cls = 'optional';
                    }
                }

                const optionalBadge = isOptionalStep(realIdx) ? '<small style="opacity: 0.6; font-size: 0.7rem;"> (opt)</small>' : '';
                const cursor = clickable ? 'pointer' : 'default';
                const onclick = clickable ? `onclick="goToStep(${realIdx})"` : '';

                return `
                    <div class="wizard-step ${cls}" style="cursor: ${cursor};" ${onclick}>
                        <span class="wizard-step-num">${realIdx < currentWizardStep ? '‚úì' : vIdx + 1}</span>
                        <span>${step.title}${optionalBadge}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('wizard-steps').innerHTML = stepsHtml;

            // Render current step content
            const step = wizardSteps[currentWizardStep];
            const wizardBody = document.getElementById('wizard-body');
            wizardBody.innerHTML = step.content();

            // Snapshot initial field values so we can detect real changes
            const initialValues = {};
            wizardBody.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.id || el.name) initialValues[el.id || el.name] = el.value;
            });
            wizardBody.addEventListener('input', () => {
                const fields = wizardBody.querySelectorAll('input, textarea, select');
                wizardDirty = Array.from(fields).some(el => {
                    const key = el.id || el.name;
                    return key && el.value !== (initialValues[key] ?? '');
                });
            });
            wizardBody.addEventListener('change', () => {
                const fields = wizardBody.querySelectorAll('input, textarea, select');
                wizardDirty = Array.from(fields).some(el => {
                    const key = el.id || el.name;
                    return key && el.value !== (initialValues[key] ?? '');
                });
            });

            // Update nav buttons
            document.getElementById('wizard-prev').style.visibility = currentWizardStep === 0 ? 'hidden' : 'visible';

            const nextBtn = document.getElementById('wizard-next');
            const finishBtn = document.getElementById('wizard-finish');

            // Show Finish button on optional steps (allows skipping to Push)
            const isOnOptionalStep = isOptionalStep(currentWizardStep);
            finishBtn.style.display = isOnOptionalStep ? '' : 'none';

            if (currentWizardStep === wizardSteps.length - 1) {
                // Complete step
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'none';
            } else if (currentWizardStep === wizardSteps.length - 2) {
                // Push step
                nextBtn.textContent = 'üöÄ Push & Finish';
                finishBtn.style.display = 'none';
            } else {
                nextBtn.style.display = '';
                nextBtn.textContent = 'Next ‚Üí';
            }

            // Update URL hash with current wizard step ID
            history.replaceState(null, '', `#wizard/${step.id}`);
        }

        // Skip to Push step (called from Finish button)
        async function wizardFinish() {
            // Collect current step data first
            const step = wizardSteps[currentWizardStep];
            if (step.collect) {
                Object.assign(wizardData, step.collect());
            }

            // Find the push step index
            const pushIndex = wizardSteps.findIndex(s => s.id === 'push');
            if (pushIndex !== -1) {
                currentWizardStep = pushIndex;
                renderWizard();
            }
        }

        function wizardPrev() {
            if (currentWizardStep > 0) {
                currentWizardStep--;
                renderWizard();
            }
        }

        async function wizardNext() {
            const step = wizardSteps[currentWizardStep];

            // Validate current step
            if (step.validate && !step.validate()) {
                return;
            }

            // Collect data from current step
            if (step.collect) {
                Object.assign(wizardData, step.collect());
            }

            // If this is the push step, actually push
            if (step.id === 'push') {
                await pushWizardSecrets();
            }

            // Move to next visible step
            if (currentWizardStep < wizardSteps.length - 1) {
                currentWizardStep++;
                // Skip hidden steps
                while (currentWizardStep < wizardSteps.length - 1 &&
                    wizardSteps[currentWizardStep].skip &&
                    wizardSteps[currentWizardStep].skip()) {
                    currentWizardStep++;
                }
                renderWizard();
            }
        }

        async function pushWizardSecrets() {
            const statusDiv = document.getElementById('wizard-push-status');
            if (!statusDiv) {
                console.error('wizard-push-status element not found');
                return;
            }

            // Capture options before the DOM gets replaced
            const gitSyncChecked = document.getElementById('wiz-git-sync')?.checked ?? false;

            // Separate non-secret wizard data from actual secrets
            const deadlineHours = wizardData.DEADLINE_HOURS || 48;
            const deadlineTouched = !!wizardData._DEADLINE_TOUCHED;
            const deployMode = wizardData.DEPLOY_MODE;
            const operatingMode = wizardData.MODE;
            const secrets = { ...wizardData };
            delete secrets.DEADLINE_HOURS;
            delete secrets._DEADLINE_TOUCHED;
            // Note: DEPLOY_MODE stays in secrets ‚Äî it's LOCAL_ONLY tier,
            // so it'll be saved to .env but not pushed to GitHub.
            delete secrets.MODE;
            const policyPreset = secrets._POLICY_PRESET || '';
            delete secrets._POLICY_PRESET;
            console.log('Wizard secrets to push:', Object.keys(secrets));
            console.log('DEPLOY_MODE being pushed:', secrets.DEPLOY_MODE, '| wizardData had:', wizardData.DEPLOY_MODE);

            if (Object.keys(secrets).length === 0) {
                statusDiv.innerHTML = '<div class="alert info">No new secrets to push.</div>';
            } else {
                statusDiv.innerHTML = `<div class="loading">Pushing ${Object.keys(secrets).length} secrets...</div>`;

                try {
                    console.log('Sending secrets to /api/secrets/push...');
                    const response = await fetch('/api/secrets/push', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ secrets, save_to_env: true }),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('Push response:', data);

                    if (data.error) {
                        statusDiv.innerHTML = `<div class="alert error">‚ùå ${data.error}</div>`;
                        console.error('Push error:', data.error);
                        return;
                    }

                    let html = '<h4 style="margin-bottom: 0.5rem;">Results:</h4>';
                    let successCount = 0;
                    let failCount = 0;

                    // Show env save status
                    if (data.env_saved) {
                        html += '<div style="color: var(--accent); margin: 0.25rem 0;">üíæ Saved to .env</div>';
                    }

                    for (const result of (data.results || [])) {
                        if (result.success) {
                            html += `<div style="color: var(--accent); margin: 0.25rem 0;">‚úÖ ${result.name}</div>`;
                            successCount++;
                        } else {
                            html += `<div style="color: var(--danger); margin: 0.25rem 0;">‚ùå ${result.name}: ${result.error}</div>`;
                            failCount++;
                        }
                    }

                    if (failCount === 0) {
                        html = `<div class="alert success">‚úÖ All ${successCount} secrets pushed successfully!</div>` + html;
                    }

                    statusDiv.innerHTML = html;
                    console.log(`Push complete: ${successCount} success, ${failCount} failed`);
                } catch (error) {
                    console.error('Push exception:', error);
                    statusDiv.innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
                }
            }

            // Set deadline only if the user actually changed it in this wizard run
            if (deadlineTouched && deadlineHours && (!operatingMode || operatingMode === 'renewable_countdown')) {
                try {
                    const dlResponse = await fetch('/api/state/set-deadline', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hours: deadlineHours }),
                    });
                    const dlData = await dlResponse.json();
                    if (dlData.success) {
                        statusDiv.innerHTML += `<div style="color: var(--accent); margin: 0.25rem 0;">‚è∞ Deadline set to ${deadlineHours}h from now</div>`;
                    } else {
                        statusDiv.innerHTML += `<div style="color: var(--warning); margin: 0.25rem 0;">‚ö†Ô∏è Deadline: ${dlData.error || 'could not set (run a tick first)'}</div>`;
                    }
                } catch (e) {
                    console.warn('Could not set deadline:', e);
                    statusDiv.innerHTML += `<div style="color: var(--warning); margin: 0.25rem 0;">‚ö†Ô∏è Could not set deadline ‚Äî run a tick first</div>`;
                }
            }

            // Apply policy preset if selected
            if (policyPreset) {
                try {
                    const policyResp = await fetch('/api/policy/constants', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ preset: policyPreset }),
                    });
                    const policyData = await policyResp.json();
                    if (policyData.success) {
                        statusDiv.innerHTML += `<div style="color: var(--accent); margin: 0.25rem 0;">üìã Applied policy preset: ${policyPreset}</div>`;
                    } else {
                        statusDiv.innerHTML += `<div style="color: var(--warning); margin: 0.25rem 0;">‚ö†Ô∏è Policy preset: ${policyData.error || 'failed'}</div>`;
                    }
                } catch (e) {
                    console.warn('Policy preset failed:', e);
                    statusDiv.innerHTML += `<div style="color: var(--warning); margin: 0.25rem 0;">‚ö†Ô∏è Policy preset failed ‚Äî ${e.message}</div>`;
                }
            }

            // Git sync if requested
            if (gitSyncChecked) {
                statusDiv.innerHTML += '<div style="color: var(--info); margin: 0.5rem 0;">üîÑ Syncing to Git...</div>';
                try {
                    const syncResponse = await fetch('/api/git/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: 'chore: setup wizard configuration sync' }),
                    });
                    const syncData = await syncResponse.json();
                    if (syncData.success) {
                        statusDiv.innerHTML += `<div style="color: var(--accent); margin: 0.25rem 0;">üîÑ ${syncData.message}</div>`;
                    } else {
                        statusDiv.innerHTML += `<div style="color: var(--warning); margin: 0.25rem 0;">‚ö†Ô∏è Git sync: ${syncData.error || 'failed'}</div>`;
                    }
                } catch (e) {
                    console.warn('Git sync failed:', e);
                    statusDiv.innerHTML += `<div style="color: var(--warning); margin: 0.25rem 0;">‚ö†Ô∏è Git sync failed ‚Äî ${e.message}</div>`;
                }
            }

            // Refresh status
            loadStatus();

            // Invalidate secrets tab so it reloads with new values
            secretsLoaded = false;

            // Wizard data has been saved ‚Äî no longer dirty
            wizardDirty = false;
        }

        // Initial load ‚Äî await so envData is ready before tab switch
        (async () => {
            await loadStatus();

            // Restore tab from URL hash (supports wizard/stepId)
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                const tabId = hash.split('/')[0];
                if (document.getElementById(`tab-${tabId}`)) {
                    switchTab(hash);
                }
            }
        })();

        // Handle back/forward
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                const tabId = hash.split('/')[0];
                if (document.getElementById(`tab-${tabId}`)) {
                    switchTab(hash);
                }
            }
        });

        {% include "scripts/modals/_policy.js.html" %}

        {% include "scripts/modals/_audit_log.js.html" %}

        {% include "scripts/modals/_simulator.js.html" %}

