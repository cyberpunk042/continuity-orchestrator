<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ project }}{% endblock %}</title>
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="{{ base_path|default('') }}feed.xml">
    <link rel="stylesheet" href="{{ base_path|default('') }}assets/css/base.css">
    {% block extra_css %}{% endblock %}
    <style>
        {
            % block inline_css %
        }

            {
            % endblock %
        }
    </style>
</head>

<body class="{% block body_class %}{% endblock %}">
    {% block content %}{% endblock %}

    <script>
        const CURRENT_DEADLINE = "{{ deadline }}";
        const CURRENT_STAGE = "{{ stage }}";
        const CURRENT_RELEASE_TRIGGERED = {{ release_triggered|default (false) | lower }};
        const POLL_INTERVAL = 15000;

        // Check if release is triggered (from status.json)
        function isReleaseTriggered() {
            return CURRENT_RELEASE_TRIGGERED;
        }

        async function checkForStateChange() {
            try {
                const response = await fetch("{{ base_path|default('') }}status.json?t=" + Date.now(), { cache: "no-store" });
                if (response.ok) {
                    const status = await response.json();
                    // Reload if anything changed (deadline, stage, or release_triggered)
                    if (status.deadline !== CURRENT_DEADLINE ||
                        status.stage !== CURRENT_STAGE ||
                        status.release_triggered !== CURRENT_RELEASE_TRIGGERED) {
                        location.reload();
                    }
                }
            } catch (e) { }
        }

        setInterval(checkForStateChange, POLL_INTERVAL);
        document.addEventListener("visibilitychange", () => {
            if (!document.hidden) checkForStateChange();
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>