name: Renew Deadline

# Triggered manually with a code to extend the deadline OR trigger release.
# - RENEWAL_SECRET: extends deadline (normal renewal)
# - RELEASE_SECRET: triggers immediate disclosure (shadow mode - cron rebuilds later)

on:
  workflow_dispatch:
    inputs:
      renewal_code:
        description: 'Renewal code (secret)'
        required: true
        type: string
      extend_hours:
        description: 'Hours to extend deadline'
        required: false
        default: '48'
        type: number
      release_delay:
        description: 'Release delay in minutes (0=immediate)'
        required: false
        default: '0'
        type: number
      release_delay_scope:
        description: 'What to delay: full or site_only'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - site_only

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"

jobs:
  validate-and-renew:
    name: Validate Code & Process
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Validate code and determine action
        id: validate
        env:
          RENEWAL_SECRET: ${{ secrets.RENEWAL_SECRET }}
          RELEASE_SECRET: ${{ secrets.RELEASE_SECRET }}
        run: |
          INPUT_CODE="${{ inputs.renewal_code }}"
          
          # Check if it's a release trigger
          if [ -n "$RELEASE_SECRET" ] && [ "$INPUT_CODE" = "$RELEASE_SECRET" ]; then
            echo "⚠️ RELEASE CODE - Triggering disclosure (shadow mode)"
            echo "action=release" >> $GITHUB_OUTPUT
            echo "shadow=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if it's a normal renewal
          if [ -z "$RENEWAL_SECRET" ]; then
            echo "❌ RENEWAL_SECRET not configured"
            exit 1
          fi
          
          if [ "$INPUT_CODE" = "$RENEWAL_SECRET" ]; then
            echo "✅ Renewal code validated"
            echo "action=renew" >> $GITHUB_OUTPUT
            echo "shadow=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "❌ Invalid code"
          exit 1
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Execute renewal
        if: steps.validate.outputs.action == 'renew'
        run: |
          python -m src.main renew --hours ${{ inputs.extend_hours }}
      
      - name: Execute release trigger
        if: steps.validate.outputs.action == 'release'
        id: release
        run: |
          TOKEN=$(python -m src.main trigger-release --stage FULL --delay ${{ inputs.release_delay }} --delay-scope ${{ inputs.release_delay_scope }} --silent)
          echo "client_token=$TOKEN" >> $GITHUB_OUTPUT
      
      - name: Commit state changes
        run: |
          git config user.name "continuity-orchestrator[bot]"
          git config user.email "continuity-orchestrator[bot]@users.noreply.github.com"
          
          TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          git add state/ audit/
          
          if [ "${{ steps.validate.outputs.action }}" = "release" ]; then
            git commit -m "release: Manual trigger at ${TIME}" || true
          else
            git commit -m "renew: Extended by ${{ inputs.extend_hours }}h at ${TIME}" || true
          fi
          
          git push
      
      # Rebuild site for all actions (renewals show OK, releases show DELAYED)
      - name: Build updated site
        env:
          RENEWAL_TRIGGER_TOKEN: ${{ secrets.RENEWAL_TRIGGER_TOKEN }}
          CONTENT_ENCRYPTION_KEY: ${{ secrets.CONTENT_ENCRYPTION_KEY }}
        run: |
          python -m src.main build-site --output public
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public
      
      - name: Cancel stuck Pages deployments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # List recent Pages deployments and cancel any stuck in "in_progress"
          echo "Checking for stuck Pages deployments..."
          DEPLOYMENTS=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/pages/deployments?per_page=5" 2>/dev/null || echo "[]")
          
          echo "$DEPLOYMENTS" | python3 -c "
          import sys, json
          try:
              deps = json.load(sys.stdin)
              if not isinstance(deps, list): deps = []
              stuck = [d for d in deps if d.get('status') == 'in_progress']
              if stuck:
                  print(f'Found {len(stuck)} stuck deployment(s)')
                  for d in stuck:
                      print(f'  → {d.get(\"id\", \"unknown\")} (status: {d.get(\"status\")})')
              else:
                  print('No stuck deployments found')
          except: print('Could not parse deployments')
          " || true
          
          # Cancel any in-progress deployments
          echo "$DEPLOYMENTS" | python3 -c "
          import sys, json, subprocess
          try:
              deps = json.load(sys.stdin)
              if not isinstance(deps, list): deps = []
              for d in deps:
                  if d.get('status') == 'in_progress':
                      dep_id = d.get('id', '')
                      if dep_id:
                          print(f'Cancelling stuck deployment: {dep_id}')
                          subprocess.run([
                              'curl', '-s', '-X', 'POST',
                              '-H', 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}',
                              '-H', 'Accept: application/vnd.github+json',
                              f'https://api.github.com/repos/${{ github.repository }}/pages/deployments/{dep_id}/cancel'
                          ], timeout=15)
          except Exception as e: print(f'Cleanup skipped: {e}')
          " || true
          
          # Brief pause to let GitHub process cancellations
          sleep 3

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          timeout: 600000
          error_count: 3
      
      - name: Summary
        run: |
          if [ "${{ steps.validate.outputs.action }}" = "release" ]; then
            echo "## ⚠️ RELEASE TRIGGERED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Stage: **FULL**" >> $GITHUB_STEP_SUMMARY
            echo "- Triggered at: **$(date -u +%Y-%m-%dT%H:%M:%SZ)**" >> $GITHUB_STEP_SUMMARY
            echo "- Site: **Rebuilt with DELAYED status**" >> $GITHUB_STEP_SUMMARY
            echo "- Integrations: **Cron will execute on next tick**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ✅ Renewal Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Extended deadline by: **${{ inputs.extend_hours }} hours**" >> $GITHUB_STEP_SUMMARY
            echo "- Renewed at: **$(date -u +%Y-%m-%dT%H:%M:%SZ)**" >> $GITHUB_STEP_SUMMARY
            echo "- State reset to: **OK**" >> $GITHUB_STEP_SUMMARY
          fi
