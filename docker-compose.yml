# ============================================================================
# DEPLOYMENT MODES
# ============================================================================
#
# Mode 1: STANDALONE (No Git sync)
#   - State lives only in Docker volumes
#   - Simple, but no backup to repo
#   - Use: docker compose up -d
#
# Mode 2: GIT-SYNCED (Recommended for continuity)
#   - State syncs to/from Git repo
#   - Requires mounting Git repo
#   - Use: docker compose --profile git-sync up -d
#
# Mode 3: OBSERVER ONLY
#   - Reads state from GitHub repo
#   - Doesn't write/commit anything
#   - Use: docker compose --profile observer up -d
#
# ============================================================================

services:
  # ==========================================================================
  # Mode 1: STANDALONE ORCHESTRATOR
  # Runs tick loop with state in Docker volumes only
  # ==========================================================================
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: continuity-orchestrator
    restart: unless-stopped
    environment:
      - STATE_FILE=/data/state/current.json
      - AUDIT_DIR=/data/audit
      - POLICY_DIR=/app/policy
      - ADAPTER_MOCK_MODE=${ADAPTER_MOCK_MODE:-false}
      # Master config (preferred - one secret)
      - CONTINUITY_CONFIG=${CONTINUITY_CONFIG:-}
      # Individual keys (fallback)
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_FROM_NUMBER=${TWILIO_FROM_NUMBER:-}
      - X_API_KEY=${X_API_KEY:-}
      - X_API_SECRET=${X_API_SECRET:-}
      - X_ACCESS_TOKEN=${X_ACCESS_TOKEN:-}
      - X_ACCESS_SECRET=${X_ACCESS_SECRET:-}
      - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID:-}
      - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET:-}
      - REDDIT_USERNAME=${REDDIT_USERNAME:-}
      - REDDIT_PASSWORD=${REDDIT_PASSWORD:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY:-}
    volumes:
      - state-data:/data/state
      - audit-data:/data/audit
      - ./policy:/app/policy:ro
      - ./templates:/app/templates:ro
      - ./content:/app/content:ro
    networks:
      - continuity-net
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo ""
        echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   âš ï¸  CONTINUITY ORCHESTRATOR â€” TEST MODE âš ï¸                    â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   State is stored in Docker volumes ONLY.                       â”‚"
        echo "â”‚   Changes will NOT sync to your Git repository.                 â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   This mode is for:                                             â”‚"
        echo "â”‚   â€¢ Local testing and development                               â”‚"
        echo "â”‚   â€¢ Trying out the system before production                     â”‚"
        echo "â”‚   â€¢ Environments without Git access                             â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   FOR PRODUCTION USE:                                           â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   Option 1: GitHub Actions (Recommended)                        â”‚"
        echo "â”‚     â†’ Push to GitHub, enable Actions workflow                   â”‚"
        echo "â”‚     â†’ State auto-commits to your repo                           â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   Option 2: Docker with Git Sync                                â”‚"
        echo "â”‚     â†’ docker compose --profile git-sync up -d                   â”‚"
        echo "â”‚     â†’ Requires GITHUB_TOKEN in .env                             â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   TO DISCARD TEST DATA:                                         â”‚"
        echo "â”‚     docker compose down -v                                      â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   TO EXPORT STATE BEFORE DISCARDING:                            â”‚"
        echo "â”‚     docker cp continuity-orchestrator:/data/state ./state-backupâ”‚"
        echo "â”‚                                                                 â”‚"
        echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
        echo ""
        
        # Initialize state if not exists
        if [ ! -f /data/state/current.json ]; then
          echo "ğŸ“¦ Initializing test state..."
          mkdir -p /data/state /data/audit /data/public
          python3 /app/scripts/docker_init.py /data/state/current.json
          echo '{}' > /data/audit/ledger.ndjson
        fi
        
        echo ""
        echo "ğŸ§ª Starting test tick loop (every 15 minutes)..."
        echo ""
        
        # Run tick every 15 minutes
        while true; do
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”„ TEST TICK at $$(date -Iseconds)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          python -m src.main tick \
            --state-file /data/state/current.json \
            --policy-dir /app/policy \
            --audit-file /data/audit/ledger.ndjson \
            || echo "Tick failed, will retry..."
          
          # Build site after tick
          python -m src.main build-site --output /data/public || true
          
          echo ""
          echo "ğŸ’¤ Sleeping 15 minutes... (Ctrl+C to stop)"
          echo "   âš ï¸  Remember: Changes are NOT persisted to Git!"
          echo ""
          sleep 900
        done

  # ==========================================================================
  # Mode 2: GIT-SYNCED ORCHESTRATOR
  # Runs tick loop and commits state back to Git
  # ==========================================================================
  orchestrator-git-sync:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: continuity-git-sync
    restart: unless-stopped
    profiles:
      - git-sync
    environment:
      - STATE_FILE=/repo/state/current.json
      - AUDIT_DIR=/repo/audit
      - POLICY_DIR=/repo/policy
      - ADAPTER_MOCK_MODE=${ADAPTER_MOCK_MODE:-false}
      - CONTINUITY_CONFIG=${CONTINUITY_CONFIG:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GIT_AUTHOR_NAME=Continuity Orchestrator
      - GIT_AUTHOR_EMAIL=continuity@automated.bot
    volumes:
      # Mount the ENTIRE repo, not just state
      - .:/repo
      # Shared volume for built site
      - public-data:/public
    user: root
    networks:
      - continuity-net
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  Continuity Orchestrator â€” GIT SYNC MODE   â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        cd /repo
        
        # Configure git for root user
        git config --global --add safe.directory /repo
        git config user.name "Continuity Orchestrator"
        git config user.email "continuity@automated.bot"
        
        # Configure git credentials for HTTPS push using GITHUB_TOKEN (once)
        if [ -n "$$GITHUB_TOKEN" ] && [ -z "$$GIT_CONFIGURED" ]; then
          echo "Configuring git credentials..."
          # Get current origin
          ORIGIN=$$(git remote get-url origin 2>/dev/null || echo "")
          # Only reconfigure if not already token-based
          if echo "$$ORIGIN" | grep -q "git@github.com"; then
            # Convert SSH to HTTPS with token
            REPO=$$(echo "$$ORIGIN" | sed 's/git@github.com://' | sed 's/.git$$//')
            git remote set-url origin "https://x-access-token:$$GITHUB_TOKEN@github.com/$$REPO.git"
            echo "Converted SSH to HTTPS with token"
          elif echo "$$ORIGIN" | grep -q "https://github.com" && ! echo "$$ORIGIN" | grep -q "x-access-token"; then
            # Add token to plain HTTPS
            REPO=$$(echo "$$ORIGIN" | sed 's#https://github.com/##' | sed 's/.git$$//')
            git remote set-url origin "https://x-access-token:$$GITHUB_TOKEN@github.com/$$REPO.git"
            echo "Added token to HTTPS"
          fi
          export GIT_CONFIGURED=1
        fi
        
        # Clear and prepare shared volume for nginx
        rm -rf /public/* 2>/dev/null || true
        
        while true; do
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Running tick at $$(date -Iseconds)"
          
          # Pull latest state (in case Actions ran) - reset URL first
          git pull --rebase origin main || true
          
          # Run tick
          python -m src.main tick
          
          # Build site to shared volume (for nginx)
          python -m src.main build-site --output /public || true
          
          # Commit and push if changed
          if git diff --quiet state/ audit/; then
            echo "No state changes"
          else
            echo "Committing state changes..."
            git add state/ audit/ public/
            git commit -m "chore(state): tick at $$(date -Iseconds)" || true
            git push origin main || echo "Push failed, will retry next tick"
          fi
          
          echo "Sleeping 15 minutes..."
          sleep 900
        done

  # ==========================================================================
  # NGINX â€” Static Site Server
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: continuity-nginx
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      # Use shared volume that git-sync builds to
      - public-data:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - continuity-net

  # ==========================================================================
  # SITE BUILDER â€” One-shot build (for CI/tools)
  # ==========================================================================
  site-builder:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: continuity-site-builder
    volumes:
      - state-data:/data/state:ro
      - public-data:/data/public
      - ./content:/app/content:ro
    command: ["python", "-m", "src.main", "build-site", "--output", "/data/public"]
    profiles:
      - tools

  # ==========================================================================
  # HEALTH CHECK â€” Run health check once
  # ==========================================================================
  health-check:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: continuity-health
    volumes:
      - state-data:/data/state:ro
      - audit-data:/data/audit:ro
    command: ["python", "-m", "src.main", "health", "--json"]
    profiles:
      - tools

volumes:
  state-data:
    name: continuity-state
  audit-data:
    name: continuity-audit
  public-data:
    name: continuity-public

networks:
  continuity-net:
    name: continuity-network
