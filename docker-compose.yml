# ============================================================================
# DEPLOYMENT MODES
# ============================================================================
#
# Mode 1: STANDALONE (No Git sync)
#   - State lives only in Docker volumes
#   - Simple, but no backup to repo
#   - Use: docker compose up -d
#
# Mode 2: GIT-SYNCED (Recommended for continuity)
#   - State syncs to/from Git repo
#   - Requires mounting Git repo
#   - Use: docker compose --profile git-sync up -d
#
# Mode 3: OBSERVER ONLY
#   - Reads state from GitHub repo
#   - Doesn't write/commit anything
#   - Use: docker compose --profile observer up -d
#
# ADD-ON: CLOUDFLARE TUNNEL (composable with any mode)
#   - Exposes nginx via Cloudflare Tunnel (no port-forwarding needed)
#   - Requires CLOUDFLARE_TUNNEL_TOKEN in .env
#   - Add: --profile tunnel  (e.g. --profile git-sync --profile tunnel)
#
# ============================================================================

services:
  # ==========================================================================
  # VOLUME INIT â€” Set correct permissions on shared volumes
  # ==========================================================================
  volume-init:
    image: alpine:latest
    container_name: continuity-volume-init
    volumes:
      - state-data:/data/state
      - audit-data:/data/audit
      - public-data:/data/public
      - git-repo-data:/repo
    command: >
      sh -c "
        mkdir -p /data/state /data/audit /data/public /repo &&
        chmod -R 777 /data/state /data/audit /data/public /repo &&
        rm -rf /data/public/* 2>/dev/null || true
      "
    networks:
      - continuity-net

  # ==========================================================================
  # Mode 1: STANDALONE ORCHESTRATOR
  # Runs tick loop with state in Docker volumes only
  # ==========================================================================
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: continuity-orchestrator
    restart: unless-stopped
    depends_on:
      volume-init:
        condition: service_completed_successfully
    environment:
      - STATE_FILE=/data/state/current.json
      - AUDIT_DIR=/data/audit
      - POLICY_DIR=/app/policy
      # Project settings
      - PROJECT_NAME=${PROJECT_NAME:-}
      - OPERATOR_EMAIL=${OPERATOR_EMAIL:-}
      - ADAPTER_MOCK_MODE=${ADAPTER_MOCK_MODE:-false}
      # Master config (preferred - one secret)
      - CONTINUITY_CONFIG=${CONTINUITY_CONFIG:-}
      # Email (Resend)
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL:-}
      # SMS (Twilio)
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_FROM_NUMBER=${TWILIO_FROM_NUMBER:-}
      - OPERATOR_SMS=${OPERATOR_SMS:-}
      # GitHub
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY:-}
      # X/Twitter
      - X_API_KEY=${X_API_KEY:-}
      - X_API_SECRET=${X_API_SECRET:-}
      - X_ACCESS_TOKEN=${X_ACCESS_TOKEN:-}
      - X_ACCESS_SECRET=${X_ACCESS_SECRET:-}
      # Reddit
      - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID:-}
      - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET:-}
      - REDDIT_USERNAME=${REDDIT_USERNAME:-}
      - REDDIT_PASSWORD=${REDDIT_PASSWORD:-}
      # Webhooks
      - WEBHOOK_TIMEOUT=${WEBHOOK_TIMEOUT:-30}
      # Persistence API
      - PERSISTENCE_API_URL=${PERSISTENCE_API_URL:-}
      - PERSISTENCE_API_KEY=${PERSISTENCE_API_KEY:-}
      - PERSISTENCE_API_TIMEOUT=${PERSISTENCE_API_TIMEOUT:-30}
      # Manual controls (renewal/release)
      - RENEWAL_SECRET=${RENEWAL_SECRET:-}
      - RELEASE_SECRET=${RELEASE_SECRET:-}
      - RELEASE_DELAY_MINUTES=${RELEASE_DELAY_MINUTES:-60}
      - RELEASE_DELAY_SCOPE=${RELEASE_DELAY_SCOPE:-partial}
      - RENEWAL_TRIGGER_TOKEN=${RENEWAL_TRIGGER_TOKEN:-}
    volumes:
      # Use local state/audit from repo for testing with real data
      - ./state:/data/state
      - ./audit:/data/audit
      - public-data:/data/public
      - ./policy:/app/policy:ro
      - ./templates:/app/templates:ro
      - ./content:/app/content:ro
    networks:
      - continuity-net
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo ""
        echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   âš ï¸  CONTINUITY ORCHESTRATOR â€” TEST MODE âš ï¸                    â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   State is stored in Docker volumes ONLY.                       â”‚"
        echo "â”‚   Changes will NOT sync to your Git repository.                 â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   This mode is for:                                             â”‚"
        echo "â”‚   â€¢ Local testing and development                               â”‚"
        echo "â”‚   â€¢ Trying out the system before production                     â”‚"
        echo "â”‚   â€¢ Environments without Git access                             â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   FOR PRODUCTION USE:                                           â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   Option 1: GitHub Actions (Recommended)                        â”‚"
        echo "â”‚     â†’ Push to GitHub, enable Actions workflow                   â”‚"
        echo "â”‚     â†’ State auto-commits to your repo                           â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   Option 2: Docker with Git Sync                                â”‚"
        echo "â”‚     â†’ docker compose --profile git-sync up -d                   â”‚"
        echo "â”‚     â†’ Requires GITHUB_TOKEN in .env                             â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   TO DISCARD TEST DATA:                                         â”‚"
        echo "â”‚     docker compose down -v                                      â”‚"
        echo "â”‚                                                                 â”‚"
        echo "â”‚   TO EXPORT STATE BEFORE DISCARDING:                            â”‚"
        echo "â”‚     docker cp continuity-orchestrator:/data/state ./state-backupâ”‚"
        echo "â”‚                                                                 â”‚"
        echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
        echo ""
        
        # Create symlinks so build-site finds state/audit at expected paths
        ln -sf /data/state /app/state
        ln -sf /data/audit /app/audit
        
        # Clear any nginx default files from the shared volume
        rm -rf /data/public/* 2>/dev/null || true
        
        # Initialize state if not exists
        if [ ! -f /data/state/current.json ]; then
          echo "ðŸ“¦ Initializing test state..."
          mkdir -p /data/state /data/audit /data/public
          python3 /app/scripts/docker_init.py /data/state/current.json
          echo '{}' > /data/audit/ledger.ndjson
        fi
        
        echo ""
        echo "ðŸ§ª Starting test tick loop (every 15 minutes)..."
        echo ""
        
        # Run tick every 15 minutes
        while true; do
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”„ TEST TICK at $$(date -Iseconds)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          python -m src.main tick \
            --state-file /data/state/current.json \
            --policy-dir /app/policy \
            --audit-file /data/audit/ledger.ndjson \
            || echo "Tick failed, will retry..."
          
          # Build site after tick (--no-clean avoids permission issues)
          python -m src.main build-site --output /data/public --no-clean || true
          
          echo ""
          echo "ðŸ’¤ Sleeping 15 minutes... (Ctrl+C to stop)"
          echo "   âš ï¸  Remember: Changes are NOT persisted to Git!"
          echo ""
          sleep 900
        done

  # ==========================================================================
  # Mode 2: GIT-SYNCED ORCHESTRATOR
  # Runs tick loop and commits state back to Git
  # ==========================================================================
  orchestrator-git-sync:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: continuity-git-sync
    restart: unless-stopped
    profiles:
      - git-sync
    depends_on:
      volume-init:
        condition: service_completed_successfully
    environment:
      - STATE_FILE=/repo/state/current.json
      - AUDIT_DIR=/repo/audit
      - POLICY_DIR=/repo/policy
      # Project settings
      - PROJECT_NAME=${PROJECT_NAME:-}
      - OPERATOR_EMAIL=${OPERATOR_EMAIL:-}
      - ADAPTER_MOCK_MODE=${ADAPTER_MOCK_MODE:-false}
      # Master config (preferred - one secret)
      - CONTINUITY_CONFIG=${CONTINUITY_CONFIG:-}
      # Email (Resend)
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL:-}
      # SMS (Twilio)
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_FROM_NUMBER=${TWILIO_FROM_NUMBER:-}
      - OPERATOR_SMS=${OPERATOR_SMS:-}
      # GitHub
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY:-}
      - GIT_AUTHOR_NAME=Continuity Orchestrator
      - GIT_AUTHOR_EMAIL=continuity@automated.bot
      # X/Twitter
      - X_API_KEY=${X_API_KEY:-}
      - X_API_SECRET=${X_API_SECRET:-}
      - X_ACCESS_TOKEN=${X_ACCESS_TOKEN:-}
      - X_ACCESS_SECRET=${X_ACCESS_SECRET:-}
      # Reddit
      - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID:-}
      - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET:-}
      - REDDIT_USERNAME=${REDDIT_USERNAME:-}
      - REDDIT_PASSWORD=${REDDIT_PASSWORD:-}
      # Webhooks
      - WEBHOOK_TIMEOUT=${WEBHOOK_TIMEOUT:-30}
      # Persistence API
      - PERSISTENCE_API_URL=${PERSISTENCE_API_URL:-}
      - PERSISTENCE_API_KEY=${PERSISTENCE_API_KEY:-}
      - PERSISTENCE_API_TIMEOUT=${PERSISTENCE_API_TIMEOUT:-30}
      # Manual controls (renewal/release)
      - RENEWAL_SECRET=${RENEWAL_SECRET:-}
      - RELEASE_SECRET=${RELEASE_SECRET:-}
      - RELEASE_DELAY_MINUTES=${RELEASE_DELAY_MINUTES:-60}
      - RELEASE_DELAY_SCOPE=${RELEASE_DELAY_SCOPE:-partial}
      - RENEWAL_TRIGGER_TOKEN=${RENEWAL_TRIGGER_TOKEN:-}
      # Git sync settings
      # DOCKER_GIT_SYNC_ALPHA: false = remote is the source of truth (default)
      #                        true  = this Docker instance is dominant, force-pushes on divergence
      - DOCKER_GIT_SYNC_ALPHA=${DOCKER_GIT_SYNC_ALPHA:-false}
      - DOCKER_GIT_SYNC_TICK_INTERVAL=${DOCKER_GIT_SYNC_TICK_INTERVAL:-900}
      - DOCKER_GIT_SYNC_SYNC_INTERVAL=${DOCKER_GIT_SYNC_SYNC_INTERVAL:-30}
    volumes:
      # NO HOST MOUNT - repo is cloned inside container
      # State persists in named volumes between restarts
      - git-repo-data:/repo
      - public-data:/public
    networks:
      - continuity-net
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # Clone repo if not already present
        if [ ! -d /repo/.git ]; then
          echo "Cloning repository..."
          if [ -z "$$GITHUB_TOKEN" ] || [ -z "$$GITHUB_REPOSITORY" ]; then
            echo "ERROR: GITHUB_TOKEN and GITHUB_REPOSITORY must be set"
            exit 1
          fi
          git clone "https://x-access-token:$$GITHUB_TOKEN@github.com/$$GITHUB_REPOSITORY.git" /repo
        fi

        cd /repo

        # Configure git
        git config --global --add safe.directory /repo
        git config user.name "$$GIT_AUTHOR_NAME"
        git config user.email "$$GIT_AUTHOR_EMAIL"

        # Ensure remote has token for push
        git remote set-url origin "https://x-access-token:$$GITHUB_TOKEN@github.com/$$GITHUB_REPOSITORY.git"

        # Clear shared volume for nginx
        rm -rf /public/* 2>/dev/null || true

        # Hand off to Python sync manager
        # Handles: initial sync, background fetch loop, tick loop,
        #          divergence detection, alpha/non-alpha mode
        python /app/scripts/docker_git_sync.py \
          --repo /repo \
          --branch main \
          --public-dir /public \
          --tick-interval $${DOCKER_GIT_SYNC_TICK_INTERVAL:-900} \
          --sync-interval $${DOCKER_GIT_SYNC_SYNC_INTERVAL:-30}

  # ==========================================================================
  # NGINX â€” Static Site Server
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: continuity-nginx
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      # Use shared volume that git-sync builds to
      - public-data:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - continuity-net

  # ==========================================================================
  # SITE BUILDER â€” One-shot build (for CI/tools)
  # ==========================================================================
  site-builder:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: continuity-site-builder
    volumes:
      - state-data:/data/state:ro
      - public-data:/data/public
      - ./content:/app/content:ro
    command: ["python", "-m", "src.main", "build-site", "--output", "/data/public"]
    profiles:
      - tools

  # ==========================================================================
  # HEALTH CHECK â€” Run health check once
  # ==========================================================================
  health-check:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: continuity-health
    volumes:
      - state-data:/data/state:ro
      - audit-data:/data/audit:ro
    command: ["python", "-m", "src.main", "health", "--json"]
    profiles:
      - tools

  # ==========================================================================
  # CLOUDFLARE TUNNEL â€” Expose site via Cloudflare (optional add-on)
  # Usage: docker compose --profile git-sync --profile tunnel up -d
  # ==========================================================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: continuity-tunnel
    restart: unless-stopped
    profiles:
      - tunnel
    depends_on:
      - nginx
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
    networks:
      - continuity-net

volumes:
  state-data:
    name: continuity-state
  audit-data:
    name: continuity-audit
  public-data:
    name: continuity-public
  git-repo-data:
    name: continuity-git-repo

networks:
  continuity-net:
    name: continuity-network
